---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/Output/run_spbun_podes_susenas.log
  log type:  text
 opened on:  12 Feb 2026, 17:57:21

. 
. /****************************************************************************************
> B. PACKAGES
> ****************************************************************************************/
. cap which reghdfe

. if _rc ssc install reghdfe, replace

. cap which ftools

. if _rc ssc install ftools, replace

. cap which geodist

. if _rc ssc install geodist, replace

. cap which gtools

. if _rc ssc install gtools, replace

. 
. /****************************************************************************************
> C. HELPERS
> ****************************************************************************************/
. capture program drop _std_iddesa10

. program define _std_iddesa10
  1.     syntax varname
  2.     capture confirm numeric variable `varlist'
  3.     if !_rc tostring `varlist', replace format("%010.0f")
  4.     replace `varlist' = trim(`varlist')
  5.     replace `varlist' = subinstr(`varlist'," ","",.)
  6.     replace `varlist' = subinstr(`varlist',".","",.)
  7.     replace `varlist' = subinstr(`varlist',",","",.)
  8.     replace `varlist' = substr("0000000000"+`varlist', strlen("0000000000"+`varlist')-9, 10)
  9.     assert strlen(`varlist')==10
 10. end

. 
. /****************************************************************************************
> D. BUILD "$outdir/podes_vill.dta"  (MAIN + PESISIR + coords fallback)
> ****************************************************************************************/
. tempfile MAIN PES kelcoords

. 
. * D1) MAIN
. use "$podes_main", clear

. 
. cap confirm variable IDDESA

. if _rc {
.     cap confirm variable iddesa
.     if !_rc rename iddesa IDDESA
.     cap confirm variable IdDesa
.     if !_rc rename IdDesa IDDESA
.     cap confirm variable Iddesa
.     if !_rc rename Iddesa IDDESA
. }

. cap confirm variable IDDESA

. if _rc {
.     di as err "MAIN: cannot find village id variable (IDDESA/iddesa)."
.     describe, short
.     exit 111
. }

. 
. cap confirm numeric variable IDDESA

. if !_rc tostring IDDESA, replace format("%010.0f")

. 
. replace IDDESA = trim(IDDESA)
(0 real changes made)

. replace IDDESA = subinstr(IDDESA," ","",.)
(0 real changes made)

. replace IDDESA = subinstr(IDDESA,".","",.)
(0 real changes made)

. replace IDDESA = subinstr(IDDESA,",","",.)
(0 real changes made)

. replace IDDESA = substr("0000000000"+IDDESA, strlen("0000000000"+IDDESA)-9, 10)
(0 real changes made)

. assert strlen(IDDESA)==10

. 
. rename *, lower

. cap confirm variable iddesa

. if _rc rename iddesa iddesa

. rename iddesa iddesa
  (all newnames==oldnames)

. _std_iddesa10 iddesa
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. duplicates drop iddesa, force

Duplicates in terms of iddesa

(0 observations are duplicates)

. save `MAIN', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * D2) PESISIR (prefix p_)
. use "$podes_pesisir", clear

. rename *, lower

. 
. cap confirm variable iddesa

. if _rc {
.     di as err "PESISIR: iddesa not found."
.     describe, short
.     exit 111
. }

. _std_iddesa10 iddesa
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. keep iddesa r307b_lat r307b_long ///
>      r308* r309* r310 ///
>      r402* r403* ///
>      r501* r502* r503* ///
>      r508* r509*

. 
. duplicates drop iddesa, force

Duplicates in terms of iddesa

(0 observations are duplicates)

. 
. ds iddesa, not
r307b_lat   r308b1a     r308b1d     r308b3      r309c       r310        r402b2      r402d2a     r402e2a     r403b1      r403c2      r501b       r502b       r503a2      r503a5      r503a8      r503a11     r508a       r509b       r509c3
r307b_long  r308b1b     r308b1e     r309a       r309d       r402a       r402c       r402d2b     r402e2b     r403b2      r501a1      r501c       r502c       r503a3      r503a6      r503a9      r503b       r508b       r509c1
r308a       r308b1c     r308b2      r309b       r309e       r402b1      r402d1      r402e1      r403a       r403c1      r501a2      r502a       r503a1      r503a4      r503a7      r503a10     r503c       r509a       r509c2

. local pesvars `r(varlist)'

. foreach v of local pesvars {
  2.     rename `v' p_`v'
  3. }

. save `PES', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * D3) MERGE MAIN + PESISIR; fill missing from p_*
. use `MAIN', clear

. merge 1:1 iddesa using `PES', nogen keep(master match)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            84,276  
    -----------------------------------------

. 
. capture ds p_*

. if !_rc {
.     local plist `r(varlist)'
.     foreach pv of local plist {
  2.         local tv = substr("`pv'",3,.)
  3.         capture confirm variable `tv'
  4.         if _rc {
  5.             rename `pv' `tv'
  6.         }
  7.         else {
  8.             capture confirm numeric variable `tv'
  9.             if !_rc {
 10.                 replace `tv' = `pv' if missing(`tv') & !missing(`pv')
 11.             }
 12.             else {
 13.                 capture confirm string variable `tv'
 14.                 if !_rc {
 15.                     replace `tv' = `pv' if (`tv'=="") & (`pv'!="")
 16.                 }
 17.             }
 18.             drop `pv'
 19.         }
 20.     }
. }

. 
. * admin codes from iddesa
. capture drop r101 r102 r103 r104

. gen int r101 = real(substr(iddesa,1,2))

. gen int r102 = real(substr(iddesa,3,2))

. gen int r103 = real(substr(iddesa,5,3))

. gen int r104 = real(substr(iddesa,8,3))

. 
. capture drop kab

. egen long kab = group(r101 r102), label

. 
. * coords prefer r307b_lat/long
. cap confirm variable lat_v

. if _rc gen double lat_v = .
(84,276 missing values generated)

. cap confirm variable lon_v

. if _rc gen double lon_v = .
(84,276 missing values generated)

. 
. cap confirm variable r307b_lat

. if !_rc {
.     cap confirm numeric variable r307b_lat
.     if _rc destring r307b_lat, replace ignore(",")
.     replace lat_v = r307b_lat if missing(lat_v) & !missing(r307b_lat)
(84,276 real changes made)
. }

. cap confirm variable r307b_long

. if !_rc {
.     cap confirm numeric variable r307b_long
.     if _rc destring r307b_long, replace ignore(",")
.     replace lon_v = r307b_long if missing(lon_v) & !missing(r307b_long)
(84,276 real changes made)
. }

. capture drop r307b_lat r307b_long

. 
. * fallback coords from kel_latlon if still missing
. count if missing(lat_v) | missing(lon_v)
  0

. if r(N) > 0 {
.     di as txt "Coords missing for " r(N) " villages -> fallback merge from kel_latlon..."
.     preserve
.         import delimited "$kel_latlon", clear varnames(1) case(preserve) stringcols(_all)
. 
.         local idv ""
.         local latc ""
.         local lonc ""
.         foreach v of varlist _all {
  2.             if "`idv'"==""  & strpos(lower("`v'"),"iddesa") local idv `v'
  3.             if "`latc'"=="" & strpos(lower("`v'"),"lat")    local latc `v'
  4.             if "`lonc'"=="" & (strpos(lower("`v'"),"lon") | strpos(lower("`v'"),"long")) local lonc `v'
  5.         }
. 
.         if "`idv'"!="" & "`latc'"!="" & "`lonc'"!="" {
.             rename `idv' iddesa
.             rename `latc' lat_v2
.             rename `lonc' lon_v2
.             _std_iddesa10 iddesa
.             destring lat_v2 lon_v2, replace ignore(",")
.             keep iddesa lat_v2 lon_v2
.             duplicates drop iddesa, force
.             save `kelcoords', replace
.         }
.     restore
. 
.     capture confirm file "`kelcoords'"
.     if !_rc {
.         merge 1:1 iddesa using `kelcoords', nogen keep(master match)
.         replace lat_v = lat_v2 if missing(lat_v) & !missing(lat_v2)
.         replace lon_v = lon_v2 if missing(lon_v) & !missing(lon_v2)
.         drop lat_v2 lon_v2
.     }
. }

. 
. save "$outdir/podes_vill.dta", replace
file /Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/Output/podes_vill.dta saved

. di as result "Saved: $outdir/podes_vill.dta"
Saved: /Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/Output/podes_vill.dta

. 
. /****************************************************************************************
> E. BUILD SPBUN SITE DATASET FROM CSV (coords + volumes + quota + rr)
> ****************************************************************************************/
. tempfile spbun_site

. import delimited "$spbun_csv", clear varnames(1) case(preserve) stringcols(_all)
(encoding automatically selected: UTF-8)
(113 vars, 377 obs)

. 
. capture confirm variable TitikKoordinat

. if _rc {
.     di as err "Cannot find TitikKoordinat in SPBUN CSV."
.     describe
.     exit 198
. }

. rename TitikKoordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(83 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(8 real changes made)

. 
. gen strL coord = titik_koordinat
(8 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(8 missing values generated)

. gen double lon_s = real(_c2)
(10 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(8 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(10 observations deleted)

. 
. * quota vars (auto-detect)
. local qjbt ""

. local qjbkp ""

. foreach v of varlist _all {
  2.     if "`qjbt'"==""  & strpos(lower("`v'"),"kuota") & strpos(lower("`v'"),"jbt")  local qjbt  `v'
  3.     if "`qjbkp'"=="" & strpos(lower("`v'"),"kuota") & strpos(lower("`v'"),"jbkp") local qjbkp `v'
  4. }

. if "`qjbt'"!=""  rename `qjbt'  kuota_jbt

. if "`qjbkp'"!="" rename `qjbkp' kuota_jbkp

. capture destring kuota_jbt kuota_jbkp, replace ignore(",")

. 
. * volume (robust): destring likely volume cols, then rowtotal
. capture ds Total* *total* *realisasi* *volume*, has(type string)

. if !_rc {
.     foreach v of varlist `r(varlist)' {
  2.         capture destring `v', replace ignore(",")
  3.     }
. }

. 
. local volvars ""

. capture ds Total* *total* *realisasi* *volume*, has(type numeric)

. if !_rc local volvars "`r(varlist)'"

. 
. capture drop vol_s

. if "`volvars'"!="" {
.     egen double vol_s = rowtotal(`volvars'), missing
. }

. else {
.     gen double vol_s = .
(367 missing values generated)
. }

. 
. gen double quota_s = .
(367 missing values generated)

. capture confirm variable kuota_jbt

. if !_rc replace quota_s = kuota_jbt

. capture confirm variable kuota_jbkp

. if !_rc replace quota_s = cond(missing(quota_s), kuota_jbkp, quota_s + kuota_jbkp)

. 
. gen double rr_s = .
(367 missing values generated)

. replace rr_s = vol_s / quota_s if quota_s>0 & !missing(vol_s)
(0 real changes made)

. 
. gen double w1   = 1

. gen double wvol = vol_s
(367 missing values generated)

. gen double wrr  = rr_s
(367 missing values generated)

. 
. gen long site_id = _n

. keep site_id lat_s lon_s vol_s quota_s rr_s w1 wvol wrr

. save `spbun_site', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 saved as .dta format

. 
. /****************************************************************************************
> F. ASSIGN EACH SPBUN SITE TO NEAREST VILLAGE (get r101/r102, kab)
> ****************************************************************************************/
. tempfile spbun_site_coded villcoords site_bins site2kab

. local binsz = 0.10

. 
. use `spbun_site', clear

. 
. preserve

.     use "$outdir/podes_vill.dta", clear

.     keep iddesa kab r101 r102 lat_v lon_v

.     drop if missing(lat_v) | missing(lon_v)
(0 observations deleted)

.     save `villcoords', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000006 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000006 saved as .dta format

. restore

. 
. drop if missing(lat_s) | missing(lon_s)
(0 observations deleted)

. 
. gen int latbin = floor(lat_s/`binsz')

. gen int lonbin = floor(lon_s/`binsz')

. 
. expand 9
(2,936 observations created)

. bys site_id: gen byte _g = _n - 1

. gen int dlat = floor(_g/3) - 1

. gen int dlon = mod(_g,3) - 1

. gen int latbin2 = latbin + dlat
(9 missing values generated)

. gen int lonbin2 = lonbin + dlon
(9 missing values generated)

. drop _g dlat dlon

. 
. save `site_bins', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 saved as .dta format

. 
. use `villcoords', clear

. gen int latbin2 = floor(lat_v/`binsz')

. gen int lonbin2 = floor(lon_v/`binsz')

. 
. joinby latbin2 lonbin2 using `site_bins'

. geodist lat_v lon_v lat_s lon_s, gen(dkm)

. bys site_id (dkm): keep if _n==1
(30,588 observations deleted)

. 
. keep site_id r101 r102 kab

. save `site2kab', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. 
. use `spbun_site', clear

. merge 1:1 site_id using `site2kab', nogen keep(master match)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             2
        from master                         2  
        from using                          0  

    Matched                               365  
    -----------------------------------------

. save `spbun_site_coded', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000005 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000005 saved as .dta format

. 
. // /****************************************************************************************
. // G. VILLAGE-LEVEL EXPOSURE MEASURES
. // ****************************************************************************************/
. // tempfile vill_core vill_bins site_bins2 vill_exposure
. //
. // use "$outdir/podes_vill.dta", clear
. // keep iddesa kab r101 r102 lat_v lon_v
. // save `vill_core', replace
. //
. // use `vill_core', clear
. // drop if missing(lat_v) | missing(lon_v)
. // gen int latbin = floor(lat_v/`binsz')
. // gen int lonbin = floor(lon_v/`binsz')
. // save `vill_bins', replace
. //
. // use `spbun_site_coded', clear
. // keep site_id lat_s lon_s w1 wvol wrr vol_s rr_s r101 r102 kab
. // drop if missing(lat_s) | missing(lon_s)
. // gen int latbin = floor(lat_s/`binsz')
. // gen int lonbin = floor(lon_s/`binsz')
. //
. // expand 9
. // bys site_id: gen byte _g = _n - 1
. // gen int dlat = floor(_g/3) - 1
. // gen int dlon = mod(_g,3) - 1
. // gen int latbin2 = latbin + dlat
. // gen int lonbin2 = lonbin + dlon
. // drop _g dlat dlon latbin lonbin
. // rename latbin2 latbin
. // rename lonbin2 lonbin
. // save `site_bins2', replace
. //
. // use `vill_bins', clear
. // joinby latbin lonbin using `site_bins2'
. // geodist lat_v lon_v lat_s lon_s, gen(dkm)
. //
. // bys iddesa: egen double D_v = min(dkm)
. // gen double A_v_log = -ln(1 + D_v)
. // gen double A_v_inv = 1/(1 + D_v)
. //
. // foreach R in 5 10 15 {
. //     gen byte in`R' = (dkm<=`R')
. //     bys iddesa: egen double C`R'_w1   = total(cond(in`R', w1,   0))
. //     bys iddesa: egen double C`R'_wvol = total(cond(in`R', wvol, 0))
. //     bys iddesa: egen double C`R'_wrr  = total(cond(in`R', wrr,  0))
. // }
. // foreach h in 5 10 20 {
. //     bys iddesa: egen double Ker`h'_w1   = total(w1  *exp(-dkm/`h'))
. //     bys iddesa: egen double Ker`h'_wvol = total(wvol*exp(-dkm/`h'))
. //     bys iddesa: egen double Ker`h'_wrr  = total(wrr *exp(-dkm/`h'))
. // }
. //
. // bys iddesa: keep if _n==1
. // keep iddesa D_v A_v_log A_v_inv C*_w1 C*_wvol C*_wrr Ker*_w1 Ker*_wvol Ker*_wrr
. // save `vill_exposure', replace
. //
. // * merge exposures back; fill 0 for count/kernel; cap missing distance to max+1 (so untreated not dropped)
. // use `vill_core', clear
. // merge 1:1 iddesa using `vill_exposure', nogen keep(master match)
. //
. // quietly summarize D_v if !missing(D_v)
. // local Dmax = r(max)
. //
. // foreach v of varlist C*_w1 C*_wvol C*_wrr Ker*_w1 Ker*_wvol Ker*_wrr {
. //     replace `v' = 0 if missing(`v') & !missing(lat_v) & !missing(lon_v)
. // }
. //
. // replace D_v = `Dmax' + 1 if missing(D_v) & !missing(lat_v) & !missing(lon_v) & `Dmax'<.
. // replace A_v_log = -ln(1 + D_v) if missing(A_v_log) & !missing(D_v)
. // replace A_v_inv = 1/(1 + D_v)  if missing(A_v_inv) & !missing(D_v)
. //
. // save `vill_exposure', replace
. //
. // /****************************************************************************************
. // H. PODES: OUTCOMES (PCA) + BASELINE MODELS
. // ****************************************************************************************/
. // use "$outdir/podes_vill.dta", clear
. // merge 1:1 iddesa using `vill_exposure', nogen keep(master match)
. //
. // cap confirm numeric variable r308a
. // if !_rc gen byte Coast = (r308a==1) if !missing(r308a)
. // else gen byte Coast = .
. //
. // cap confirm numeric variable r308b1a
. // cap confirm numeric variable r308b1b
. // gen byte Fish_strict = .
. // replace Fish_strict = (Coast==1) & (r308b1a==1 | r308b1b==1) if !missing(Coast)
. //
. // gen byte Fish_loose = .
. // cap confirm numeric variable r308b1c
. // cap confirm numeric variable r308b1d
. // cap confirm numeric variable r308b1e
. // replace Fish_loose = (Coast==1) | (r308b1a==1 | r308b1b==1 | r308b1c==1 | r308b1d==1 | r308b1e==1) if !missing(Coast)
. //
. // cap confirm variable r710
. // if !_rc {
. //     cap destring r710, replace ignore(",")
. //     gen double lnpov = ln(1 + r710)
. // }
. //
. // local Wbasic ""
. // capture ds r501* r502* r503*, has(type numeric)
. // if !_rc local Wbasic "`r(varlist)'"
. // if "`Wbasic'"!="" {
. //     cap noisily pca `Wbasic', components(1) correlation
. //     if !_rc {
. //         cap drop Wbasic_pca1 Wbasic_z
. //         predict double Wbasic_pca1 if e(sample), score
. //         egen double Wbasic_z = std(Wbasic_pca1)
. //     }
. // }
. //
. // local Wutil ""
. // capture ds r508* r509*, has(type numeric)
. // if !_rc local Wutil "`r(varlist)'"
. // if "`Wutil'"!="" {
. //     cap noisily pca `Wutil', components(1) correlation
. //     if !_rc {
. //         cap drop Util_pca1 Util_z
. //         predict double Util_pca1 if e(sample), score
. //         egen double Util_z = std(Util_pca1)
. //     }
. // }
. //
. // local Wedu ""
. // capture ds r701*, has(type numeric)
. // if !_rc local Wedu "`r(varlist)'"
. // if "`Wedu'"!="" {
. //     cap noisily pca `Wedu', components(1) correlation
. //     if !_rc {
. //         cap drop Edu_pca1 Edu_z
. //         predict double Edu_pca1 if e(sample), score
. //         egen double Edu_z = std(Edu_pca1)
. //     }
. // }
. //
. // local Whlth ""
. // capture ds r711*, has(type numeric)
. // if !_rc local Whlth "`r(varlist)'"
. // if "`Whlth'"!="" {
. //     foreach v of local Whlth {
. //         cap drop ln_`v'
. //         gen double ln_`v' = ln(1+`v')
. //     }
. //     capture ds ln_r711*, has(type numeric)
. //     if !_rc {
. //         local Whlthln "`r(varlist)'"
. //         cap noisily pca `Whlthln', components(1) correlation
. //         if !_rc {
. //             cap drop Hlth_pca1 Hlth_z
. //             predict double Hlth_pca1 if e(sample), score
. //             egen double Hlth_z = std(Hlth_pca1)
. //         }
. //     }
. // }
. //
. // local Xgeo ""
. // foreach v in r308a r308b1a r308b1b r308b1c r308b1d r308b1e {
. //     cap confirm numeric variable `v'
. //     if !_rc local Xgeo "`Xgeo' `v'"
. // }
. //
. // local Xenv ""
. // foreach v in r309a r309b r309d r309e r310 {
. //     cap confirm numeric variable `v'
. //     if !_rc local Xenv "`Xenv' `v'"
. // }
. // cap confirm string variable r309c
. // if !_rc {
. //     cap drop r309c_cat
. //     encode r309c, gen(r309c_cat)
. //     local Xenv "`Xenv' i.r309c_cat"
. // }
. //
. // local Xecon ""
. // foreach v in r403a r403c1 r403c2 r105 {
. //     cap confirm numeric variable `v'
. //     if !_rc local Xecon "`Xecon' `v'"
. // }
. // local Xv "`Xgeo' `Xenv' `Xecon'"
. //
. // local Tv "A_v_log"
. //
. // local EST_MAIN ""
. // cap confirm variable Wbasic_z
. // if !_rc {
. //     cap noisily reghdfe Wbasic_z `Tv' `Xv', absorb(kab) vce(cluster kab)
. //     if !_rc {
. //         estimates store rq1
. //         local EST_MAIN "`EST_MAIN' rq1"
. //     }
. // }
. // cap confirm variable lnpov
. // if !_rc {
. //     cap noisily reghdfe lnpov `Tv' `Xv', absorb(kab) vce(cluster kab)
. //     if !_rc {
. //         estimates store rq2
. //         local EST_MAIN "`EST_MAIN' rq2"
. //     }
. // }
. // cap confirm variable Util_z
. // if !_rc {
. //     cap noisily reghdfe Util_z `Tv' `Xv', absorb(kab) vce(cluster kab)
. //     if !_rc {
. //         estimates store rq5
. //         local EST_MAIN "`EST_MAIN' rq5"
. //     }
. // }
. // cap confirm variable Edu_z
. // if !_rc {
. //     cap noisily reghdfe Edu_z `Tv' `Xv', absorb(kab) vce(cluster kab)
. //     if !_rc {
. //         estimates store rq6
. //         local EST_MAIN "`EST_MAIN' rq6"
. //     }
. // }
. // cap confirm variable Hlth_z
. // if !_rc {
. //     cap noisily reghdfe Hlth_z `Tv' `Xv', absorb(kab) vce(cluster kab)
. //     if !_rc {
. //         estimates store rq7
. //         local EST_MAIN "`EST_MAIN' rq7"
. //     }
. // }
. // cap confirm variable Wbasic_z
. // if !_rc {
. //     cap noisily reghdfe Wbasic_z c.`Tv'##i.Fish_strict `Xv', absorb(kab) vce(cluster kab)
. //     if !_rc estimates store rq1_het
. // }
. //
. // /****************************************************************************************
. // I. SUSENAS: HH OUTCOMES + MERGE DISTRICT TREATMENT
. // ****************************************************************************************/
. // tempfile Tk hhcount hh_gas sus_hh
. //
. // * I1) District-level SPBUN intensity from coded site data
. // use `spbun_site_coded', clear
. // rename *, lower
. //
. // cap confirm numeric variable r101
. // if _rc {
. //     di as err "spbun_site_coded missing r101."
. //     exit 111
. // }
. // cap confirm numeric variable r102
. // if _rc {
. //     di as err "spbun_site_coded missing r102."
. //     exit 111
. // }
. //
. // drop if missing(r101) | missing(r102)
. //
. // collapse (count) spbun_n=site_id ///
. //         (sum)   Volume_k=vol_s ///
. //         (sum)   Quota_k=quota_s, by(r101 r102)
. //
. // gen double RR_k = .
. // replace RR_k = Volume_k/Quota_k if Quota_k>0 & !missing(Volume_k)
. // save `Tk', replace
. //
. // * I2) District weights from SUSENAS Block 43
. // use "$sus43", clear
. // rename *, lower
. //
. // cap confirm numeric variable r101
. // if _rc exit 111
. // cap confirm numeric variable r102
. // if _rc exit 111
. //
. // local wvar ""
. // foreach cand in wert bobot weight wgt fwt pwt {
. //     cap confirm numeric variable `cand'
. //     if !_rc & "`wvar'"=="" local wvar "`cand'"
. // }
. // if "`wvar'"=="" {
. //     cap ds *wert* *bobot* *weight* *wgt* *fwt* *pwt*, has(type numeric)
. //     if !_rc local wvar : word 1 of `r(varlist)'
. // }
. // if "`wvar'"=="" {
. //     cap ds *wert* *bobot* *weight* *wgt* *fwt* *pwt*, has(type string)
. //     if !_rc {
. //         local wvar : word 1 of `r(varlist)'
. //         cap destring `wvar', replace ignore(",")
. //     }
. // }
. // cap confirm numeric variable `wvar'
. // if _rc {
. //     di as err "Cannot find usable SUSENAS weight variable in sus43."
. //     exit 111
. // }
. // cap drop wgt
. // rename `wvar' wgt
. //
. // collapse (sum) HH_w = wgt, by(r101 r102)
. // save `hhcount', replace
. //
. // * I3) Merge HH weight to Tk and build intensity per weighted-HH
. // use `Tk', clear
. // merge 1:1 r101 r102 using `hhcount', nogen keep(master match)
. //
. // gen double VolumePerHH_k = .
. // replace VolumePerHH_k = Volume_k / HH_w if HH_w>0 & !missing(Volume_k)
. // save `Tk', replace
. //
. // /****************************************************************************************
. // I4. SUS42: build NonFood (and optional Gas/Solar) per HH
. // ****************************************************************************************/
. // use "$sus42", clear
. // rename *, lower
. //
. // cap confirm numeric variable r101
. // if _rc exit 111
. // cap confirm numeric variable r102
. // if _rc exit 111
. //
. // * detect HH keys and standardize names to: urut wi1 wi2
. // local k1 "urut"
. // local k2 "wi1"
. // local k3 "wi2"
. //
. // cap confirm variable `k1'
. // if _rc {
. //     cap ds *urut*, has(type numeric)
. //     if !_rc local k1 : word 1 of `r(varlist)'
. //     else {
. //         cap ds *urut*, has(type string)
. //         if !_rc local k1 : word 1 of `r(varlist)'
. //     }
. // }
. // cap confirm variable `k2'
. // if _rc {
. //     cap ds *wi1*, has(type numeric)
. //     if !_rc local k2 : word 1 of `r(varlist)'
. //     else {
. //         cap ds *wi1*, has(type string)
. //         if !_rc local k2 : word 1 of `r(varlist)'
. //     }
. // }
. // cap confirm variable `k3'
. // if _rc {
. //     cap ds *wi2*, has(type numeric)
. //     if !_rc local k3 : word 1 of `r(varlist)'
. //     else {
. //         cap ds *wi2*, has(type string)
. //         if !_rc local k3 : word 1 of `r(varlist)'
. //     }
. // }
. //
. // cap confirm variable `k1'
. // if _rc exit 111
. // cap confirm variable `k2'
. // if _rc exit 111
. // cap confirm variable `k3'
. // if _rc exit 111
. //
. // * normalize key types
. // cap confirm string variable `k1'
. // if !_rc cap destring `k1', replace ignore(" ,")
. // cap confirm string variable `k2'
. // if !_rc cap destring `k2', replace ignore(" ,")
. // cap confirm string variable `k3'
. // if !_rc cap destring `k3', replace ignore(" ,")
. //
. // if "`k1'"!="urut" rename `k1' urut
. // if "`k2'"!="wi1"  rename `k2' wi1
. // if "`k3'"!="wi2"  rename `k3' wi2
. //
. // * detect COICOP var
. // local coicopvar "coicop"
. // cap confirm variable `coicopvar'
. // if _rc {
. //     cap ds *coicop*, has(type numeric)
. //     if !_rc local coicopvar : word 1 of `r(varlist)'
. //     else {
. //         cap ds *coicop*, has(type string)
. //         if !_rc local coicopvar : word 1 of `r(varlist)'
. //     }
. // }
. // cap confirm variable `coicopvar'
. // if _rc {
. //     di as err "sus42: cannot find COICOP variable."
. //     exit 111
. // }
. //
. // * detect monthly exp var (SEBULAN-like)
. // local expvar "sebulan"
. // cap confirm variable `expvar'
. // if _rc {
. //     cap ds *sebulan*, has(type numeric)
. //     if !_rc local expvar : word 1 of `r(varlist)'
. //     else {
. //         cap ds *sebulan*, has(type string)
. //         if !_rc {
. //             local expvar : word 1 of `r(varlist)'
. //             cap destring `expvar', replace ignore(",")
. //         }
. //     }
. // }
. // cap confirm numeric variable `expvar'
. // if _rc {
. //     di as err "sus42: cannot find numeric monthly expenditure variable (SEBULAN-like)."
. //     exit 111
. // }
. //
. // * >>> OPTIONAL: fill these with actual codes if you want Gas/Solar
. // local COICOP_GAS   ""
. // local COICOP_SOLAR ""
. //
. // gen double nonfood_item = `expvar'
. //
. // gen byte is_gas = 0
. // gen byte is_solar = 0
. //
. // * Gas/Solar only if codes provided
. // local do_gas = ("`COICOP_GAS'"!="")
. // local do_solar = ("`COICOP_SOLAR'"!="")
. //
. // capture confirm numeric variable `coicopvar'
. // if !_rc {
. //     if `do_gas'   replace is_gas   = inlist(`coicopvar', `COICOP_GAS')
. //     if `do_solar' replace is_solar = inlist(`coicopvar', `COICOP_SOLAR')
. // }
. // else {
. //     cap tostring `coicopvar', replace
. //     if `do_gas'   replace is_gas   = inlist(`coicopvar', `"`COICOP_GAS'"')
. //     if `do_solar' replace is_solar = inlist(`coicopvar', `"`COICOP_SOLAR'"')
. // }
. //
. // gen double gas_m   = .
. // gen double solar_m = .
. // if `do_gas'   replace gas_m   = cond(is_gas==1,   `expvar', 0)
. // if `do_solar' replace solar_m = cond(is_solar==1, `expvar', 0)
. //
. // collapse (sum) GasExp=gas_m SolarExp=solar_m NonFoodExp=nonfood_item, ///
. //     by(r101 r102 urut wi1 wi2)
. //
. // gen double lnGas   = ln(1 + GasExp)   if !missing(GasExp)
. // gen double lnSolar = ln(1 + SolarExp) if !missing(SolarExp)
. //
. // save `hh_gas', replace
. //
. // /****************************************************************************************
. // I5. SUS43: HH dataset + merge hh_gas + merge Tk; set untreated districts to 0
. // ****************************************************************************************/
. // use "$sus43", clear
. // rename *, lower
. //
. // cap confirm numeric variable r101
. // if _rc exit 111
. // cap confirm numeric variable r102
. // if _rc exit 111
. //
. // * weight -> wgt
. // cap confirm numeric variable wgt
. // if _rc {
. //     local wvar ""
. //     foreach cand in wert bobot weight wgt fwt pwt {
. //         cap confirm numeric variable `cand'
. //         if !_rc & "`wvar'"=="" local wvar "`cand'"
. //     }
. //     if "`wvar'"=="" {
. //         cap ds *wert* *bobot* *weight* *wgt* *fwt* *pwt*, has(type numeric)
. //         if !_rc local wvar : word 1 of `r(varlist)'
. //     }
. //     cap confirm numeric variable `wvar'
. //     if _rc exit 111
. //     cap drop wgt
. //     rename `wvar' wgt
. // }
. //
. // * standardize keys to urut wi1 wi2 (same as hh_gas)
. // local k1 "urut"
. // local k2 "wi1"
. // local k3 "wi2"
. //
. // cap confirm variable `k1'
. // if _rc {
. //     cap ds *urut*, has(type numeric)
. //     if !_rc local k1 : word 1 of `r(varlist)'
. //     else {
. //         cap ds *urut*, has(type string)
. //         if !_rc local k1 : word 1 of `r(varlist)'
. //     }
. // }
. // cap confirm variable `k2'
. // if _rc {
. //     cap ds *wi1*, has(type numeric)
. //     if !_rc local k2 : word 1 of `r(varlist)'
. //     else {
. //         cap ds *wi1*, has(type string)
. //         if !_rc local k2 : word 1 of `r(varlist)'
. //     }
. // }
. // cap confirm variable `k3'
. // if _rc {
. //     cap ds *wi2*, has(type numeric)
. //     if !_rc local k3 : word 1 of `r(varlist)'
. //     else {
. //         cap ds *wi2*, has(type string)
. //         if !_rc local k3 : word 1 of `r(varlist)'
. //     }
. // }
. //
. // cap confirm string variable `k1'
. // if !_rc cap destring `k1', replace ignore(" ,")
. // cap confirm string variable `k2'
. // if !_rc cap destring `k2', replace ignore(" ,")
. // cap confirm string variable `k3'
. // if !_rc cap destring `k3', replace ignore(" ,")
. //
. // if "`k1'"!="urut" rename `k1' urut
. // if "`k2'"!="wi1"  rename `k2' wi1
. // if "`k3'"!="wi2"  rename `k3' wi2
. //
. // merge 1:1 r101 r102 urut wi1 wi2 using `hh_gas', nogen keep(master match)
. // merge m:1 r101 r102 using `Tk', nogen keep(master match)
. //
. // * set untreated districts to 0 (keep controls)
. // foreach v in spbun_n Volume_k Quota_k RR_k HH_w VolumePerHH_k {
. //     cap confirm variable `v'
. //     if !_rc replace `v' = 0 if missing(`v')
. // }
. //
. // * HH size
. // cap confirm numeric variable r301
. // if !_rc gen double HHSize = r301
. // else {
. //     cap ds *r301*, has(type numeric)
. //     if !_rc {
. //         local hhs : word 1 of `r(varlist)'
. //         gen double HHSize = `hhs'
. //     }
. // }
. //
. // cap confirm numeric variable r105
. // if !_rc gen byte Urban = (r105==1) if !missing(r105)
. //
. // cap confirm numeric variable NonFoodExp
. // if _rc {
. //     di as err "NonFoodExp not found after merging hh_gas."
. //     exit 111
. // }
. //
. // gen double NonFoodExpPC = NonFoodExp / HHSize if HHSize>0 & !missing(NonFoodExp)
. // gen double lnNonFoodPC  = ln(NonFoodExpPC) if NonFoodExpPC>0
. //
. // foreach v in kalori_kap prote_kap lemak_kap karbo_kap {
. //     cap confirm numeric variable `v'
. //     if !_rc gen double ln_`v' = ln(1+`v')
. // }
. //
. // save `sus_hh', replace
. //
. // /****************************************************************************************
. // J. SUSENAS MODELS (province FE; cluster district; weights wgt)
. // ****************************************************************************************/
. // use `sus_hh', clear
. //
. // egen long kab = group(r101 r102), label
. //
. // local Zh "HHSize Urban"
. // cap confirm variable HHSize
. // if _rc local Zh : subinstr local Zh "HHSize" "", all
. // cap confirm variable Urban
. // if _rc local Zh : subinstr local Zh "Urban" "", all
. //
. // local Tk_base "VolumePerHH_k"
. // cap confirm numeric variable `Tk_base'
. // if _rc {
. //     di as err "Tk_base (`Tk_base') missing."
. //     exit 111
. // }
. //
. // cap confirm variable lnGas
. // if !_rc {
. //     cap noisily reghdfe lnGas `Tk_base' `Zh' [pw=wgt], absorb(r101) vce(cluster kab)
. //     if !_rc estimates store rq10_gas
. // }
. // cap confirm variable lnSolar
. // if !_rc {
. //     cap noisily reghdfe lnSolar `Tk_base' `Zh' [pw=wgt], absorb(r101) vce(cluster kab)
. //     if !_rc estimates store rq10_solar
. // }
. // cap confirm variable lnNonFoodPC
. // if !_rc {
. //     cap noisily reghdfe lnNonFoodPC `Tk_base' `Zh' [pw=wgt], absorb(r101) vce(cluster kab)
. //     if !_rc estimates store rq11
. // }
. // foreach y in ln_kalori_kap ln_prote_kap ln_lemak_kap ln_karbo_kap {
. //     cap confirm variable `y'
. //     if !_rc {
. //         cap noisily reghdfe `y' `Tk_base' `Zh' [pw=wgt], absorb(r101) vce(cluster kab)
. //         if !_rc estimates store rq12_`y'
. //     }
. // }
. //
. // /****************************************************************************************
. // K. ROBUSTNESS GRID: rerun village RQ1 across exposure definitions
. // ****************************************************************************************/
. // use "$outdir/podes_vill.dta", clear
. // merge 1:1 iddesa using `vill_exposure', nogen keep(master match)
. //
. // local Xgeo ""
. // foreach v in r308a r308b1a r308b1b r308b1c r308b1d r308b1e {
. //     cap confirm numeric variable `v'
. //     if !_rc local Xgeo "`Xgeo' `v'"
. // }
. // local Xenv ""
. // foreach v in r309a r309b r309d r309e r310 {
. //     cap confirm numeric variable `v'
. //     if !_rc local Xenv "`Xenv' `v'"
. // }
. // cap confirm string variable r309c
. // if !_rc {
. //     cap drop r309c_cat
. //     encode r309c, gen(r309c_cat)
. //     local Xenv "`Xenv' i.r309c_cat"
. // }
. // local Xecon ""
. // foreach v in r403a r403c1 r403c2 r105 {
. //     cap confirm numeric variable `v'
. //     if !_rc local Xecon "`Xecon' `v'"
. // }
. // local Xv "`Xgeo' `Xenv' `Xecon'"
. //
. // cap confirm variable Wbasic_z
. // if _rc {
. //     local Wbasic ""
. //     capture ds r501* r502* r503*, has(type numeric)
. //     if !_rc local Wbasic "`r(varlist)'"
. //     if "`Wbasic'"!="" {
. //         cap noisily pca `Wbasic', components(1) correlation
. //         if !_rc {
. //             predict double Wbasic_pca1 if e(sample), score
. //             egen double Wbasic_z = std(Wbasic_pca1)
. //         }
. //     }
. // }
. //
. // cap confirm variable Wbasic_z
. // if !_rc {
. //     local exposures "A_v_log C5_w1 C10_w1 C15_w1 Ker5_w1 Ker10_w1 Ker20_w1"
. //     foreach T of local exposures {
. //         cap confirm numeric variable `T'
. //         if !_rc {
. //             cap noisily reghdfe Wbasic_z `T' `Xv', absorb(kab) vce(cluster kab)
. //             if !_rc estimates store rb_`T'
. //         }
. //     }
. // }
. //
. // /****************************************************************************************
. // L. OUTPUT TABLE
. // ****************************************************************************************/
. // cap which esttab
. // if _rc ssc install estout, replace
. //
. // local OUTLIST ""
. // foreach m in rq1 rq2 rq5 rq6 rq7 rq10_gas rq10_solar rq11 {
. //     cap estimates restore `m'
. //     if !_rc local OUTLIST "`OUTLIST' `m'"
. // }
. //
. // cap noisily esttab `OUTLIST' using "$outdir/results_main.rtf", replace
. //
. // log close
. // di as result "DONE. Outputs in: $outdir"
. 
end of do-file

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. // use `spbun_loc', clear
. // tempfile spbun_near villcoords site_bins site2kab
. // local binsz = 0.10
. // save `spbun_near' `villcoords' `site_bins' `site2kab', replace
. //
. // use `villages', clear
. // tempfile _vill_for_py
. // save ` _vill_for_py', replace
. //
. // use `spbun_loc', clear
. //
. //
. //
. // use `spbun_near', clear
. // save `spbun_near', replace
. 
. 
. 
. 
. 
. tempfile spbun_near villcoords site_bins site2kab

. local binsz = 0.10

. 
. use `spbun_loc', clear

. 
. preserve

.     use "$outdir/podes_vill.dta", clear

.     keep iddesa kab r101 r102 lat_v lon_v

.     drop if missing(lat_v) | missing(lon_v)
(0 observations deleted)

.     save `villcoords', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. restore

. 
. drop if missing(lat_s) | missing(lon_s)
(0 observations deleted)

. 
. gen int latbin = floor(lat_s/`binsz')

. gen int lonbin = floor(lon_s/`binsz')

. 
. expand 9
(3,000 observations created)

. bys site_id: gen byte _g = _n - 1

. gen int dlat = floor(_g/3) - 1

. gen int dlon = mod(_g,3) - 1

. gen int latbin2 = latbin + dlat

. gen int lonbin2 = lonbin + dlon

. drop _g dlat dlon

. 
. save `site_bins', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000009 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000009 saved as .dta format

. 
. use `villcoords', clear

. gen int latbin2 = floor(lat_v/`binsz')

. gen int lonbin2 = floor(lon_v/`binsz')

. 
. joinby latbin2 lonbin2 using `site_bins'

. geodist lat_v lon_v lat_s lon_s, gen(dkm)

. bys site_id (dkm): keep if _n==1
(31,828 observations deleted)

. 
. keep site_id r101 r102 kab

. save `site2kab', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.00000a not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.00000a saved as .dta format

. 
. use `spbun_loc', clear

. merge 1:1 site_id using `site2kab', nogen keep(master match)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             1
        from master                         1  
        from using                          0  

    Matched                               374  
    -----------------------------------------

. 
. // * ----------------------------
. // * 5) Merge nearest-poverty with SURVIVAL (viability + MDI)
. // * ----------------------------
. // use `spbun_near', clear
. // merge 1:1 spbun_id using `surv', keep(match master) nogenerate
. // save `merged_final', replace
. //
. // * ----------------------------
. // * 6) High MDI definition (follow MDI.do if components exist; else use mdi_in)
. // *    Practical default:
. // *      - If mdi_in is already 1/2/3 (tercile), "high" = 3
. // *      - Else if continuous, "high" = top tercile by xtile
. // * ----------------------------
. // use `merged_final', clear
. //
. // capture assert inlist(mdi_in,1,2,3) if !missing(mdi_in)
. // if _rc==0 {
. //     gen byte high_mdi = (mdi_in==3) if !missing(mdi_in)
. //     label var high_mdi "High MDI (mdi_in==3)"
. // }
. // else {
. //     cap drop mdi_kl3 high_mdi
. //     xtile mdi_kl3 = mdi_in, nq(3)
. //     gen byte high_mdi = (mdi_kl3==3) if !missing(mdi_kl3)
. //     label var high_mdi "High MDI (top tercile of mdi_in)"
. // }
. //
. // * ----------------------------
. // * 7) Probability of "tidak layak" given high MDI and poverty
. // *    (no need to categorize poverty index)
. // * ----------------------------
. // keep if !missing(tidak_layak, high_mdi, lnpov_near)
. //
. // * Core logit: poverty + high MDI + interaction
. // logit tidak_layak c.lnpov_near##i.high_mdi, vce(robust)
. // estimates store M1
. //
. // * Predicted probability at representative poverty levels (p25, p50, p75) by MDI group
. // summ lnpov_near, detail
. // local p25 = r(p25)
. // local p50 = r(p50)
. // local p75 = r(p75)
. //
. // margins high_mdi, at(lnpov_near=(`p25' `p50' `p75')) post
. // estimates store Marg1
. //
. // * Simple empirical rates (sanity check): mean tidak_layak by high_mdi
. // bys high_mdi: summ tidak_layak
. //
. // * Export outputs
. // predict double phat_M1 if e(sample), pr
. // label var phat_M1 "Predicted P(tidak layak) from logit"
. //
. // save "$OUTDIR/spbun_nearestpoverty_viability.dta", replace
. // export delimited using "$OUTDIR/spbun_nearestpoverty_viability.csv", replace
. //
. // * Optional: compact regression table (requires esttab)
. // cap which esttab
. // if !_rc {
. //     esttab M1 using "$OUTDIR/logit_tidaklayak.rtf", replace ///
. //         b(%9.4f) se(%9.4f) star(* 0.10 ** 0.05 *** 0.01) ///
. //         stats(N ll, fmt(%9.0g %9.3f) labels("N" "LogLik")) ///
. //         title("Logit: P(SPBUN tidak layak) ~ poverty (nearest) x High MDI")
. // }
. //
. // di as txt "DONE. Outputs:"
. // di as txt "  $OUTDIR/spbun_nearestpoverty_viability.dta"
. // di as txt "  $OUTDIR/spbun_nearestpoverty_viability.csv"
. 
end of do-file

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. use `spbun_loc', clear

. tempfile _spbun_for_py

. save ` _spbun_for_py', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. use `villages', clear

. tempfile _vill_for_py

. save ` _vill_for_py', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. use `spbun_loc', clear

. python:
minimum Python version required is 2.7
r(111);

end of do-file

r(111);

. ssc install geonear
checking geonear consistency and verifying not already installed...
installing into /Users/athamawardi/Library/Application Support/Stata/ado/plus/...
installation complete.

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (ID + lat/lon)
. *    Assumption: NoLembagaPenyalur == NomorSPBUN (SPBUN id used in Survival)
. * ----------------------------
. import excel using "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. if _rc {
.     di as err "Column 'Koordinat' not found in lokasi_spbu-n.xlsx (sheet: Data)."
.     error 198
. }

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".", "")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160), "", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_spbun = real(_c1)
(1,364 missing values generated)

. gen double lon_spbun = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. gen byte _swap = (abs(lat_spbun)>90 & abs(lon_spbun)<=90)

. gen double _tmp = lat_spbun
(1,364 missing values generated)

. replace lat_spbun = lon_spbun if _swap
(0 real changes made)

. replace lon_spbun = _tmp      if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_spbun) | missing(lon_spbun)
(1,367 observations deleted)

. 
. capture confirm variable NoLembagaPenyalur

. if _rc {
.     di as err "Column 'NoLembagaPenyalur' not found in lokasi_spbu-n.xlsx (sheet: Data)."
.     error 198
. }

. rename NoLembagaPenyalur spbun_id

. destring spbun_id, replace force
spbun_id already numeric; no replace

. 
. keep spbun_id lat_spbun lon_spbun

. duplicates drop spbun_id, force

Duplicates in terms of spbun_id

(0 observations are duplicates)

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by spbun_id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. 
. capture confirm variable NomorSPBUN

. if _rc {
.     di as err "Column 'NomorSPBUN' not found in SURVIVAL file (sheet: Summary_Model1)."
.     error 198
. }

. rename NomorSPBUN spbun_id

. destring spbun_id, replace force
spbun_id already numeric; no replace

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability numeric column containing both 'layak' and 'tidak'. Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. capture confirm variable MDI

. if _rc {
.     di as err "Cannot find 'MDI' column in SURVIVAL sheet. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. duplicates drop spbun_id, force

Duplicates in terms of spbun_id

(0 observations are duplicates)

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. 
. capture confirm variable iddesa

. if _rc { di as err "Variable 'iddesa' not found in PODES dta."; error 198 }
. capture confirm variable lat_v
. if _rc { di as err "Variable 'lat_v' not found in PODES dta."; error 198 }
. capture confirm variable lon_v
. if _rc { di as err "Variable 'lon_v' not found in PODES dta."; error 198 }
. capture confirm variable lnpov
. if _rc { di as err "Variable 'lnpov' not found in PODES dta."; error 198 }
. 
. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa
. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
. save `villages', replace
. 
. * ----------------------------
. * 4) Nearest village to each SPBUN (STATA-only): geonear
. * ----------------------------
. cap which geonear
. if _rc {
.     di as err "Package geonear not found. Install it:  ssc install geonear"
.     error 499
. }
. 
. use `spbun_loc', clear
. geonear spbun_id lat_spbun lon_spbun using `villages', ///
>     n(1) ///
>     near(iddesa lat_v lon_v) ///
>     long ///
>     miles(0)
. 
. * geonear outputs:
. *   nid (nearest id from using), dist (distance, in km when miles(0))
. rename nid nearest_iddesa
. rename dist dist_km
. 
. * bring poverty for nearest village: geonear already carries vars from using when "long"
. capture confirm variable lnpov
. if _rc {
.     di as err "geonear did not carry lnpov. Re-run with 'long' and ensure 'lnpov' exists in using."
.     error 198
. }
. rename lnpov lnpov_near
. 
. keep spbun_id lat_spbun lon_spbun nearest_iddesa dist_km lnpov_near
. save `spbun_near', replace
. 
. * ----------------------------
. * 5) Merge and estimate P(tidak layak | MDI, poverty)
. * ----------------------------
. use `spbun_near', clear
. merge 1:1 spbun_id using `surv', keep(match) nogen
. 
. drop if missing(tidak_layak) | missing(mdi_in) | missing(lnpov_near)
. 
. egen mdi_p75 = pctile(mdi_in), p(75)
. gen byte mdi_high = (mdi_in >= mdi_p75) if !missing(mdi_in)
. 
. quietly logit tidak_layak c.mdi_in c.lnpov_near c.mdi_in#c.lnpov_near
. predict double p_tidak_layak_m1 if e(sample), pr
. 
. quietly logit tidak_layak i.mdi_high##c.lnpov_near
. predict double p_tidak_layak_m2 if e(sample), pr
. 
. order spbun_id tidak_layak layak_flag mdi_in mdi_high lnpov_near dist_km nearest_iddesa ///
>       p_tidak_layak_m1 p_tidak_layak_m2
. 
. save "$OUTDIR/spbun_mdi_pov_prob.dta", replace
. export delimited using "$OUTDIR/spbun_mdi_pov_prob.csv", replace
. 
. summ p_tidak_layak_m1 p_tidak_layak_m2
. tab tidak_layak mdi_high, row
. 
. // * ----------------------------
. // * 5) Merge nearest-poverty with SURVIVAL (viability + MDI)
. // * ----------------------------
. // use `spbun_near', clear
. // merge 1:1 spbun_id using `surv', keep(match master) nogenerate
. // save `merged_final', replace
. //
. // * ----------------------------
. // * 6) High MDI definition (follow MDI.do if components exist; else use mdi_in)
. // *    Practical default:
. // *      - If mdi_in is already 1/2/3 (tercile), "high" = 3
. // *      - Else if continuous, "high" = top tercile by xtile
. // * ----------------------------
. // use `merged_final', clear
. //
. // capture assert inlist(mdi_in,1,2,3) if !missing(mdi_in)
. // if _rc==0 {
. //     gen byte high_mdi = (mdi_in==3) if !missing(mdi_in)
. //     label var high_mdi "High MDI (mdi_in==3)"
. // }
. // else {
. //     cap drop mdi_kl3 high_mdi
. //     xtile mdi_kl3 = mdi_in, nq(3)
. //     gen byte high_mdi = (mdi_kl3==3) if !missing(mdi_kl3)
. //     label var high_mdi "High MDI (top tercile of mdi_in)"
. // }
. //
. // * ----------------------------
. // * 7) Probability of "tidak layak" given high MDI and poverty
. // *    (no need to categorize poverty index)
. // * ----------------------------
. // keep if !missing(tidak_layak, high_mdi, lnpov_near)
. //
. // * Core logit: poverty + high MDI + interaction
. // logit tidak_layak c.lnpov_near##i.high_mdi, vce(robust)
. // estimates store M1
. //
. // * Predicted probability at representative poverty levels (p25, p50, p75) by MDI group
. // summ lnpov_near, detail
. // local p25 = r(p25)
. // local p50 = r(p50)
. // local p75 = r(p75)
. //
. // margins high_mdi, at(lnpov_near=(`p25' `p50' `p75')) post
. // estimates store Marg1
. //
. // * Simple empirical rates (sanity check): mean tidak_layak by high_mdi
. // bys high_mdi: summ tidak_layak
. //
. // * Export outputs
. // predict double phat_M1 if e(sample), pr
. // label var phat_M1 "Predicted P(tidak layak) from logit"
. //
. // save "$OUTDIR/spbun_nearestpoverty_viability.dta", replace
. // export delimited using "$OUTDIR/spbun_nearestpoverty_viability.csv", replace
. //
. // * Optional: compact regression table (requires esttab)
. // cap which esttab
. // if !_rc {
. //     esttab M1 using "$OUTDIR/logit_tidaklayak.rtf", replace ///
. //         b(%9.4f) se(%9.4f) star(* 0.10 ** 0.05 *** 0.01) ///
. //         stats(N ll, fmt(%9.0g %9.3f) labels("N" "LogLik")) ///
. //         title("Logit: P(SPBUN tidak layak) ~ poverty (nearest) x High MDI")
. // }
. //
. // di as txt "DONE. Outputs:"
. // di as txt "  $OUTDIR/spbun_nearestpoverty_viability.dta"
. // di as txt "  $OUTDIR/spbun_nearestpoverty_viability.csv"
. program error:  matching close brace not found
r(198);

end of do-file

r(198);
. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. if _rc {
.     di as err "Package geonear not found. Install it:  ssc install geonear"
.     error 499
. }

. 
. use `spbun_loc', clear

. geonear spbun_id lat_spbun lon_spbun using `villages', ///
>     n(1) ///
>     near(iddesa lat_v lon_v) ///
>     long ///
>     miles(0)
variable spbun_id not found
r(111);

end of do-file

r(111);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. // * ----------------------------
. // * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. // * ----------------------------
. // cap which geonear
. // if _rc {
. //     di as err "Package geonear not found. Install it:  ssc install geonear"
. //     error 499
. // }
. //
. // use `spbun_loc', clear
. // geonear spbun_id lat_spbun lon_spbun using `villages', ///
. //     n(1) ///
. //     near(iddesa lat_v lon_v) ///
. //     long ///
. //     miles(0)
. //
. // * geonear outputs:
. // *   nid (nearest id from using), dist (distance, in km when miles(0))
. // rename nid nearest_iddesa
. // rename dist dist_km
. //
. // * bring poverty for nearest village: geonear already carries vars from using when "long"
. // capture confirm variable lnpov
. // if _rc {
. //     di as err "geonear did not carry lnpov. Re-run with 'long' and ensure 'lnpov' exists in using."
. //     error 198
. // }
. // rename lnpov lnpov_near
. //
. // keep spbun_id lat_spbun lon_spbun nearest_iddesa dist_km lnpov_near
. // save `spbun_near', replace
. 
. // * ----------------------------
. // * 5) Merge nearest-poverty with SURVIVAL (viability + MDI)
. // * ----------------------------
. // use `spbun_near', clear
. // merge 1:1 spbun_id using `surv', keep(match master) nogenerate
. // save `merged_final', replace
. //
. // * ----------------------------
. // * 6) High MDI definition (follow MDI.do if components exist; else use mdi_in)
. // *    Practical default:
. // *      - If mdi_in is already 1/2/3 (tercile), "high" = 3
. // *      - Else if continuous, "high" = top tercile by xtile
. // * ----------------------------
. // use `merged_final', clear
. //
. // capture assert inlist(mdi_in,1,2,3) if !missing(mdi_in)
. // if _rc==0 {
. //     gen byte high_mdi = (mdi_in==3) if !missing(mdi_in)
. //     label var high_mdi "High MDI (mdi_in==3)"
. // }
. // else {
. //     cap drop mdi_kl3 high_mdi
. //     xtile mdi_kl3 = mdi_in, nq(3)
. //     gen byte high_mdi = (mdi_kl3==3) if !missing(mdi_kl3)
. //     label var high_mdi "High MDI (top tercile of mdi_in)"
. // }
. //
. // * ----------------------------
. // * 7) Probability of "tidak layak" given high MDI and poverty
. // *    (no need to categorize poverty index)
. // * ----------------------------
. // keep if !missing(tidak_layak, high_mdi, lnpov_near)
. //
. // * Core logit: poverty + high MDI + interaction
. // logit tidak_layak c.lnpov_near##i.high_mdi, vce(robust)
. // estimates store M1
. //
. // * Predicted probability at representative poverty levels (p25, p50, p75) by MDI group
. // summ lnpov_near, detail
. // local p25 = r(p25)
. // local p50 = r(p50)
. // local p75 = r(p75)
. //
. // margins high_mdi, at(lnpov_near=(`p25' `p50' `p75')) post
. // estimates store Marg1
. //
. // * Simple empirical rates (sanity check): mean tidak_layak by high_mdi
. // bys high_mdi: summ tidak_layak
. //
. // * Export outputs
. // predict double phat_M1 if e(sample), pr
. // label var phat_M1 "Predicted P(tidak layak) from logit"
. //
. // save "$OUTDIR/spbun_nearestpoverty_viability.dta", replace
. // export delimited using "$OUTDIR/spbun_nearestpoverty_viability.csv", replace
. //
. // * Optional: compact regression table (requires esttab)
. // cap which esttab
. // if !_rc {
. //     esttab M1 using "$OUTDIR/logit_tidaklayak.rtf", replace ///
. //         b(%9.4f) se(%9.4f) star(* 0.10 ** 0.05 *** 0.01) ///
. //         stats(N ll, fmt(%9.0g %9.3f) labels("N" "LogLik")) ///
. //         title("Logit: P(SPBUN tidak layak) ~ poverty (nearest) x High MDI")
. // }
. //
. // di as txt "DONE. Outputs:"
. // di as txt "  $OUTDIR/spbun_nearestpoverty_viability.dta"
. // di as txt "  $OUTDIR/spbun_nearestpoverty_viability.csv"
. 
end of do-file

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. // * ----------------------------
. // * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. // * ----------------------------
. // import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
. // rename NomorSPBUN spbun_id
. //
. // local vlay ""
. // ds, has(type numeric)
. // foreach v in `r(varlist)' {
. //     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
. // }
. // if "`vlay'"=="" {
. //     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
. //     error 198
. // }
. // rename `vlay' layak_flag
. // gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)
. //
. // cap confirm var MDI
. // if _rc {
. //     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
. //     error 198
. // }
. // rename MDI mdi_in
. //
. // keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP
. // save `surv', replace
. //
. // * ----------------------------
. // * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. // * ----------------------------
. // use "$PODES_DTA", clear
. // keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa
. // drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
. // save `villages', replace
. //
. // * ----------------------------
. // * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. // * ----------------------------
. // cap which geonear
. // use `spbun_loc', clear
. // geonear spbun_id lat_spbun lon_spbun using `villages', ///
. //     n(1) ///
. //     near(iddesa lat_v lon_v) ///
. //     long ///
. //     miles(0)
. // rename nid nearest_iddesa
. // rename dist dist_km
. //
. // capture confirm variable lnpov
. // rename lnpov lnpov_near
. //
. // keep spbun_id lat_spbun lon_spbun nearest_iddesa dist_km lnpov_near
. // save `spbun_near', replace
. //
. //
. //
. // tempfile spbun_site_coded villcoords site_bins site2kab
. // local binsz = 0.10
. //
. // use `spbun_site', clear
. //
. // preserve
. //     use "$outdir/podes_vill.dta", clear
. //     keep iddesa kab r101 r102 lat_v lon_v
. //     drop if missing(lat_v) | missing(lon_v)
. //     save `villcoords', replace
. // restore
. //
. // drop if missing(lat_s) | missing(lon_s)
. //
. // gen int latbin = floor(lat_s/`binsz')
. // gen int lonbin = floor(lon_s/`binsz')
. //
. // expand 9
. // bys site_id: gen byte _g = _n - 1
. // gen int dlat = floor(_g/3) - 1
. // gen int dlon = mod(_g,3) - 1
. // gen int latbin2 = latbin + dlat
. // gen int lonbin2 = lonbin + dlon
. // drop _g dlat dlon
. //
. // save `site_bins', replace
. //
. // use `villcoords', clear
. // gen int latbin2 = floor(lat_v/`binsz')
. // gen int lonbin2 = floor(lon_v/`binsz')
. //
. // joinby latbin2 lonbin2 using `site_bins'
. // geodist lat_v lon_v lat_s lon_s, gen(dkm)
. // bys site_id (dkm): keep if _n==1
. //
. // keep site_id r101 r102 kab
. // save `site2kab', replace
. //
. // use `spbun_site', clear
. // merge 1:1 site_id using `site2kab', nogen keep(master match)
. // save `spbun_site_coded', replace
. 
. // * ----------------------------
. // * 5) Merge nearest-poverty with SURVIVAL (viability + MDI)
. // * ----------------------------
. // use `spbun_near', clear
. // merge 1:1 spbun_id using `surv', keep(match master) nogenerate
. // save `merged_final', replace
. //
. // * ----------------------------
. // * 6) High MDI definition (follow MDI.do if components exist; else use mdi_in)
. // *    Practical default:
. // *      - If mdi_in is already 1/2/3 (tercile), "high" = 3
. // *      - Else if continuous, "high" = top tercile by xtile
. // * ----------------------------
. // use `merged_final', clear
. //
. // capture assert inlist(mdi_in,1,2,3) if !missing(mdi_in)
. // if _rc==0 {
. //     gen byte high_mdi = (mdi_in==3) if !missing(mdi_in)
. //     label var high_mdi "High MDI (mdi_in==3)"
. // }
. // else {
. //     cap drop mdi_kl3 high_mdi
. //     xtile mdi_kl3 = mdi_in, nq(3)
. //     gen byte high_mdi = (mdi_kl3==3) if !missing(mdi_kl3)
. //     label var high_mdi "High MDI (top tercile of mdi_in)"
. // }
. //
. // * ----------------------------
. // * 7) Probability of "tidak layak" given high MDI and poverty
. // *    (no need to categorize poverty index)
. // * ----------------------------
. // keep if !missing(tidak_layak, high_mdi, lnpov_near)
. //
. // * Core logit: poverty + high MDI + interaction
. // logit tidak_layak c.lnpov_near##i.high_mdi, vce(robust)
. // estimates store M1
. //
. // * Predicted probability at representative poverty levels (p25, p50, p75) by MDI group
. // summ lnpov_near, detail
. // local p25 = r(p25)
. // local p50 = r(p50)
. // local p75 = r(p75)
. //
. // margins high_mdi, at(lnpov_near=(`p25' `p50' `p75')) post
. // estimates store Marg1
. //
. // * Simple empirical rates (sanity check): mean tidak_layak by high_mdi
. // bys high_mdi: summ tidak_layak
. //
. // * Export outputs
. // predict double phat_M1 if e(sample), pr
. // label var phat_M1 "Predicted P(tidak layak) from logit"
. //
. // save "$OUTDIR/spbun_nearestpoverty_viability.dta", replace
. // export delimited using "$OUTDIR/spbun_nearestpoverty_viability.csv", replace
. //
. // * Optional: compact regression table (requires esttab)
. // cap which esttab
. // if !_rc {
. //     esttab M1 using "$OUTDIR/logit_tidaklayak.rtf", replace ///
. //         b(%9.4f) se(%9.4f) star(* 0.10 ** 0.05 *** 0.01) ///
. //         stats(N ll, fmt(%9.0g %9.3f) labels("N" "LogLik")) ///
. //         title("Logit: P(SPBUN tidak layak) ~ poverty (nearest) x High MDI")
. // }
. //
. // di as txt "DONE. Outputs:"
. // di as txt "  $OUTDIR/spbun_nearestpoverty_viability.dta"
. // di as txt "  $OUTDIR/spbun_nearestpoverty_viability.csv"
. 
end of do-file

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. use `spbun_loc', clear

. // geonear spbun_id lat_spbun lon_spbun using `villages', ///
. //     n(1) ///
. //     near(iddesa lat_v lon_v) ///
. //     long ///
. //     miles(0)
. // rename nid nearest_iddesa
. // rename dist dist_km
. //
. // capture confirm variable lnpov
. // rename lnpov lnpov_near
. //
. // keep spbun_id lat_spbun lon_spbun nearest_iddesa dist_km lnpov_near
. // save `spbun_near', replace
. //
. //
. //
. // tempfile spbun_site_coded villcoords site_bins site2kab
. // local binsz = 0.10
. //
. // use `spbun_site', clear
. //
. // preserve
. //     use "$outdir/podes_vill.dta", clear
. //     keep iddesa kab r101 r102 lat_v lon_v
. //     drop if missing(lat_v) | missing(lon_v)
. //     save `villcoords', replace
. // restore
. //
. // drop if missing(lat_s) | missing(lon_s)
. //
. // gen int latbin = floor(lat_s/`binsz')
. // gen int lonbin = floor(lon_s/`binsz')
. //
. // expand 9
. // bys site_id: gen byte _g = _n - 1
. // gen int dlat = floor(_g/3) - 1
. // gen int dlon = mod(_g,3) - 1
. // gen int latbin2 = latbin + dlat
. // gen int lonbin2 = lonbin + dlon
. // drop _g dlat dlon
. //
. // save `site_bins', replace
. //
. // use `villcoords', clear
. // gen int latbin2 = floor(lat_v/`binsz')
. // gen int lonbin2 = floor(lon_v/`binsz')
. //
. // joinby latbin2 lonbin2 using `site_bins'
. // geodist lat_v lon_v lat_s lon_s, gen(dkm)
. // bys site_id (dkm): keep if _n==1
. //
. // keep site_id r101 r102 kab
. // save `site2kab', replace
. //
. // use `spbun_site', clear
. // merge 1:1 site_id using `site2kab', nogen keep(master match)
. // save `spbun_site_coded', replace
. 
. // * ----------------------------
. // * 5) Merge nearest-poverty with SURVIVAL (viability + MDI)
. // * ----------------------------
. // use `spbun_near', clear
. // merge 1:1 spbun_id using `surv', keep(match master) nogenerate
. // save `merged_final', replace
. //
. // * ----------------------------
. // * 6) High MDI definition (follow MDI.do if components exist; else use mdi_in)
. // *    Practical default:
. // *      - If mdi_in is already 1/2/3 (tercile), "high" = 3
. // *      - Else if continuous, "high" = top tercile by xtile
. // * ----------------------------
. // use `merged_final', clear
. //
. // capture assert inlist(mdi_in,1,2,3) if !missing(mdi_in)
. // if _rc==0 {
. //     gen byte high_mdi = (mdi_in==3) if !missing(mdi_in)
. //     label var high_mdi "High MDI (mdi_in==3)"
. // }
. // else {
. //     cap drop mdi_kl3 high_mdi
. //     xtile mdi_kl3 = mdi_in, nq(3)
. //     gen byte high_mdi = (mdi_kl3==3) if !missing(mdi_kl3)
. //     label var high_mdi "High MDI (top tercile of mdi_in)"
. // }
. //
. // * ----------------------------
. // * 7) Probability of "tidak layak" given high MDI and poverty
. // *    (no need to categorize poverty index)
. // * ----------------------------
. // keep if !missing(tidak_layak, high_mdi, lnpov_near)
. //
. // * Core logit: poverty + high MDI + interaction
. // logit tidak_layak c.lnpov_near##i.high_mdi, vce(robust)
. // estimates store M1
. //
. // * Predicted probability at representative poverty levels (p25, p50, p75) by MDI group
. // summ lnpov_near, detail
. // local p25 = r(p25)
. // local p50 = r(p50)
. // local p75 = r(p75)
. //
. // margins high_mdi, at(lnpov_near=(`p25' `p50' `p75')) post
. // estimates store Marg1
. //
. // * Simple empirical rates (sanity check): mean tidak_layak by high_mdi
. // bys high_mdi: summ tidak_layak
. //
. // * Export outputs
. // predict double phat_M1 if e(sample), pr
. // label var phat_M1 "Predicted P(tidak layak) from logit"
. //
. // save "$OUTDIR/spbun_nearestpoverty_viability.dta", replace
. // export delimited using "$OUTDIR/spbun_nearestpoverty_viability.csv", replace
. //
. // * Optional: compact regression table (requires esttab)
. // cap which esttab
. // if !_rc {
. //     esttab M1 using "$OUTDIR/logit_tidaklayak.rtf", replace ///
. //         b(%9.4f) se(%9.4f) star(* 0.10 ** 0.05 *** 0.01) ///
. //         stats(N ll, fmt(%9.0g %9.3f) labels("N" "LogLik")) ///
. //         title("Logit: P(SPBUN tidak layak) ~ poverty (nearest) x High MDI")
. // }
. //
. // di as txt "DONE. Outputs:"
. // di as txt "  $OUTDIR/spbun_nearestpoverty_viability.dta"
. // di as txt "  $OUTDIR/spbun_nearestpoverty_viability.csv"
. 
end of do-file

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. use `spbun_loc', clear

. // geonear spbun_id lat_spbun lon_spbun using `villages', ///
. //     n(1) ///
. //     near(iddesa lat_v lon_v) ///
. //     long ///
. //     miles(0)
. // rename nid nearest_iddesa
. // rename dist dist_km
. //
. // capture confirm variable lnpov
. // rename lnpov lnpov_near
. //
. // keep spbun_id lat_spbun lon_spbun nearest_iddesa dist_km lnpov_near
. // save `spbun_near', replace
. //
. //
. //
. // tempfile spbun_site_coded villcoords site_bins site2kab
. // local binsz = 0.10
. //
. // use `spbun_site', clear
. //
. // preserve
. //     use "$outdir/podes_vill.dta", clear
. //     keep iddesa kab r101 r102 lat_v lon_v
. //     drop if missing(lat_v) | missing(lon_v)
. //     save `villcoords', replace
. // restore
. //
. // drop if missing(lat_s) | missing(lon_s)
. //
. // gen int latbin = floor(lat_s/`binsz')
. // gen int lonbin = floor(lon_s/`binsz')
. //
. // expand 9
. // bys site_id: gen byte _g = _n - 1
. // gen int dlat = floor(_g/3) - 1
. // gen int dlon = mod(_g,3) - 1
. // gen int latbin2 = latbin + dlat
. // gen int lonbin2 = lonbin + dlon
. // drop _g dlat dlon
. //
. // save `site_bins', replace
. //
. // use `villcoords', clear
. // gen int latbin2 = floor(lat_v/`binsz')
. // gen int lonbin2 = floor(lon_v/`binsz')
. //
. // joinby latbin2 lonbin2 using `site_bins'
. // geodist lat_v lon_v lat_s lon_s, gen(dkm)
. // bys site_id (dkm): keep if _n==1
. //
. // keep site_id r101 r102 kab
. // save `site2kab', replace
. //
. // use `spbun_site', clear
. // merge 1:1 site_id using `site2kab', nogen keep(master match)
. // save `spbun_site_coded', replace
. 
. // * ----------------------------
. // * 5) Merge nearest-poverty with SURVIVAL (viability + MDI)
. // * ----------------------------
. // use `spbun_near', clear
. // merge 1:1 spbun_id using `surv', keep(match master) nogenerate
. // save `merged_final', replace
. //
. // * ----------------------------
. // * 6) High MDI definition (follow MDI.do if components exist; else use mdi_in)
. // *    Practical default:
. // *      - If mdi_in is already 1/2/3 (tercile), "high" = 3
. // *      - Else if continuous, "high" = top tercile by xtile
. // * ----------------------------
. // use `merged_final', clear
. //
. // capture assert inlist(mdi_in,1,2,3) if !missing(mdi_in)
. // if _rc==0 {
. //     gen byte high_mdi = (mdi_in==3) if !missing(mdi_in)
. //     label var high_mdi "High MDI (mdi_in==3)"
. // }
. // else {
. //     cap drop mdi_kl3 high_mdi
. //     xtile mdi_kl3 = mdi_in, nq(3)
. //     gen byte high_mdi = (mdi_kl3==3) if !missing(mdi_kl3)
. //     label var high_mdi "High MDI (top tercile of mdi_in)"
. // }
. //
. // * ----------------------------
. // * 7) Probability of "tidak layak" given high MDI and poverty
. // *    (no need to categorize poverty index)
. // * ----------------------------
. // keep if !missing(tidak_layak, high_mdi, lnpov_near)
. //
. // * Core logit: poverty + high MDI + interaction
. // logit tidak_layak c.lnpov_near##i.high_mdi, vce(robust)
. // estimates store M1
. //
. // * Predicted probability at representative poverty levels (p25, p50, p75) by MDI group
. // summ lnpov_near, detail
. // local p25 = r(p25)
. // local p50 = r(p50)
. // local p75 = r(p75)
. //
. // margins high_mdi, at(lnpov_near=(`p25' `p50' `p75')) post
. // estimates store Marg1
. //
. // * Simple empirical rates (sanity check): mean tidak_layak by high_mdi
. // bys high_mdi: summ tidak_layak
. //
. // * Export outputs
. // predict double phat_M1 if e(sample), pr
. // label var phat_M1 "Predicted P(tidak layak) from logit"
. //
. // save "$OUTDIR/spbun_nearestpoverty_viability.dta", replace
. // export delimited using "$OUTDIR/spbun_nearestpoverty_viability.csv", replace
. //
. // * Optional: compact regression table (requires esttab)
. // cap which esttab
. // if !_rc {
. //     esttab M1 using "$OUTDIR/logit_tidaklayak.rtf", replace ///
. //         b(%9.4f) se(%9.4f) star(* 0.10 ** 0.05 *** 0.01) ///
. //         stats(N ll, fmt(%9.0g %9.3f) labels("N" "LogLik")) ///
. //         title("Logit: P(SPBUN tidak layak) ~ poverty (nearest) x High MDI")
. // }
. //
. // di as txt "DONE. Outputs:"
. // di as txt "  $OUTDIR/spbun_nearestpoverty_viability.dta"
. // di as txt "  $OUTDIR/spbun_nearestpoverty_viability.csv"
. 
end of do-file

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. use `spbun_loc', clear

. geonear spbun_id lat_spbun lon_spbun using `villages', ///
>     n(1) ///
>     near(iddesa lat_v lon_v) ///
>     long ///
>     miles(0)
variable spbun_id not found
r(111);

end of do-file

r(111);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. use `spbun_loc', clear

. geonear site_id lat_spbun lon_spbun using `villages', ///
>     n(1) ///
>     near(iddesa lat_v lon_v) ///
>     long ///
>     miles(0)
variable lat_spbun not found
r(111);

end of do-file

r(111);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. use `spbun_loc', clear

. geonear site_id lat_s lon_s using `villages', ///
>     n(1) ///
>     near(iddesa lat_v lon_v) ///
>     long ///
>     miles(0)
1 invalid name
r(198);

end of do-file

r(198);

. do "/var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//SD00943.000000"

. capture confirm variable lnpov

. rename lnpov lnpov_near
variable lnpov not found
r(111);

end of do-file

r(111);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. // cap which geonear
. // use `spbun_loc', clear
. // geonear site_id lat_s lon_s using `villages', ///
. //     n(1) ///
. //     near(iddesa lat_v lon_v) ///
. //     long ///
. //     miles(0)
. // rename nid nearest_iddesa
. // rename dist dist_km
. //
. // capture confirm variable lnpov
. // rename lnpov lnpov_near
. //
. // keep site_id lat_s lon_s nearest_iddesa dist_km lnpov_near
. // save `spbun_near', replace
. 
. tempfile spbun_site_coded villcoords site_bins site2kab

. local binsz = 0.10

. 
. use `spbun_loc', clear

. 
. preserve

.     use "$outdir/podes_vill.dta", clear

.     keep iddesa kab r101 r102 lat_v lon_v

.     drop if missing(lat_v) | missing(lon_v)
(0 observations deleted)

.     save `villcoords', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. restore

. 
. drop if missing(lat_s) | missing(lon_s)
(0 observations deleted)

. 
. gen int latbin = floor(lat_s/`binsz')

. gen int lonbin = floor(lon_s/`binsz')

. 
. expand 9
(3,000 observations created)

. bys site_id: gen byte _g = _n - 1

. gen int dlat = floor(_g/3) - 1

. gen int dlon = mod(_g,3) - 1

. gen int latbin2 = latbin + dlat

. gen int lonbin2 = lonbin + dlon

. drop _g dlat dlon

. 
. save `site_bins', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000009 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000009 saved as .dta format

. 
. use `villcoords', clear

. gen int latbin2 = floor(lat_v/`binsz')

. gen int lonbin2 = floor(lon_v/`binsz')

. 
. joinby latbin2 lonbin2 using `site_bins'

. geodist lat_v lon_v lat_s lon_s, gen(dkm)

. bys site_id (dkm): keep if _n==1
(31,828 observations deleted)

. 
. keep site_id r101 r102 kab

. save `site2kab', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.00000a not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.00000a saved as .dta format

. 
. use `spbun_loc', clear

. merge 1:1 site_id using `site2kab', nogen keep(master match)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             1
        from master                         1  
        from using                          0  

    Matched                               374  
    -----------------------------------------

. save `spbun_site_coded', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 saved as .dta format

. 
. // * ----------------------------
. // * 5) Merge nearest-poverty with SURVIVAL (viability + MDI)
. // * ----------------------------
. // use `spbun_near', clear
. // merge 1:1 spbun_id using `surv', keep(match master) nogenerate
. // save `merged_final', replace
. //
. // * ----------------------------
. // * 6) High MDI definition (follow MDI.do if components exist; else use mdi_in)
. // *    Practical default:
. // *      - If mdi_in is already 1/2/3 (tercile), "high" = 3
. // *      - Else if continuous, "high" = top tercile by xtile
. // * ----------------------------
. // use `merged_final', clear
. //
. // capture assert inlist(mdi_in,1,2,3) if !missing(mdi_in)
. // if _rc==0 {
. //     gen byte high_mdi = (mdi_in==3) if !missing(mdi_in)
. //     label var high_mdi "High MDI (mdi_in==3)"
. // }
. // else {
. //     cap drop mdi_kl3 high_mdi
. //     xtile mdi_kl3 = mdi_in, nq(3)
. //     gen byte high_mdi = (mdi_kl3==3) if !missing(mdi_kl3)
. //     label var high_mdi "High MDI (top tercile of mdi_in)"
. // }
. //
. // * ----------------------------
. // * 7) Probability of "tidak layak" given high MDI and poverty
. // *    (no need to categorize poverty index)
. // * ----------------------------
. // keep if !missing(tidak_layak, high_mdi, lnpov_near)
. //
. // * Core logit: poverty + high MDI + interaction
. // logit tidak_layak c.lnpov_near##i.high_mdi, vce(robust)
. // estimates store M1
. //
. // * Predicted probability at representative poverty levels (p25, p50, p75) by MDI group
. // summ lnpov_near, detail
. // local p25 = r(p25)
. // local p50 = r(p50)
. // local p75 = r(p75)
. //
. // margins high_mdi, at(lnpov_near=(`p25' `p50' `p75')) post
. // estimates store Marg1
. //
. // * Simple empirical rates (sanity check): mean tidak_layak by high_mdi
. // bys high_mdi: summ tidak_layak
. //
. // * Export outputs
. // predict double phat_M1 if e(sample), pr
. // label var phat_M1 "Predicted P(tidak layak) from logit"
. //
. // save "$OUTDIR/spbun_nearestpoverty_viability.dta", replace
. // export delimited using "$OUTDIR/spbun_nearestpoverty_viability.csv", replace
. //
. // * Optional: compact regression table (requires esttab)
. // cap which esttab
. // if !_rc {
. //     esttab M1 using "$OUTDIR/logit_tidaklayak.rtf", replace ///
. //         b(%9.4f) se(%9.4f) star(* 0.10 ** 0.05 *** 0.01) ///
. //         stats(N ll, fmt(%9.0g %9.3f) labels("N" "LogLik")) ///
. //         title("Logit: P(SPBUN tidak layak) ~ poverty (nearest) x High MDI")
. // }
. //
. // di as txt "DONE. Outputs:"
. // di as txt "  $OUTDIR/spbun_nearestpoverty_viability.dta"
. // di as txt "  $OUTDIR/spbun_nearestpoverty_viability.csv"
. 
end of do-file

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. // cap which geonear
. // use `spbun_loc', clear
. // geonear site_id lat_s lon_s using `villages', ///
. //     n(1) ///
. //     near(iddesa lat_v lon_v) ///
. //     long ///
. //     miles(0)
. // rename nid nearest_iddesa
. // rename dist dist_km
. //
. // capture confirm variable lnpov
. // rename lnpov lnpov_near
. //
. // keep site_id lat_s lon_s nearest_iddesa dist_km lnpov_near
. // save `spbun_near', replace
. 
. cap which geonear

. 
. tempfile spbun_site_coded villcoords site_bins site2kab

. local binsz = 0.10

. 
. use `spbun_loc', clear

. 
. preserve

.     use "$outdir/podes_vill.dta", clear

.     keep iddesa kab r101 r102 lat_v lon_v

.     drop if missing(lat_v) | missing(lon_v)
(0 observations deleted)

.     save `villcoords', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. restore

. 
. drop if missing(lat_s) | missing(lon_s)
(0 observations deleted)

. 
. gen int latbin = floor(lat_s/`binsz')

. gen int lonbin = floor(lon_s/`binsz')

. 
. expand 9
(3,000 observations created)

. bys site_id: gen byte _g = _n - 1

. gen int dlat = floor(_g/3) - 1

. gen int dlon = mod(_g,3) - 1

. gen int latbin2 = latbin + dlat

. gen int lonbin2 = lonbin + dlon

. drop _g dlat dlon

. 
. save `site_bins', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000009 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000009 saved as .dta format

. 
. use `villcoords', clear

. gen int latbin2 = floor(lat_v/`binsz')

. gen int lonbin2 = floor(lon_v/`binsz')

. 
. joinby latbin2 lonbin2 using `site_bins'

. geodist lat_v lon_v lat_s lon_s, gen(dkm)

. bys site_id (dkm): keep if _n==1
(31,828 observations deleted)

. 
. keep site_id r101 r102 kab

. save `site2kab', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.00000a not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.00000a saved as .dta format

. 
. use `spbun_loc', clear

. merge 1:1 site_id using `site2kab', nogen keep(master match)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             1
        from master                         1  
        from using                          0  

    Matched                               374  
    -----------------------------------------

. save `spbun_site_coded', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     n(1) ///
>     near(iddesa lat_v lon_v) ///
>     long ///
>     miles(0)
1 invalid name
r(198);

end of do-file

r(198);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. // cap which geonear
. // use `spbun_loc', clear
. // geonear site_id lat_s lon_s using `villages', ///
. //     n(1) ///
. //     near(iddesa lat_v lon_v) ///
. //     long ///
. //     miles(0)
. // rename nid nearest_iddesa
. // rename dist dist_km
. //
. // capture confirm variable lnpov
. // rename lnpov lnpov_near
. //
. // keep site_id lat_s lon_s nearest_iddesa dist_km lnpov_near
. // save `spbun_near', replace
. 
. cap which geonear

. 
. tempfile spbun_site_coded villcoords site_bins site2kab

. local binsz = 0.10

. 
. use `spbun_loc', clear

. 
. preserve

.     use "$outdir/podes_vill.dta", clear

.     keep iddesa kab r101 r102 lat_v lon_v

.     drop if missing(lat_v) | missing(lon_v)
(0 observations deleted)

.     save `villcoords', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. restore

. 
. drop if missing(lat_s) | missing(lon_s)
(0 observations deleted)

. 
. gen int latbin = floor(lat_s/`binsz')

. gen int lonbin = floor(lon_s/`binsz')

. 
. expand 9
(3,000 observations created)

. bys site_id: gen byte _g = _n - 1

. gen int dlat = floor(_g/3) - 1

. gen int dlon = mod(_g,3) - 1

. gen int latbin2 = latbin + dlat

. gen int lonbin2 = lonbin + dlon

. drop _g dlat dlon

. 
. save `site_bins', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000009 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000009 saved as .dta format

. 
. use `villcoords', clear

. gen int latbin2 = floor(lat_v/`binsz')

. gen int lonbin2 = floor(lon_v/`binsz')

. 
. joinby latbin2 lonbin2 using `site_bins'

. geodist lat_v lon_v lat_s lon_s, gen(dkm)

. bys site_id (dkm): keep if _n==1
(31,828 observations deleted)

. 
. keep site_id r101 r102 kab

. save `site2kab', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.00000a not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.00000a saved as .dta format

. 
. use `spbun_loc', clear

. merge 1:1 site_id using `site2kab', nogen keep(master match)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             1
        from master                         1  
        from using                          0  

    Matched                               374  
    -----------------------------------------

. save `spbun_site_coded', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     n(1) ///
>     near(iddesa lat_v lon_v) ///
>     long ///
>     miles(0)
1 invalid name
r(198);

end of do-file

r(198);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. // cap which geonear
. // use `spbun_loc', clear
. // geonear site_id lat_s lon_s using `villages', ///
. //     n(1) ///
. //     near(iddesa lat_v lon_v) ///
. //     long ///
. //     miles(0)
. // rename nid nearest_iddesa
. // rename dist dist_km
. //
. // capture confirm variable lnpov
. // rename lnpov lnpov_near
. //
. // keep site_id lat_s lon_s nearest_iddesa dist_km lnpov_near
. // save `spbun_near', replace
. 
. cap which geonear

. 
. tempfile spbun_site_coded villcoords site_bins site2kab

. local binsz = 0.10

. 
. use `spbun_loc', clear

. 
. preserve

.     use "$outdir/podes_vill.dta", clear

.     keep iddesa kab r101 r102 lat_v lon_v

.     drop if missing(lat_v) | missing(lon_v)
(0 observations deleted)

.     save `villcoords', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. restore

. 
. drop if missing(lat_s) | missing(lon_s)
(0 observations deleted)

. 
. gen int latbin = floor(lat_s/`binsz')

. gen int lonbin = floor(lon_s/`binsz')

. 
. expand 9
(3,000 observations created)

. bys site_id: gen byte _g = _n - 1

. gen int dlat = floor(_g/3) - 1

. gen int dlon = mod(_g,3) - 1

. gen int latbin2 = latbin + dlat

. gen int lonbin2 = lonbin + dlon

. drop _g dlat dlon

. 
. save `site_bins', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000009 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000009 saved as .dta format

. 
. use `villcoords', clear

. gen int latbin2 = floor(lat_v/`binsz')

. gen int lonbin2 = floor(lon_v/`binsz')

. 
. joinby latbin2 lonbin2 using `site_bins'

. geodist lat_v lon_v lat_s lon_s, gen(dkm)

. bys site_id (dkm): keep if _n==1
(31,828 observations deleted)

. 
. keep site_id r101 r102 kab

. save `site2kab', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.00000a not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.00000a saved as .dta format

. 
. use `spbun_loc', clear

. merge 1:1 site_id using `site2kab', nogen keep(master match)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             1
        from master                         1  
        from using                          0  

    Matched                               374  
    -----------------------------------------

. save `spbun_site_coded', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     n(1) ///
>     near(iddesa lat_v lon_v) ///
>     long ///
>     miles(0)
1 invalid name
r(198);

end of do-file

r(198);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. // cap which geonear
. // use `spbun_loc', clear
. // geonear site_id lat_s lon_s using `villages', ///
. //     n(1) ///
. //     near(iddesa lat_v lon_v) ///
. //     long ///
. //     miles(0)
. // rename nid nearest_iddesa
. // rename dist dist_km
. //
. // capture confirm variable lnpov
. // rename lnpov lnpov_near
. //
. // keep site_id lat_s lon_s nearest_iddesa dist_km lnpov_near
. // save `spbun_near', replace
. 
. cap which geonear

. 
. tempfile spbun_site_coded villcoords site_bins site2kab

. local binsz = 0.10

. 
. use `spbun_loc', clear

. 
. preserve

.     use "$outdir/podes_vill.dta", clear

.     keep iddesa kab r101 r102 lat_v lon_v

.     drop if missing(lat_v) | missing(lon_v)
(0 observations deleted)

.     save `villcoords', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. restore

. 
. drop if missing(lat_s) | missing(lon_s)
(0 observations deleted)

. 
. gen int latbin = floor(lat_s/`binsz')

. gen int lonbin = floor(lon_s/`binsz')

. 
. expand 9
(3,000 observations created)

. bys site_id: gen byte _g = _n - 1

. gen int dlat = floor(_g/3) - 1

. gen int dlon = mod(_g,3) - 1

. gen int latbin2 = latbin + dlat

. gen int lonbin2 = lonbin + dlon

. drop _g dlat dlon

. 
. save `site_bins', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000009 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000009 saved as .dta format

. 
. use `villcoords', clear

. gen int latbin2 = floor(lat_v/`binsz')

. gen int lonbin2 = floor(lon_v/`binsz')

. 
. joinby latbin2 lonbin2 using `site_bins'

. geodist lat_v lon_v lat_s lon_s, gen(dkm)

. bys site_id (dkm): keep if _n==1
(31,828 observations deleted)

. 
. keep site_id r101 r102 kab

. save `site2kab', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.00000a not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.00000a saved as .dta format

. 
. use `spbun_loc', clear

. merge 1:1 site_id using `site2kab', nogen keep(master match)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             1
        from master                         1  
        from using                          0  

    Matched                               374  
    -----------------------------------------

. save `spbun_site_coded', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     n(1) ///
>     near(iddesa lat_s lon_s) ///
>     long ///
>     miles(0)
1 invalid name
r(198);

end of do-file

r(198);

. geonear help
variable help not found
r(111);

. help geonear

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. 
. tempfile spbun_site_coded villcoords site_bins site2kab

. local binsz = 0.10

. 
. use `spbun_loc', clear

. 
. preserve

.     use "$outdir/podes_vill.dta", clear

.     keep iddesa kab r101 r102 lat_v lon_v

.     drop if missing(lat_v) | missing(lon_v)
(0 observations deleted)

.     save `villcoords', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. restore

. 
. drop if missing(lat_s) | missing(lon_s)
(0 observations deleted)

. 
. gen int latbin = floor(lat_s/`binsz')

. gen int lonbin = floor(lon_s/`binsz')

. 
. expand 9
(3,000 observations created)

. bys site_id: gen byte _g = _n - 1

. gen int dlat = floor(_g/3) - 1

. gen int dlon = mod(_g,3) - 1

. gen int latbin2 = latbin + dlat

. gen int lonbin2 = lonbin + dlon

. drop _g dlat dlon

. 
. save `site_bins', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000009 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000009 saved as .dta format

. 
. use `villcoords', clear

. gen int latbin2 = floor(lat_v/`binsz')

. gen int lonbin2 = floor(lon_v/`binsz')

. 
. joinby latbin2 lonbin2 using `site_bins'

. geodist lat_v lon_v lat_s lon_s, gen(dkm)

. bys site_id (dkm): keep if _n==1
(31,828 observations deleted)

. 
. keep site_id r101 r102 kab

. save `site2kab', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.00000a not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.00000a saved as .dta format

. 
. use `spbun_loc', clear

. merge 1:1 site_id using `site2kab', nogen keep(master match)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             1
        from master                         1  
        from using                          0  

    Matched                               374  
    -----------------------------------------

. save `spbun_site_coded', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 saved as .dta format

. 
. // geonear site_id lat_s lon_s using `villages', ///
. //     n(1) ///
. //     near(iddesa lat_v lon_v) ///
. //     long ///
. //     miles(0)
. 
. // rename nid nearest_iddesa
. // rename dist dist_km
. //
. // capture confirm variable lnpov
. // rename lnpov lnpov_near
. //
. // keep spbun_id lat_spbun lon_spbun nearest_iddesa dist_km lnpov_near
. // save `spbun_near', replace
. 
. // * ----------------------------
. // * 5) Merge nearest-poverty with SURVIVAL (viability + MDI)
. // * ----------------------------
. // use `spbun_near', clear
. // merge 1:1 spbun_id using `surv', keep(match master) nogenerate
. // save `merged_final', replace
. //
. // * ----------------------------
. // * 6) High MDI definition (follow MDI.do if components exist; else use mdi_in)
. // *    Practical default:
. // *      - If mdi_in is already 1/2/3 (tercile), "high" = 3
. // *      - Else if continuous, "high" = top tercile by xtile
. // * ----------------------------
. // use `merged_final', clear
. //
. // capture assert inlist(mdi_in,1,2,3) if !missing(mdi_in)
. // if _rc==0 {
. //     gen byte high_mdi = (mdi_in==3) if !missing(mdi_in)
. //     label var high_mdi "High MDI (mdi_in==3)"
. // }
. // else {
. //     cap drop mdi_kl3 high_mdi
. //     xtile mdi_kl3 = mdi_in, nq(3)
. //     gen byte high_mdi = (mdi_kl3==3) if !missing(mdi_kl3)
. //     label var high_mdi "High MDI (top tercile of mdi_in)"
. // }
. //
. // * ----------------------------
. // * 7) Probability of "tidak layak" given high MDI and poverty
. // *    (no need to categorize poverty index)
. // * ----------------------------
. // keep if !missing(tidak_layak, high_mdi, lnpov_near)
. //
. // * Core logit: poverty + high MDI + interaction
. // logit tidak_layak c.lnpov_near##i.high_mdi, vce(robust)
. // estimates store M1
. //
. // * Predicted probability at representative poverty levels (p25, p50, p75) by MDI group
. // summ lnpov_near, detail
. // local p25 = r(p25)
. // local p50 = r(p50)
. // local p75 = r(p75)
. //
. // margins high_mdi, at(lnpov_near=(`p25' `p50' `p75')) post
. // estimates store Marg1
. //
. // * Simple empirical rates (sanity check): mean tidak_layak by high_mdi
. // bys high_mdi: summ tidak_layak
. //
. // * Export outputs
. // predict double phat_M1 if e(sample), pr
. // label var phat_M1 "Predicted P(tidak layak) from logit"
. //
. // save "$OUTDIR/spbun_nearestpoverty_viability.dta", replace
. // export delimited using "$OUTDIR/spbun_nearestpoverty_viability.csv", replace
. //
. // * Optional: compact regression table (requires esttab)
. // cap which esttab
. // if !_rc {
. //     esttab M1 using "$OUTDIR/logit_tidaklayak.rtf", replace ///
. //         b(%9.4f) se(%9.4f) star(* 0.10 ** 0.05 *** 0.01) ///
. //         stats(N ll, fmt(%9.0g %9.3f) labels("N" "LogLik")) ///
. //         title("Logit: P(SPBUN tidak layak) ~ poverty (nearest) x High MDI")
. // }
. //
. // di as txt "DONE. Outputs:"
. // di as txt "  $OUTDIR/spbun_nearestpoverty_viability.dta"
. // di as txt "  $OUTDIR/spbun_nearestpoverty_viability.csv"
. 
end of do-file

. do "/var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//SD00943.000000"

. // geonear site_id lat_s lon_s using 
. //
. // rename nid nearest_iddesa
. // rename dist dist_km
. //
. // capture confirm variable lnpov
. // rename lnpov lnpov_near
. //
. // keep spbun_id lat_spbun lon_spbun nearest_iddesa dist_km lnpov_near
. // save `spbun_near', replace
. 
end of do-file

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. // tempfile spbun_site_coded villcoords site_bins site2kab
. // local binsz = 0.10
. //
. // use `spbun_loc', clear
. //
. // preserve
. //     use "$outdir/podes_vill.dta", clear
. //     keep iddesa kab r101 r102 lat_v lon_v
. //     drop if missing(lat_v) | missing(lon_v)
. //     save `villcoords', replace
. // restore
. //
. // drop if missing(lat_s) | missing(lon_s)
. //
. // gen int latbin = floor(lat_s/`binsz')
. // gen int lonbin = floor(lon_s/`binsz')
. //
. // expand 9
. // bys site_id: gen byte _g = _n - 1
. // gen int dlat = floor(_g/3) - 1
. // gen int dlon = mod(_g,3) - 1
. // gen int latbin2 = latbin + dlat
. // gen int lonbin2 = lonbin + dlon
. // drop _g dlat dlon
. //
. // save `site_bins', replace
. //
. // use `villcoords', clear
. // gen int latbin2 = floor(lat_v/`binsz')
. // gen int lonbin2 = floor(lon_v/`binsz')
. //
. // joinby latbin2 lonbin2 using `site_bins'
. // geodist lat_v lon_v lat_s lon_s, gen(dkm)
. // bys site_id (dkm): keep if _n==1
. //
. // keep site_id r101 r102 kab
. // save `site2kab', replace
. //
. // use `spbun_loc', clear
. // merge 1:1 site_id using `site2kab', nogen keep(master match)
. // save `spbun_site_coded', replace
. 
. cap which geonear

. use `spbun_loc', clear

. // geonear site_id lat_s lon_s using 
. //
. // rename nid nearest_iddesa
. // rename dist dist_km
. //
. // capture confirm variable lnpov
. // rename lnpov lnpov_near
. //
. // keep spbun_id lat_spbun lon_spbun nearest_iddesa dist_km lnpov_near
. // save `spbun_near', replace
. 
. // * ----------------------------
. // * 5) Merge nearest-poverty with SURVIVAL (viability + MDI)
. // * ----------------------------
. // use `spbun_near', clear
. // merge 1:1 spbun_id using `surv', keep(match master) nogenerate
. // save `merged_final', replace
. //
. // * ----------------------------
. // * 6) High MDI definition (follow MDI.do if components exist; else use mdi_in)
. // *    Practical default:
. // *      - If mdi_in is already 1/2/3 (tercile), "high" = 3
. // *      - Else if continuous, "high" = top tercile by xtile
. // * ----------------------------
. // use `merged_final', clear
. //
. // capture assert inlist(mdi_in,1,2,3) if !missing(mdi_in)
. // if _rc==0 {
. //     gen byte high_mdi = (mdi_in==3) if !missing(mdi_in)
. //     label var high_mdi "High MDI (mdi_in==3)"
. // }
. // else {
. //     cap drop mdi_kl3 high_mdi
. //     xtile mdi_kl3 = mdi_in, nq(3)
. //     gen byte high_mdi = (mdi_kl3==3) if !missing(mdi_kl3)
. //     label var high_mdi "High MDI (top tercile of mdi_in)"
. // }
. //
. // * ----------------------------
. // * 7) Probability of "tidak layak" given high MDI and poverty
. // *    (no need to categorize poverty index)
. // * ----------------------------
. // keep if !missing(tidak_layak, high_mdi, lnpov_near)
. //
. // * Core logit: poverty + high MDI + interaction
. // logit tidak_layak c.lnpov_near##i.high_mdi, vce(robust)
. // estimates store M1
. //
. // * Predicted probability at representative poverty levels (p25, p50, p75) by MDI group
. // summ lnpov_near, detail
. // local p25 = r(p25)
. // local p50 = r(p50)
. // local p75 = r(p75)
. //
. // margins high_mdi, at(lnpov_near=(`p25' `p50' `p75')) post
. // estimates store Marg1
. //
. // * Simple empirical rates (sanity check): mean tidak_layak by high_mdi
. // bys high_mdi: summ tidak_layak
. //
. // * Export outputs
. // predict double phat_M1 if e(sample), pr
. // label var phat_M1 "Predicted P(tidak layak) from logit"
. //
. // save "$OUTDIR/spbun_nearestpoverty_viability.dta", replace
. // export delimited using "$OUTDIR/spbun_nearestpoverty_viability.csv", replace
. //
. // * Optional: compact regression table (requires esttab)
. // cap which esttab
. // if !_rc {
. //     esttab M1 using "$OUTDIR/logit_tidaklayak.rtf", replace ///
. //         b(%9.4f) se(%9.4f) star(* 0.10 ** 0.05 *** 0.01) ///
. //         stats(N ll, fmt(%9.0g %9.3f) labels("N" "LogLik")) ///
. //         title("Logit: P(SPBUN tidak layak) ~ poverty (nearest) x High MDI")
. // }
. //
. // di as txt "DONE. Outputs:"
. // di as txt "  $OUTDIR/spbun_nearestpoverty_viability.dta"
. // di as txt "  $OUTDIR/spbun_nearestpoverty_viability.csv"
. 
end of do-file

. help geonear

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. // tempfile spbun_site_coded villcoords site_bins site2kab
. // local binsz = 0.10
. //
. // use `spbun_loc', clear
. //
. // preserve
. //     use "$outdir/podes_vill.dta", clear
. //     keep iddesa kab r101 r102 lat_v lon_v
. //     drop if missing(lat_v) | missing(lon_v)
. //     save `villcoords', replace
. // restore
. //
. // drop if missing(lat_s) | missing(lon_s)
. //
. // gen int latbin = floor(lat_s/`binsz')
. // gen int lonbin = floor(lon_s/`binsz')
. //
. // expand 9
. // bys site_id: gen byte _g = _n - 1
. // gen int dlat = floor(_g/3) - 1
. // gen int dlon = mod(_g,3) - 1
. // gen int latbin2 = latbin + dlat
. // gen int lonbin2 = lonbin + dlon
. // drop _g dlat dlon
. //
. // save `site_bins', replace
. //
. // use `villcoords', clear
. // gen int latbin2 = floor(lat_v/`binsz')
. // gen int lonbin2 = floor(lon_v/`binsz')
. //
. // joinby latbin2 lonbin2 using `site_bins'
. // geodist lat_v lon_v lat_s lon_s, gen(dkm)
. // bys site_id (dkm): keep if _n==1
. //
. // keep site_id r101 r102 kab
. // save `site2kab', replace
. //
. // use `spbun_loc', clear
. // merge 1:1 site_id using `site2kab', nogen keep(master match)
. // save `spbun_site_coded', replace
. 
. cap which geonear

. // use `spbun_loc', clear
. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) ///
>     nearcount(1)
variable site_id not found
r(111);

end of do-file

r(111);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. // tempfile spbun_site_coded villcoords site_bins site2kab
. // local binsz = 0.10
. //
. // use `spbun_loc', clear
. //
. // preserve
. //     use "$outdir/podes_vill.dta", clear
. //     keep iddesa kab r101 r102 lat_v lon_v
. //     drop if missing(lat_v) | missing(lon_v)
. //     save `villcoords', replace
. // restore
. //
. // drop if missing(lat_s) | missing(lon_s)
. //
. // gen int latbin = floor(lat_s/`binsz')
. // gen int lonbin = floor(lon_s/`binsz')
. //
. // expand 9
. // bys site_id: gen byte _g = _n - 1
. // gen int dlat = floor(_g/3) - 1
. // gen int dlon = mod(_g,3) - 1
. // gen int latbin2 = latbin + dlat
. // gen int lonbin2 = lonbin + dlon
. // drop _g dlat dlon
. //
. // save `site_bins', replace
. //
. // use `villcoords', clear
. // gen int latbin2 = floor(lat_v/`binsz')
. // gen int lonbin2 = floor(lon_v/`binsz')
. //
. // joinby latbin2 lonbin2 using `site_bins'
. // geodist lat_v lon_v lat_s lon_s, gen(dkm)
. // bys site_id (dkm): keep if _n==1
. //
. // keep site_id r101 r102 kab
. // save `site2kab', replace
. //
. // use `spbun_loc', clear
. // merge 1:1 site_id using `site2kab', nogen keep(master match)
. // save `spbun_site_coded', replace
. 
. cap which geonear

. use `spbun_loc', clear

. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) ///
>     nearcount(1)
base latitude var lat_s must be between -90 and 90
r(198);

end of do-file

r(198);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. // tempfile spbun_site_coded villcoords site_bins site2kab
. // local binsz = 0.10
. //
. // use `spbun_loc', clear
. //
. // preserve
. //     use "$outdir/podes_vill.dta", clear
. //     keep iddesa kab r101 r102 lat_v lon_v
. //     drop if missing(lat_v) | missing(lon_v)
. //     save `villcoords', replace
. // restore
. //
. // drop if missing(lat_s) | missing(lon_s)
. //
. // gen int latbin = floor(lat_s/`binsz')
. // gen int lonbin = floor(lon_s/`binsz')
. //
. // expand 9
. // bys site_id: gen byte _g = _n - 1
. // gen int dlat = floor(_g/3) - 1
. // gen int dlon = mod(_g,3) - 1
. // gen int latbin2 = latbin + dlat
. // gen int lonbin2 = lonbin + dlon
. // drop _g dlat dlon
. //
. // save `site_bins', replace
. //
. // use `villcoords', clear
. // gen int latbin2 = floor(lat_v/`binsz')
. // gen int lonbin2 = floor(lon_v/`binsz')
. //
. // joinby latbin2 lonbin2 using `site_bins'
. // geodist lat_v lon_v lat_s lon_s, gen(dkm)
. // bys site_id (dkm): keep if _n==1
. //
. // keep site_id r101 r102 kab
. // save `site2kab', replace
. //
. // use `spbun_loc', clear
. // merge 1:1 site_id using `site2kab', nogen keep(master match)
. // save `spbun_site_coded', replace
. 
. cap which geonear

. use `spbun_loc', clear

. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide genstub(vil)esa lat_v lon_v) ///
>     nearcount(1)
option esa not allowed
r(198);

end of do-file

r(198);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. // tempfile spbun_site_coded villcoords site_bins site2kab
. // local binsz = 0.10
. //
. // use `spbun_loc', clear
. //
. // preserve
. //     use "$outdir/podes_vill.dta", clear
. //     keep iddesa kab r101 r102 lat_v lon_v
. //     drop if missing(lat_v) | missing(lon_v)
. //     save `villcoords', replace
. // restore
. //
. // drop if missing(lat_s) | missing(lon_s)
. //
. // gen int latbin = floor(lat_s/`binsz')
. // gen int lonbin = floor(lon_s/`binsz')
. //
. // expand 9
. // bys site_id: gen byte _g = _n - 1
. // gen int dlat = floor(_g/3) - 1
. // gen int dlon = mod(_g,3) - 1
. // gen int latbin2 = latbin + dlat
. // gen int lonbin2 = lonbin + dlon
. // drop _g dlat dlon
. //
. // save `site_bins', replace
. //
. // use `villcoords', clear
. // gen int latbin2 = floor(lat_v/`binsz')
. // gen int lonbin2 = floor(lon_v/`binsz')
. //
. // joinby latbin2 lonbin2 using `site_bins'
. // geodist lat_v lon_v lat_s lon_s, gen(dkm)
. // bys site_id (dkm): keep if _n==1
. //
. // keep site_id r101 r102 kab
. // save `site2kab', replace
. //
. // use `spbun_loc', clear
. // merge 1:1 site_id using `site2kab', nogen keep(master match)
. // save `spbun_site_coded', replace
. 
. cap which geonear

. use `spbun_loc', clear

. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide genstub(vil) lat_v lon_v) ///
>     nearcount(1)
option lat_v not allowed
r(198);

end of do-file

r(198);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. // tempfile spbun_site_coded villcoords site_bins site2kab
. // local binsz = 0.10
. //
. // use `spbun_loc', clear
. //
. // preserve
. //     use "$outdir/podes_vill.dta", clear
. //     keep iddesa kab r101 r102 lat_v lon_v
. //     drop if missing(lat_v) | missing(lon_v)
. //     save `villcoords', replace
. // restore
. //
. // drop if missing(lat_s) | missing(lon_s)
. //
. // gen int latbin = floor(lat_s/`binsz')
. // gen int lonbin = floor(lon_s/`binsz')
. //
. // expand 9
. // bys site_id: gen byte _g = _n - 1
. // gen int dlat = floor(_g/3) - 1
. // gen int dlon = mod(_g,3) - 1
. // gen int latbin2 = latbin + dlat
. // gen int lonbin2 = lonbin + dlon
. // drop _g dlat dlon
. //
. // save `site_bins', replace
. //
. // use `villcoords', clear
. // gen int latbin2 = floor(lat_v/`binsz')
. // gen int lonbin2 = floor(lon_v/`binsz')
. //
. // joinby latbin2 lonbin2 using `site_bins'
. // geodist lat_v lon_v lat_s lon_s, gen(dkm)
. // bys site_id (dkm): keep if _n==1
. //
. // keep site_id r101 r102 kab
. // save `site2kab', replace
. //
. // use `spbun_loc', clear
. // merge 1:1 site_id using `site2kab', nogen keep(master match)
. // save `spbun_site_coded', replace
. 
. cap which geonear

. use `spbun_loc', clear

. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide ///
>     nearcount(1)
option nearcount() not allowed
r(198);

end of do-file

r(198);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. // tempfile spbun_site_coded villcoords site_bins site2kab
. // local binsz = 0.10
. //
. // use `spbun_loc', clear
. //
. // preserve
. //     use "$outdir/podes_vill.dta", clear
. //     keep iddesa kab r101 r102 lat_v lon_v
. //     drop if missing(lat_v) | missing(lon_v)
. //     save `villcoords', replace
. // restore
. //
. // drop if missing(lat_s) | missing(lon_s)
. //
. // gen int latbin = floor(lat_s/`binsz')
. // gen int lonbin = floor(lon_s/`binsz')
. //
. // expand 9
. // bys site_id: gen byte _g = _n - 1
. // gen int dlat = floor(_g/3) - 1
. // gen int dlon = mod(_g,3) - 1
. // gen int latbin2 = latbin + dlat
. // gen int lonbin2 = lonbin + dlon
. // drop _g dlat dlon
. //
. // save `site_bins', replace
. //
. // use `villcoords', clear
. // gen int latbin2 = floor(lat_v/`binsz')
. // gen int lonbin2 = floor(lon_v/`binsz')
. //
. // joinby latbin2 lonbin2 using `site_bins'
. // geodist lat_v lon_v lat_s lon_s, gen(dkm)
. // bys site_id (dkm): keep if _n==1
. //
. // keep site_id r101 r102 kab
. // save `site2kab', replace
. //
. // use `spbun_loc', clear
. // merge 1:1 site_id using `site2kab', nogen keep(master match)
. // save `spbun_site_coded', replace
. 
. cap which geonear

. use `spbun_loc', clear

. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide nearcount(1)
option nearcount() not allowed
r(198);

end of do-file

r(198);

. do "/var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//SD00943.000000"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. // tempfile spbun_site_coded villcoords site_bins site2kab
. // local binsz = 0.10
. //
. // use `spbun_loc', clear
. //
. // preserve
. //     use "$outdir/podes_vill.dta", clear
. //     keep iddesa kab r101 r102 lat_v lon_v
. //     drop if missing(lat_v) | missing(lon_v)
. //     save `villcoords', replace
. // restore
. //
. // drop if missing(lat_s) | missing(lon_s)
. //
. // gen int latbin = floor(lat_s/`binsz')
. // gen int lonbin = floor(lon_s/`binsz')
. //
. // expand 9
. // bys site_id: gen byte _g = _n - 1
. // gen int dlat = floor(_g/3) - 1
. // gen int dlon = mod(_g,3) - 1
. // gen int latbin2 = latbin + dlat
. // gen int lonbin2 = lonbin + dlon
. // drop _g dlat dlon
. //
. // save `site_bins', replace
. //
. // use `villcoords', clear
. // gen int latbin2 = floor(lat_v/`binsz')
. // gen int lonbin2 = floor(lon_v/`binsz')
. //
. // joinby latbin2 lonbin2 using `site_bins'
. // geodist lat_v lon_v lat_s lon_s, gen(dkm)
. // bys site_id (dkm): keep if _n==1
. //
. // keep site_id r101 r102 kab
. // save `site2kab', replace
. //
. // use `spbun_loc', clear
. // merge 1:1 site_id using `site2kab', nogen keep(master match)
. // save `spbun_site_coded', replace
. 
. cap which geonear

. use `spbun_loc', clear

. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide
base latitude var lat_s must be between -90 and 90
r(198);

end of do-file

r(198);

. summ lat_s lon_s, detail

                            lat_s
-------------------------------------------------------------
      Percentiles      Smallest
 1%    -8.792004       -101.718
 5%    -8.432885      -10.15439
10%     -7.69166      -9.640965       Obs                 375
25%    -6.491714      -8.792004       Sum of wgt.         375

50%       -3.502                      Mean          -3.390895
                        Largest       Std. dev.      6.329572
75%      -.69244       5.251333
90%     2.987755        5.47359       Variance       40.06348
95%      3.78966       5.557679       Skewness      -9.889046
99%     5.251333        5.57781       Kurtosis       156.4397

                            lon_s
-------------------------------------------------------------
      Percentiles      Smallest
 1%     96.13156       95.23794
 5%     98.28547       95.28802
10%        99.86       95.32247       Obs                 375
25%     107.5478       96.13156       Sum of wgt.         375

50%     112.1688                      Mean           113.6848
                        Largest       Std. dev.      9.841923
75%      120.371       139.1031
90%     127.4569       140.3781       Variance       96.86344
95%     132.1969       140.7164       Skewness       .3989103
99%     139.1031       140.7194       Kurtosis       2.733035

. count if missing(lat_s) | missing(lon_s)
  0

. count if lat_s < -90 | lat_s > 90
  1

. count if lon_s < -180 | lon_s > 180
  0

. list site_id lat_s lon_s if lat_s < -90 | lat_s > 90 | lon_s < -180 | lon_s > 180 in 1/50

. list site_id lat_s lon_s titik_koordinat if abs(lat_s)>90, noobs
variable titik_koordinat not found
r(111);

. 
. list site_id lat_s lon_s if abs(lat_s)>90, noobs

  +----------------------------------+
  | site_id        lat_s       lon_s |
  |----------------------------------|
  | 5885103   -101.71797   123.56368 |
  +----------------------------------+

. 
. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. // tempfile spbun_site_coded villcoords site_bins site2kab
. // local binsz = 0.10
. //
. // use `spbun_loc', clear
. //
. // preserve
. //     use "$outdir/podes_vill.dta", clear
. //     keep iddesa kab r101 r102 lat_v lon_v
. //     drop if missing(lat_v) | missing(lon_v)
. //     save `villcoords', replace
. // restore
. //
. // drop if missing(lat_s) | missing(lon_s)
. //
. // gen int latbin = floor(lat_s/`binsz')
. // gen int lonbin = floor(lon_s/`binsz')
. //
. // expand 9
. // bys site_id: gen byte _g = _n - 1
. // gen int dlat = floor(_g/3) - 1
. // gen int dlon = mod(_g,3) - 1
. // gen int latbin2 = latbin + dlat
. // gen int lonbin2 = lonbin + dlon
. // drop _g dlat dlon
. //
. // save `site_bins', replace
. //
. // use `villcoords', clear
. // gen int latbin2 = floor(lat_v/`binsz')
. // gen int lonbin2 = floor(lon_v/`binsz')
. //
. // joinby latbin2 lonbin2 using `site_bins'
. // geodist lat_v lon_v lat_s lon_s, gen(dkm)
. // bys site_id (dkm): keep if _n==1
. //
. // keep site_id r101 r102 kab
. // save `site2kab', replace
. //
. // use `spbun_loc', clear
. // merge 1:1 site_id using `site2kab', nogen keep(master match)
. // save `spbun_site_coded', replace
. 
. drop if site_id==5885103
site_id not found
r(111);

end of do-file

r(111);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. // tempfile spbun_site_coded villcoords site_bins site2kab
. // local binsz = 0.10
. //
. // use `spbun_loc', clear
. //
. // preserve
. //     use "$outdir/podes_vill.dta", clear
. //     keep iddesa kab r101 r102 lat_v lon_v
. //     drop if missing(lat_v) | missing(lon_v)
. //     save `villcoords', replace
. // restore
. //
. // drop if missing(lat_s) | missing(lon_s)
. //
. // gen int latbin = floor(lat_s/`binsz')
. // gen int lonbin = floor(lon_s/`binsz')
. //
. // expand 9
. // bys site_id: gen byte _g = _n - 1
. // gen int dlat = floor(_g/3) - 1
. // gen int dlon = mod(_g,3) - 1
. // gen int latbin2 = latbin + dlat
. // gen int lonbin2 = lonbin + dlon
. // drop _g dlat dlon
. //
. // save `site_bins', replace
. //
. // use `villcoords', clear
. // gen int latbin2 = floor(lat_v/`binsz')
. // gen int lonbin2 = floor(lon_v/`binsz')
. //
. // joinby latbin2 lonbin2 using `site_bins'
. // geodist lat_v lon_v lat_s lon_s, gen(dkm)
. // bys site_id (dkm): keep if _n==1
. //
. // keep site_id r101 r102 kab
. // save `site2kab', replace
. //
. // use `spbun_loc', clear
. // merge 1:1 site_id using `site2kab', nogen keep(master match)
. // save `spbun_site_coded', replace
. 
. 
. 
. cap which geonear

. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.638
-------------------------------------------------------------------------------

. 
. //
. // rename nid nearest_iddesa
. // rename dist dist_km
. //
. // capture confirm variable lnpov
. // rename lnpov lnpov_near
. //
. // keep spbun_id lat_spbun lon_spbun nearest_iddesa dist_km lnpov_near
. // save `spbun_near', replace
. 
. // * ----------------------------
. // * 5) Merge nearest-poverty with SURVIVAL (viability + MDI)
. // * ----------------------------
. // use `spbun_near', clear
. // merge 1:1 spbun_id using `surv', keep(match master) nogenerate
. // save `merged_final', replace
. //
. // * ----------------------------
. // * 6) High MDI definition (follow MDI.do if components exist; else use mdi_in)
. // *    Practical default:
. // *      - If mdi_in is already 1/2/3 (tercile), "high" = 3
. // *      - Else if continuous, "high" = top tercile by xtile
. // * ----------------------------
. // use `merged_final', clear
. //
. // capture assert inlist(mdi_in,1,2,3) if !missing(mdi_in)
. // if _rc==0 {
. //     gen byte high_mdi = (mdi_in==3) if !missing(mdi_in)
. //     label var high_mdi "High MDI (mdi_in==3)"
. // }
. // else {
. //     cap drop mdi_kl3 high_mdi
. //     xtile mdi_kl3 = mdi_in, nq(3)
. //     gen byte high_mdi = (mdi_kl3==3) if !missing(mdi_kl3)
. //     label var high_mdi "High MDI (top tercile of mdi_in)"
. // }
. //
. // * ----------------------------
. // * 7) Probability of "tidak layak" given high MDI and poverty
. // *    (no need to categorize poverty index)
. // * ----------------------------
. // keep if !missing(tidak_layak, high_mdi, lnpov_near)
. //
. // * Core logit: poverty + high MDI + interaction
. // logit tidak_layak c.lnpov_near##i.high_mdi, vce(robust)
. // estimates store M1
. //
. // * Predicted probability at representative poverty levels (p25, p50, p75) by MDI group
. // summ lnpov_near, detail
. // local p25 = r(p25)
. // local p50 = r(p50)
. // local p75 = r(p75)
. //
. // margins high_mdi, at(lnpov_near=(`p25' `p50' `p75')) post
. // estimates store Marg1
. //
. // * Simple empirical rates (sanity check): mean tidak_layak by high_mdi
. // bys high_mdi: summ tidak_layak
. //
. // * Export outputs
. // predict double phat_M1 if e(sample), pr
. // label var phat_M1 "Predicted P(tidak layak) from logit"
. //
. // save "$OUTDIR/spbun_nearestpoverty_viability.dta", replace
. // export delimited using "$OUTDIR/spbun_nearestpoverty_viability.csv", replace
. //
. // * Optional: compact regression table (requires esttab)
. // cap which esttab
. // if !_rc {
. //     esttab M1 using "$OUTDIR/logit_tidaklayak.rtf", replace ///
. //         b(%9.4f) se(%9.4f) star(* 0.10 ** 0.05 *** 0.01) ///
. //         stats(N ll, fmt(%9.0g %9.3f) labels("N" "LogLik")) ///
. //         title("Logit: P(SPBUN tidak layak) ~ poverty (nearest) x High MDI")
. // }
. //
. // di as txt "DONE. Outputs:"
. // di as txt "  $OUTDIR/spbun_nearestpoverty_viability.dta"
. // di as txt "  $OUTDIR/spbun_nearestpoverty_viability.csv"
. 
end of do-file

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. // tempfile spbun_site_coded villcoords site_bins site2kab
. // local binsz = 0.10
. //
. // use `spbun_loc', clear
. //
. // preserve
. //     use "$outdir/podes_vill.dta", clear
. //     keep iddesa kab r101 r102 lat_v lon_v
. //     drop if missing(lat_v) | missing(lon_v)
. //     save `villcoords', replace
. // restore
. //
. // drop if missing(lat_s) | missing(lon_s)
. //
. // gen int latbin = floor(lat_s/`binsz')
. // gen int lonbin = floor(lon_s/`binsz')
. //
. // expand 9
. // bys site_id: gen byte _g = _n - 1
. // gen int dlat = floor(_g/3) - 1
. // gen int dlon = mod(_g,3) - 1
. // gen int latbin2 = latbin + dlat
. // gen int lonbin2 = lonbin + dlon
. // drop _g dlat dlon
. //
. // save `site_bins', replace
. //
. // use `villcoords', clear
. // gen int latbin2 = floor(lat_v/`binsz')
. // gen int lonbin2 = floor(lon_v/`binsz')
. //
. // joinby latbin2 lonbin2 using `site_bins'
. // geodist lat_v lon_v lat_s lon_s, gen(dkm)
. // bys site_id (dkm): keep if _n==1
. //
. // keep site_id r101 r102 kab
. // save `site2kab', replace
. //
. // use `spbun_loc', clear
. // merge 1:1 site_id using `site2kab', nogen keep(master match)
. // save `spbun_site_coded', replace
. 
. 
. 
. cap which geonear

. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.574
-------------------------------------------------------------------------------

. 
. rename nid nearest_iddesa

. capture confirm variable lnpov

. rename lnpov lnpov_near
variable lnpov not found
r(111);

end of do-file

r(111);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. // tempfile spbun_site_coded villcoords site_bins site2kab
. // local binsz = 0.10
. //
. // use `spbun_loc', clear
. //
. // preserve
. //     use "$outdir/podes_vill.dta", clear
. //     keep iddesa kab r101 r102 lat_v lon_v
. //     drop if missing(lat_v) | missing(lon_v)
. //     save `villcoords', replace
. // restore
. //
. // drop if missing(lat_s) | missing(lon_s)
. //
. // gen int latbin = floor(lat_s/`binsz')
. // gen int lonbin = floor(lon_s/`binsz')
. //
. // expand 9
. // bys site_id: gen byte _g = _n - 1
. // gen int dlat = floor(_g/3) - 1
. // gen int dlon = mod(_g,3) - 1
. // gen int latbin2 = latbin + dlat
. // gen int lonbin2 = lonbin + dlon
. // drop _g dlat dlon
. //
. // save `site_bins', replace
. //
. // use `villcoords', clear
. // gen int latbin2 = floor(lat_v/`binsz')
. // gen int lonbin2 = floor(lon_v/`binsz')
. //
. // joinby latbin2 lonbin2 using `site_bins'
. // geodist lat_v lon_v lat_s lon_s, gen(dkm)
. // bys site_id (dkm): keep if _n==1
. //
. // keep site_id r101 r102 kab
. // save `site2kab', replace
. //
. // use `spbun_loc', clear
. // merge 1:1 site_id using `site2kab', nogen keep(master match)
. // save `spbun_site_coded', replace
. 
. 
. 
. cap which geonear

. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.477
-------------------------------------------------------------------------------

. 
. rename nid nearest_iddesa

. // capture confirm variable lnpov
. // rename lnpov lnpov_near
. keep spbun_id lat_spbun lon_spbun nearest_iddesa dist_km lnpov_near
variable spbun_id not found
r(111);

end of do-file

r(111);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.466
-------------------------------------------------------------------------------

. 
. rename nid nearest_iddesa

. capture confirm variable lnpov

. rename lnpov lnpov_near
variable lnpov not found
r(111);

end of do-file

r(111);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. if _rc ssc install geonear, replace

. 
. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.531
-------------------------------------------------------------------------------

. 
. rename nid1 nearest_iddesa
variable nid1 not found
r(111);

end of do-file

r(111);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. if _rc ssc install geonear, replace

. 
. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.453
-------------------------------------------------------------------------------

. 
. rename nid nearest_iddesa

. rename km_to_nid1 dist_km
variable km_to_nid1 not found
r(111);

end of do-file

r(111);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. if _rc ssc install geonear, replace

. 
. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.508
-------------------------------------------------------------------------------

. 
. rename nid nearest_iddesa

. rename km_to_nid dist_km

. 
. keep site_id lat_s lon_s nearest_iddesa dist_km

. tempfile spbun_nn

. save `spbun_nn', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 saved as .dta format

. 
. use `villages', clear

. keep iddesa lnpov

. rename lnpov lnpov_near

. tempfile vill_pov

. save `vill_pov', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. 
. use `spbun_nn', clear

. merge m:1 nearest_iddesa using `vill_pov', keep(match master) nogen
variable nearest_iddesa not found
r(111);

end of do-file

r(111);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. if _rc ssc install geonear, replace

. 
. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.442
-------------------------------------------------------------------------------

. 
. rename nid nearest_iddesa

. rename km_to_nid dist_km

. 
. keep site_id lat_s lon_s nearest_iddesa dist_km

. tempfile spbun_nn

. save `spbun_nn', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 saved as .dta format

. 
. use `villages', clear

. keep iddesa lnpov

. rename lnpov lnpov_near

. tempfile vill_pov

. save `vill_pov', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. 
. use `spbun_nn', clear

. merge m:1 nearest_iddesa using `vill_pov', keep(match master) nogen
variable nearest_iddesa not found
r(111);

end of do-file

r(111);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. if _rc ssc install geonear, replace

. 
. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.495
-------------------------------------------------------------------------------

. 
. rename nid nearest_iddesa

. rename km_to_nid dist_km

. 
. keep site_id lat_s lon_s nearest_iddesa dist_km

. tempfile spbun_nn

. save `spbun_nn', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 saved as .dta format

. 
. use `villages', clear

. keep iddesa lnpov

. rename lnpov lnpov_near

. tempfile vill_pov

. save `vill_pov', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. 
. use `spbun_nn', clear

. merge m:1 nearest_iddesa using `vill_pov', keep(match master) nogen
variable nearest_iddesa not found
r(111);

end of do-file

r(111);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. rename iddesa nearest_iddesa

. keep nearest_iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
iddesa not found
r(111);

end of do-file

r(111);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. rename iddesa nearest_iddesa

. keep nearest_iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(nearest_iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. if _rc ssc install geonear, replace

. 
. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide
variable iddesa not found
r(111);

end of do-file

r(111);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. rename iddesa nearest_iddesa

. keep nearest_iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(nearest_iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. if _rc ssc install geonear, replace

. 
. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide
variable iddesa not found
r(111);

end of do-file

r(111);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. if _rc ssc install geonear, replace

. 
. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.553
-------------------------------------------------------------------------------

. 
. rename nid iddesa

. rename km_to_nid dist_km

. 
. keep site_id lat_s lon_s nearest_iddesa dist_km
variable nearest_iddesa not found
r(111);

end of do-file

r(111);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. if _rc ssc install geonear, replace

. 
. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.434
-------------------------------------------------------------------------------

. 
. rename nid iddesa

. rename km_to_nid dist_km

. 
. keep site_id lat_s lon_s nearest_iddesa dist_km
variable nearest_iddesa not found
r(111);

end of do-file

r(111);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. if _rc ssc install geonear, replace

. 
. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.398
-------------------------------------------------------------------------------

. 
. rename nid iddesa

. rename km_to_nid dist_km

. 
. keep site_id lat_s lon_s iddesa dist_km

. tempfile spbun_nn

. save `spbun_nn', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 saved as .dta format

. 
. use `villages', clear

. keep iddesa lnpov

. rename lnpov lnpov_near

. tempfile vill_pov

. save `vill_pov', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. 
. use `spbun_nn', clear

. merge m:1 iddesa using `vill_pov', keep(match master) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               374  
    -----------------------------------------

. 
. save `spbun_near', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 saved as .dta format

. 
. // * ----------------------------
. // * 5) Merge nearest-poverty with SURVIVAL (viability + MDI)
. // * ----------------------------
. // use `spbun_near', clear
. // merge 1:1 spbun_id using `surv', keep(match master) nogenerate
. // save `merged_final', replace
. //
. // * ----------------------------
. // * 6) High MDI definition (follow MDI.do if components exist; else use mdi_in)
. // *    Practical default:
. // *      - If mdi_in is already 1/2/3 (tercile), "high" = 3
. // *      - Else if continuous, "high" = top tercile by xtile
. // * ----------------------------
. // use `merged_final', clear
. //
. // capture assert inlist(mdi_in,1,2,3) if !missing(mdi_in)
. // if _rc==0 {
. //     gen byte high_mdi = (mdi_in==3) if !missing(mdi_in)
. //     label var high_mdi "High MDI (mdi_in==3)"
. // }
. // else {
. //     cap drop mdi_kl3 high_mdi
. //     xtile mdi_kl3 = mdi_in, nq(3)
. //     gen byte high_mdi = (mdi_kl3==3) if !missing(mdi_kl3)
. //     label var high_mdi "High MDI (top tercile of mdi_in)"
. // }
. //
. // * ----------------------------
. // * 7) Probability of "tidak layak" given high MDI and poverty
. // *    (no need to categorize poverty index)
. // * ----------------------------
. // keep if !missing(tidak_layak, high_mdi, lnpov_near)
. //
. // * Core logit: poverty + high MDI + interaction
. // logit tidak_layak c.lnpov_near##i.high_mdi, vce(robust)
. // estimates store M1
. //
. // * Predicted probability at representative poverty levels (p25, p50, p75) by MDI group
. // summ lnpov_near, detail
. // local p25 = r(p25)
. // local p50 = r(p50)
. // local p75 = r(p75)
. //
. // margins high_mdi, at(lnpov_near=(`p25' `p50' `p75')) post
. // estimates store Marg1
. //
. // * Simple empirical rates (sanity check): mean tidak_layak by high_mdi
. // bys high_mdi: summ tidak_layak
. //
. // * Export outputs
. // predict double phat_M1 if e(sample), pr
. // label var phat_M1 "Predicted P(tidak layak) from logit"
. //
. // save "$OUTDIR/spbun_nearestpoverty_viability.dta", replace
. // export delimited using "$OUTDIR/spbun_nearestpoverty_viability.csv", replace
. //
. // * Optional: compact regression table (requires esttab)
. // cap which esttab
. // if !_rc {
. //     esttab M1 using "$OUTDIR/logit_tidaklayak.rtf", replace ///
. //         b(%9.4f) se(%9.4f) star(* 0.10 ** 0.05 *** 0.01) ///
. //         stats(N ll, fmt(%9.0g %9.3f) labels("N" "LogLik")) ///
. //         title("Logit: P(SPBUN tidak layak) ~ poverty (nearest) x High MDI")
. // }
. //
. // di as txt "DONE. Outputs:"
. // di as txt "  $OUTDIR/spbun_nearestpoverty_viability.dta"
. // di as txt "  $OUTDIR/spbun_nearestpoverty_viability.csv"
. 
end of do-file

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. if _rc ssc install geonear, replace

. 
. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.476
-------------------------------------------------------------------------------

. 
. rename nid iddesa

. rename km_to_nid dist_km

. 
. keep site_id lat_s lon_s iddesa dist_km

. tempfile spbun_nn

. save `spbun_nn', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 saved as .dta format

. 
. use `villages', clear

. keep iddesa lnpov

. rename lnpov lnpov_near

. tempfile vill_pov

. save `vill_pov', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. 
. * ----------------------------
. * 5) Merge nearest-poverty with SURVIVAL (viability + MDI)
. * ----------------------------
. use `spbun_nn', clear

. merge m:1 iddesa using `vill_pov', keep(match master) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               374  
    -----------------------------------------

. save `spbun_near', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 saved as .dta format

. 
. * ----------------------------
. * 6) High MDI definition (follow MDI.do if components exist; else use mdi_in)
. * ----------------------------
. use `spbun_near', clear

. 
. capture assert inlist(mdi_in,1,2,3) if !missing(mdi_in)

. if _rc==0 {
.     gen byte high_mdi = (mdi_in==3) if !missing(mdi_in)
.     label var high_mdi "High MDI (mdi_in==3)"
. }

. else {
.     cap drop mdi_kl3 high_mdi
.     xtile mdi_kl3 = mdi_in, nq(3)
mdi_in not found
r(111);
.     gen byte high_mdi = (mdi_kl3==3) if !missing(mdi_kl3)
.     label var high_mdi "High MDI (top tercile of mdi_in)"
. }
r(111);

end of do-file

r(111);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. if _rc ssc install geonear, replace

. 
. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.475
-------------------------------------------------------------------------------

. 
. rename nid iddesa

. rename km_to_nid dist_km

. 
. keep site_id lat_s lon_s iddesa dist_km

. tempfile spbun_nn

. save `spbun_nn', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 saved as .dta format

. 
. use `villages', clear

. keep iddesa lnpov

. rename lnpov lnpov_near

. tempfile vill_pov

. save `vill_pov', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. 
. * ----------------------------
. * 5) Merge nearest-poverty with SURVIVAL (viability + MDI)
. * ----------------------------
. use `spbun_nn', clear

. merge m:1 iddesa using `vill_pov', keep(match master) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               374  
    -----------------------------------------

. save `spbun_near', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 saved as .dta format

. 
. * ----------------------------
. * 6) High MDI definition (follow MDI.do if components exist; else use mdi_in)
. * ----------------------------
. use `merged_final', clear
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000005 not found
r(601);

end of do-file

r(601);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. if _rc ssc install geonear, replace

. 
. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.416
-------------------------------------------------------------------------------

. 
. rename nid iddesa

. rename km_to_nid dist_km

. 
. keep site_id lat_s lon_s iddesa dist_km

. tempfile spbun_nn

. save `spbun_nn', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 saved as .dta format

. 
. use `villages', clear

. keep iddesa lnpov

. rename lnpov lnpov_near

. tempfile vill_pov

. save `vill_pov', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. 
. use `spbun_nn', clear

. merge m:1 iddesa using `vill_pov', keep(match master) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               374  
    -----------------------------------------

. save `spbun_near', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 saved as .dta format

. 
. * ----------------------------
. * 5) Merge nearest-poverty with SURVIVAL (viability + MDI)
. * ----------------------------
. use `spbun_near', clear

. merge 1:1 spbun_id using `surv', keep(match master) nogenerate
variable spbun_id not found
r(111);

end of do-file

r(111);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. if "`vlay'"=="" {
.     di as err "Cannot find viability column (Layak/ Tidak Layak). Rename it to layak_flag (1=layak,0=tidak)."
.     error 198
. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. if _rc {
.     di as err "Cannot find MDI column in SURVIVAL.xlsx. Rename your MDI column to 'MDI'."
.     error 198
. }

. rename MDI mdi_in

. 
. keep spbun_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. if _rc ssc install geonear, replace

. 
. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.441
-------------------------------------------------------------------------------

. 
. rename nid iddesa

. rename km_to_nid dist_km

. 
. keep site_id lat_s lon_s iddesa dist_km

. tempfile spbun_nn

. save `spbun_nn', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 saved as .dta format

. 
. use `villages', clear

. keep iddesa lnpov

. rename lnpov lnpov_near

. tempfile vill_pov

. save `vill_pov', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. 
. use `spbun_nn', clear

. merge m:1 iddesa using `vill_pov', keep(match master) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               374  
    -----------------------------------------

. save `spbun_near', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 saved as .dta format

. 
. * ----------------------------
. * 5) Merge nearest-poverty with SURVIVAL (viability + MDI)
. * ----------------------------
. use `spbun_near', clear

. merge 1:1 site_id using `surv', keep(match master) nogenerate
variable site_id not found
r(111);

end of do-file

r(111);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. rename MDI mdi_in

. rename spbun_id site_id

. 
. keep site_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. if _rc ssc install geonear, replace

. 
. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.401
-------------------------------------------------------------------------------

. 
. rename nid iddesa

. rename km_to_nid dist_km

. 
. keep site_id lat_s lon_s iddesa dist_km

. tempfile spbun_nn

. save `spbun_nn', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 saved as .dta format

. 
. use `villages', clear

. keep iddesa lnpov

. rename lnpov lnpov_near

. tempfile vill_pov

. save `vill_pov', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. 
. use `spbun_nn', clear

. merge m:1 iddesa using `vill_pov', keep(match master) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               374  
    -----------------------------------------

. save `spbun_near', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 saved as .dta format

. 
. * ----------------------------
. * 5) Merge nearest-poverty with SURVIVAL (viability + MDI)
. * ----------------------------
. use `spbun_near', clear

. merge 1:1 site_id using `surv', keep(match master) nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                           206
        from master                       206  
        from using                          0  

    Matched                               168  
    -----------------------------------------

. save `merged_final', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000005 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000005 saved as .dta format

. 
. // * ----------------------------
. // * 6) High MDI definition (follow MDI.do if components exist; else use mdi_in)
. // *    Practical default:
. // *      - If mdi_in is already 1/2/3 (tercile), "high" = 3
. // *      - Else if continuous, "high" = top tercile by xtile
. // * ----------------------------
. // use `merged_final', clear
. //
. // capture assert inlist(mdi_in,1,2,3) if !missing(mdi_in)
. // if _rc==0 {
. //     gen byte high_mdi = (mdi_in==3) if !missing(mdi_in)
. //     label var high_mdi "High MDI (mdi_in==3)"
. // }
. // else {
. //     cap drop mdi_kl3 high_mdi
. //     xtile mdi_kl3 = mdi_in, nq(3)
. //     gen byte high_mdi = (mdi_kl3==3) if !missing(mdi_kl3)
. //     label var high_mdi "High MDI (top tercile of mdi_in)"
. // }
. //
. // * ----------------------------
. // * 7) Probability of "tidak layak" given high MDI and poverty
. // *    (no need to categorize poverty index)
. // * ----------------------------
. // keep if !missing(tidak_layak, high_mdi, lnpov_near)
. //
. // * Core logit: poverty + high MDI + interaction
. // logit tidak_layak c.lnpov_near##i.high_mdi, vce(robust)
. // estimates store M1
. //
. // * Predicted probability at representative poverty levels (p25, p50, p75) by MDI group
. // summ lnpov_near, detail
. // local p25 = r(p25)
. // local p50 = r(p50)
. // local p75 = r(p75)
. //
. // margins high_mdi, at(lnpov_near=(`p25' `p50' `p75')) post
. // estimates store Marg1
. //
. // * Simple empirical rates (sanity check): mean tidak_layak by high_mdi
. // bys high_mdi: summ tidak_layak
. //
. // * Export outputs
. // predict double phat_M1 if e(sample), pr
. // label var phat_M1 "Predicted P(tidak layak) from logit"
. //
. // save "$OUTDIR/spbun_nearestpoverty_viability.dta", replace
. // export delimited using "$OUTDIR/spbun_nearestpoverty_viability.csv", replace
. //
. // * Optional: compact regression table (requires esttab)
. // cap which esttab
. // if !_rc {
. //     esttab M1 using "$OUTDIR/logit_tidaklayak.rtf", replace ///
. //         b(%9.4f) se(%9.4f) star(* 0.10 ** 0.05 *** 0.01) ///
. //         stats(N ll, fmt(%9.0g %9.3f) labels("N" "LogLik")) ///
. //         title("Logit: P(SPBUN tidak layak) ~ poverty (nearest) x High MDI")
. // }
. //
. // di as txt "DONE. Outputs:"
. // di as txt "  $OUTDIR/spbun_nearestpoverty_viability.dta"
. // di as txt "  $OUTDIR/spbun_nearestpoverty_viability.csv"
. 
end of do-file

. drop PP=.
=exp not allowed
r(101);

. drop PP = .
=exp not allowed
r(101);

. drop PP =- .
=exp not allowed
r(101);

. drop if PP =- .
=exp not allowed
r(101);

. drop if PP == .
(206 observations deleted)

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. rename MDI mdi_in

. rename spbun_id site_id

. 
. keep site_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. if _rc ssc install geonear, replace

. 
. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.591
-------------------------------------------------------------------------------

. 
. rename nid iddesa

. rename km_to_nid dist_km

. 
. keep site_id lat_s lon_s iddesa dist_km

. tempfile spbun_nn

. save `spbun_nn', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 saved as .dta format

. 
. use `villages', clear

. keep iddesa lnpov

. rename lnpov lnpov_near

. tempfile vill_pov

. save `vill_pov', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. 
. use `spbun_nn', clear

. merge m:1 iddesa using `vill_pov', keep(match master) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               374  
    -----------------------------------------

. save `spbun_near', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 saved as .dta format

. 
. * ----------------------------
. * 5) Merge nearest-poverty with SURVIVAL (viability + MDI)
. * ----------------------------
. use `spbun_near', clear

. merge 1:1 site_id using `surv', keep(match master) nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                           206
        from master                       206  
        from using                          0  

    Matched                               168  
    -----------------------------------------

. save `merged_final', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000005 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000005 saved as .dta format

. 
. * ----------------------------
. * 6) High MDI definition (follow MDI.do if components exist; else use mdi_in)
. * ----------------------------
. use `merged_final', clear

. drop if PP == .
(206 observations deleted)

. 
. capture assert inlist(mdi_in,1,2,3) if !missing(mdi_in)

. if _rc==0 {
.     gen byte high_mdi = (mdi_in==3) if !missing(mdi_in)
.     label var high_mdi "High MDI (mdi_in==3)"
. }

. else {
.     cap drop mdi_kl3 high_mdi
.     xtile mdi_kl3 = mdi_in, nq(3)
.     gen byte high_mdi = (mdi_kl3==3) if !missing(mdi_kl3)
.     label var high_mdi "High MDI (top tercile of mdi_in)"
. }

. 
. // * ----------------------------
. // * 7) Probability of "tidak layak" given high MDI and poverty
. // *    (no need to categorize poverty index)
. // * ----------------------------
. // keep if !missing(tidak_layak, high_mdi, lnpov_near)
. //
. // * Core logit: poverty + high MDI + interaction
. // logit tidak_layak c.lnpov_near##i.high_mdi, vce(robust)
. // estimates store M1
. //
. // * Predicted probability at representative poverty levels (p25, p50, p75) by MDI group
. // summ lnpov_near, detail
. // local p25 = r(p25)
. // local p50 = r(p50)
. // local p75 = r(p75)
. //
. // margins high_mdi, at(lnpov_near=(`p25' `p50' `p75')) post
. // estimates store Marg1
. //
. // * Simple empirical rates (sanity check): mean tidak_layak by high_mdi
. // bys high_mdi: summ tidak_layak
. //
. // * Export outputs
. // predict double phat_M1 if e(sample), pr
. // label var phat_M1 "Predicted P(tidak layak) from logit"
. //
. // save "$OUTDIR/spbun_nearestpoverty_viability.dta", replace
. // export delimited using "$OUTDIR/spbun_nearestpoverty_viability.csv", replace
. //
. // * Optional: compact regression table (requires esttab)
. // cap which esttab
. // if !_rc {
. //     esttab M1 using "$OUTDIR/logit_tidaklayak.rtf", replace ///
. //         b(%9.4f) se(%9.4f) star(* 0.10 ** 0.05 *** 0.01) ///
. //         stats(N ll, fmt(%9.0g %9.3f) labels("N" "LogLik")) ///
. //         title("Logit: P(SPBUN tidak layak) ~ poverty (nearest) x High MDI")
. // }
. //
. // di as txt "DONE. Outputs:"
. // di as txt "  $OUTDIR/spbun_nearestpoverty_viability.dta"
. // di as txt "  $OUTDIR/spbun_nearestpoverty_viability.csv"
. 
end of do-file

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. rename MDI mdi_in

. rename spbun_id site_id

. 
. keep site_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. if _rc ssc install geonear, replace

. 
. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.409
-------------------------------------------------------------------------------

. 
. rename nid iddesa

. rename km_to_nid dist_km

. 
. keep site_id lat_s lon_s iddesa dist_km

. tempfile spbun_nn

. save `spbun_nn', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 saved as .dta format

. 
. use `villages', clear

. keep iddesa lnpov

. rename lnpov lnpov_near

. tempfile vill_pov

. save `vill_pov', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. 
. use `spbun_nn', clear

. merge m:1 iddesa using `vill_pov', keep(match master) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               374  
    -----------------------------------------

. save `spbun_near', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 saved as .dta format

. 
. * ----------------------------
. * 5) Merge nearest-poverty with SURVIVAL (viability + MDI)
. * ----------------------------
. use `spbun_near', clear

. merge 1:1 site_id using `surv', keep(match master) nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                           206
        from master                       206  
        from using                          0  

    Matched                               168  
    -----------------------------------------

. save `merged_final', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000005 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000005 saved as .dta format

. 
. * ----------------------------
. * 6) High MDI definition (follow MDI.do if components exist; else use mdi_in)
. * ----------------------------
. use `merged_final', clear

. drop if PP == .
(206 observations deleted)

. 
. capture assert inlist(mdi_in,1,2,3) if !missing(mdi_in)

. if _rc==0 {
.     gen byte high_mdi = (mdi_in==3) if !missing(mdi_in)
.     label var high_mdi "High MDI (mdi_in==3)"
. }

. else {
.     cap drop mdi_kl3 high_mdi
.     xtile mdi_kl3 = mdi_in, nq(3)
.     gen byte high_mdi = (mdi_kl3==3) if !missing(mdi_kl3)
.     label var high_mdi "High MDI (top tercile of mdi_in)"
. }

. 
. * ----------------------------
. * 7) Probability of "tidak layak" given high MDI and poverty
. *    (no need to categorize poverty index)
. * ----------------------------
. keep if !missing(tidak_layak, high_mdi, lnpov_near)
(0 observations deleted)

. 
. logit tidak_layak c.lnpov_near##i.high_mdi, vce(robust)

Iteration 0:   log pseudolikelihood = -114.10447  
Iteration 1:   log pseudolikelihood = -102.31821  
Iteration 2:   log pseudolikelihood = -102.09019  
Iteration 3:   log pseudolikelihood = -102.08856  
Iteration 4:   log pseudolikelihood = -102.08856  

Logistic regression                                     Number of obs =    168
                                                        Wald chi2(3)  =  21.02
                                                        Prob > chi2   = 0.0001
Log pseudolikelihood = -102.08856                       Pseudo R2     = 0.1053

---------------------------------------------------------------------------------------
                      |               Robust
          tidak_layak | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
----------------------+----------------------------------------------------------------
           lnpov_near |   -.350389   .1476519    -2.37   0.018    -.6397815   -.0609965
           1.high_mdi |   1.692439   1.344827     1.26   0.208    -.9433724    4.328251
                      |
high_mdi#c.lnpov_near |
                   1  |  -.0907861   .3072992    -0.30   0.768    -.6930815    .5115093
                      |
                _cons |   1.404643   .6676662     2.10   0.035     .0960414    2.713245
---------------------------------------------------------------------------------------

. estimates store M1

. 
. summ lnpov_near, detail

                         lnpov_near
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0              0
 5%            0              0
10%     2.302585              0       Obs                 168
25%     3.433987              0       Sum of wgt.         168

50%     4.158883                      Mean           4.095712
                        Largest       Std. dev.       1.45013
75%     5.081404       6.259581
90%     5.828946       6.378426       Variance       2.102877
95%     5.998937       6.467699       Skewness      -.9924908
99%     6.467699       7.226936       Kurtosis       4.294965

. local p25 = r(p25)

. local p50 = r(p50)

. local p75 = r(p75)

. 
. margins high_mdi, at(lnpov_near=(`p25' `p50' `p75')) post

Adjusted predictions                                       Number of obs = 168
Model VCE: Robust

Expression: Pr(tidak_layak), predict()
1._at: lnpov_near = 3.433987
2._at: lnpov_near = 4.158883
3._at: lnpov_near = 5.081404

------------------------------------------------------------------------------
             |            Delta-method
             |     Margin   std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
_at#high_mdi |
        1 0  |   .5501834    .058259     9.44   0.000     .4359979    .6643689
        1 1  |   .8295007   .0544482    15.23   0.000     .7227841    .9362173
        2 0  |   .4868571   .0491712     9.90   0.000     .3904833    .5832309
        2 1  |   .7794195    .057226    13.62   0.000     .6672585    .8915805
        3 0  |   .4071343   .0543209     7.49   0.000     .3006672    .5136013
        3 1  |   .7016764   .0872049     8.05   0.000     .5307579    .8725949
------------------------------------------------------------------------------

. estimates store Marg1

. 
. bys high_mdi: summ tidak_layak

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> high_mdi = 0

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 tidak_layak |        112    .4821429    .5019268          0          1

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> high_mdi = 1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 tidak_layak |         56    .7857143    .4140393          0          1


. 
. * Export outputs
. predict double phat_M1 if e(sample), pr
predict is not allowed after margins
r(301);

end of do-file

r(301);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. rename MDI mdi_in

. rename spbun_id site_id

. 
. keep site_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. if _rc ssc install geonear, replace

. 
. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.569
-------------------------------------------------------------------------------

. 
. rename nid iddesa

. rename km_to_nid dist_km

. 
. keep site_id lat_s lon_s iddesa dist_km

. tempfile spbun_nn

. save `spbun_nn', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 saved as .dta format

. 
. use `villages', clear

. keep iddesa lnpov

. rename lnpov lnpov_near

. tempfile vill_pov

. save `vill_pov', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. 
. use `spbun_nn', clear

. merge m:1 iddesa using `vill_pov', keep(match master) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               374  
    -----------------------------------------

. save `spbun_near', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 saved as .dta format

. 
. * ----------------------------
. * 5) Merge nearest-poverty with SURVIVAL (viability + MDI)
. * ----------------------------
. use `spbun_near', clear

. merge 1:1 site_id using `surv', keep(match master) nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                           206
        from master                       206  
        from using                          0  

    Matched                               168  
    -----------------------------------------

. save `merged_final', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000005 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000005 saved as .dta format

. 
. * ----------------------------
. * 6) High MDI definition (follow MDI.do if components exist; else use mdi_in)
. * ----------------------------
. use `merged_final', clear

. drop if PP == .
(206 observations deleted)

. 
. capture assert inlist(mdi_in,1,2,3) if !missing(mdi_in)

. if _rc==0 {
.     gen byte high_mdi = (mdi_in==3) if !missing(mdi_in)
.     label var high_mdi "High MDI (mdi_in==3)"
. }

. else {
.     cap drop mdi_kl3 high_mdi
.     xtile mdi_kl3 = mdi_in, nq(3)
.     gen byte high_mdi = (mdi_kl3==3) if !missing(mdi_kl3)
.     label var high_mdi "High MDI (top tercile of mdi_in)"
. }

. 
. * ----------------------------
. * 7) Probability of "tidak layak" given high MDI and poverty
. * ----------------------------
. keep if !missing(tidak_layak, high_mdi, lnpov_near)
(0 observations deleted)

. 
. logit tidak_layak c.lnpov_near##i.high_mdi, vce(robust)

Iteration 0:   log pseudolikelihood = -114.10447  
Iteration 1:   log pseudolikelihood = -102.31821  
Iteration 2:   log pseudolikelihood = -102.09019  
Iteration 3:   log pseudolikelihood = -102.08856  
Iteration 4:   log pseudolikelihood = -102.08856  

Logistic regression                                     Number of obs =    168
                                                        Wald chi2(3)  =  21.02
                                                        Prob > chi2   = 0.0001
Log pseudolikelihood = -102.08856                       Pseudo R2     = 0.1053

---------------------------------------------------------------------------------------
                      |               Robust
          tidak_layak | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
----------------------+----------------------------------------------------------------
           lnpov_near |   -.350389   .1476519    -2.37   0.018    -.6397815   -.0609965
           1.high_mdi |   1.692439   1.344827     1.26   0.208    -.9433724    4.328251
                      |
high_mdi#c.lnpov_near |
                   1  |  -.0907861   .3072992    -0.30   0.768    -.6930815    .5115093
                      |
                _cons |   1.404643   .6676662     2.10   0.035     .0960414    2.713245
---------------------------------------------------------------------------------------

. estimates store M1

. 
. * lock the estimation sample before margins overwrites e(sample)
. gen byte sample_M1 = e(sample)

. label var sample_M1 "Estimation sample for M1"

. 
. summ lnpov_near if sample_M1, detail

                         lnpov_near
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0              0
 5%            0              0
10%     2.302585              0       Obs                 168
25%     3.433987              0       Sum of wgt.         168

50%     4.158883                      Mean           4.095712
                        Largest       Std. dev.       1.45013
75%     5.081404       6.259581
90%     5.828946       6.378426       Variance       2.102877
95%     5.998937       6.467699       Skewness      -.9924908
99%     6.467699       7.226936       Kurtosis       4.294965

. local p25 = r(p25)

. local p50 = r(p50)

. local p75 = r(p75)

. 
. margins high_mdi if sample_M1, at(lnpov_near=(`p25' `p50' `p75')) post

Adjusted predictions                                       Number of obs = 168
Model VCE: Robust

Expression: Pr(tidak_layak), predict()
1._at: lnpov_near = 3.433987
2._at: lnpov_near = 4.158883
3._at: lnpov_near = 5.081404

------------------------------------------------------------------------------
             |            Delta-method
             |     Margin   std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
_at#high_mdi |
        1 0  |   .5501834    .058259     9.44   0.000     .4359979    .6643689
        1 1  |   .8295007   .0544482    15.23   0.000     .7227841    .9362173
        2 0  |   .4868571   .0491712     9.90   0.000     .3904833    .5832309
        2 1  |   .7794195    .057226    13.62   0.000     .6672585    .8915805
        3 0  |   .4071343   .0543209     7.49   0.000     .3006672    .5136013
        3 1  |   .7016764   .0872049     8.05   0.000     .5307579    .8725949
------------------------------------------------------------------------------

. estimates store Marg1

. 
. bys high_mdi: summ tidak_layak if sample_M1

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> high_mdi = 0

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 tidak_layak |        112    .4821429    .5019268          0          1

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> high_mdi = 1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 tidak_layak |         56    .7857143    .4140393          0          1


. 
. * Export outputs (restore logit results before predict)
. estimates restore M1
(results M1 are active now)

. predict double phat_M1 if sample_M1, pr

. label var phat_M1 "Predicted P(tidak layak) from logit"

. 
end of do-file

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$MIXED_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. rename MDI mdi_in

. rename spbun_id site_id

. 
. keep site_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. if _rc ssc install geonear, replace

. 
. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.6
-------------------------------------------------------------------------------

. 
. rename nid iddesa

. rename km_to_nid dist_km

. 
. keep site_id lat_s lon_s iddesa dist_km

. tempfile spbun_nn

. save `spbun_nn', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 saved as .dta format

. 
. use `villages', clear

. keep iddesa lnpov

. rename lnpov lnpov_near

. tempfile vill_pov

. save `vill_pov', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. 
. use `spbun_nn', clear

. merge m:1 iddesa using `vill_pov', keep(match master) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               374  
    -----------------------------------------

. save `spbun_near', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 saved as .dta format

. 
. * ----------------------------
. * 5) Merge nearest-poverty with SURVIVAL (viability + MDI)
. * ----------------------------
. use `spbun_near', clear

. merge 1:1 site_id using `surv', keep(match master) nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                           206
        from master                       206  
        from using                          0  

    Matched                               168  
    -----------------------------------------

. save `merged_final', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000005 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000005 saved as .dta format

. 
. * ----------------------------
. * 6) High MDI definition (follow MDI.do if components exist; else use mdi_in)
. * ----------------------------
. use `merged_final', clear

. drop if PP == .
(206 observations deleted)

. 
. capture assert inlist(mdi_in,1,2,3) if !missing(mdi_in)

. if _rc==0 {
.     gen byte high_mdi = (mdi_in==3) if !missing(mdi_in)
.     label var high_mdi "High MDI (mdi_in==3)"
. }

. else {
.     cap drop mdi_kl3 high_mdi
.     xtile mdi_kl3 = mdi_in, nq(3)
.     gen byte high_mdi = (mdi_kl3==3) if !missing(mdi_kl3)
.     label var high_mdi "High MDI (top tercile of mdi_in)"
. }

. 
. * ----------------------------
. * 7) Probability of "tidak layak" given high MDI and poverty
. * ----------------------------
. keep if !missing(tidak_layak, high_mdi, lnpov_near)
(0 observations deleted)

. 
. logit tidak_layak c.lnpov_near##i.high_mdi, vce(robust)

Iteration 0:   log pseudolikelihood = -116.44873  
Iteration 1:   log pseudolikelihood = -113.49621  
Iteration 2:   log pseudolikelihood = -113.48984  
Iteration 3:   log pseudolikelihood = -113.48984  

Logistic regression                                     Number of obs =    168
                                                        Wald chi2(3)  =   5.37
                                                        Prob > chi2   = 0.1467
Log pseudolikelihood = -113.48984                       Pseudo R2     = 0.0254

---------------------------------------------------------------------------------------
                      |               Robust
          tidak_layak | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
----------------------+----------------------------------------------------------------
           lnpov_near |  -.2865611   .1376181    -2.08   0.037    -.5562875   -.0168346
           1.high_mdi |  -.3551644    1.10543    -0.32   0.748    -2.521767    1.811438
                      |
high_mdi#c.lnpov_near |
                   1  |   .1239507   .2618312     0.47   0.636     -.389229    .6371303
                      |
                _cons |   1.133841   .6208017     1.83   0.068    -.0829078     2.35059
---------------------------------------------------------------------------------------

. estimates store M1

. 
. * lock the estimation sample before margins overwrites e(sample)
. gen byte sample_M1 = e(sample)

. label var sample_M1 "Estimation sample for M1"

. 
. summ lnpov_near if sample_M1, detail

                         lnpov_near
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0              0
 5%            0              0
10%     2.302585              0       Obs                 168
25%     3.433987              0       Sum of wgt.         168

50%     4.158883                      Mean           4.095712
                        Largest       Std. dev.       1.45013
75%     5.081404       6.259581
90%     5.828946       6.378426       Variance       2.102877
95%     5.998937       6.467699       Skewness      -.9924908
99%     6.467699       7.226936       Kurtosis       4.294965

. local p25 = r(p25)

. local p50 = r(p50)

. local p75 = r(p75)

. 
. margins high_mdi if sample_M1, at(lnpov_near=(`p25' `p50' `p75')) post

Adjusted predictions                                       Number of obs = 168
Model VCE: Robust

Expression: Pr(tidak_layak), predict()
1._at: lnpov_near = 3.433987
2._at: lnpov_near = 4.158883
3._at: lnpov_near = 5.081404

------------------------------------------------------------------------------
             |            Delta-method
             |     Margin   std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
_at#high_mdi |
        1 0  |   .5373787     .05629     9.55   0.000     .4270523    .6477051
        1 1  |   .5548471    .071927     7.71   0.000     .4138727    .6958215
        2 0  |   .4855208   .0485853     9.99   0.000     .3902954    .5807463
        2 1  |   .5255774   .0686002     7.66   0.000     .3911235    .6600314
        3 0  |   .4201174   .0542099     7.75   0.000      .313868    .5263668
        3 1  |   .4880991   .0933215     5.23   0.000     .3051924    .6710059
------------------------------------------------------------------------------

. estimates store Marg1

. 
. bys high_mdi: summ tidak_layak if sample_M1

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> high_mdi = 0

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 tidak_layak |        112    .4821429    .5019268          0          1

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> high_mdi = 1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 tidak_layak |         56    .5357143    .5032363          0          1


. 
. * Export outputs (restore logit results before predict)
. estimates restore M1
(results M1 are active now)

. predict double phat_M1 if sample_M1, pr

. label var phat_M1 "Predicted P(tidak layak) from logit"

. 
end of do-file

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$EQUI_XLSX", sheet("Summary_Model1") firstrow clear
(67 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Jawa          QuantilDO     CodeKL        TotalCAPEX    InflationG~h  IRRClean      IRR20tahun    AH            AL            AP            AT            AX            BB            BF            BJ            BN
Kelembagaa~i  Pelabuhan     Code          CodeKL2       CodeCAP       WACC          PP            AE            AI            AM            AQ            AU            AY            BC            BG            BK            BO
Tipe          MDI           MOR           GrossProfi~P  SalesGrowth   NPV10tahun    LayakTidak~k  AF            AJ            AN            AR            AV            AZ            BD            BH            BL
Pulau         StatusLK      PenjualanK~i  GrossProfi~l  UMKGrowth     IRR10tahun    NPV20tahun    AG            AK            AO            AS            AW            BA            BE            BI            BM

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. rename MDI mdi_in

. rename spbun_id site_id

. 
. keep site_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. if _rc ssc install geonear, replace

. 
. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.514
-------------------------------------------------------------------------------

. 
. rename nid iddesa

. rename km_to_nid dist_km

. 
. keep site_id lat_s lon_s iddesa dist_km

. tempfile spbun_nn

. save `spbun_nn', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 saved as .dta format

. 
. use `villages', clear

. keep iddesa lnpov

. rename lnpov lnpov_near

. tempfile vill_pov

. save `vill_pov', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. 
. use `spbun_nn', clear

. merge m:1 iddesa using `vill_pov', keep(match master) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               374  
    -----------------------------------------

. save `spbun_near', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 saved as .dta format

. 
. * ----------------------------
. * 5) Merge nearest-poverty with SURVIVAL (viability + MDI)
. * ----------------------------
. use `spbun_near', clear

. merge 1:1 site_id using `surv', keep(match master) nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                           206
        from master                       206  
        from using                          0  

    Matched                               168  
    -----------------------------------------

. save `merged_final', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000005 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000005 saved as .dta format

. 
. * ----------------------------
. * 6) High MDI definition (follow MDI.do if components exist; else use mdi_in)
. * ----------------------------
. use `merged_final', clear

. drop if PP == .
(206 observations deleted)

. 
. capture assert inlist(mdi_in,1,2,3) if !missing(mdi_in)

. if _rc==0 {
.     gen byte high_mdi = (mdi_in==3) if !missing(mdi_in)
.     label var high_mdi "High MDI (mdi_in==3)"
. }

. else {
.     cap drop mdi_kl3 high_mdi
.     xtile mdi_kl3 = mdi_in, nq(3)
.     gen byte high_mdi = (mdi_kl3==3) if !missing(mdi_kl3)
.     label var high_mdi "High MDI (top tercile of mdi_in)"
. }

. 
. * ----------------------------
. * 7) Probability of "tidak layak" given high MDI and poverty
. * ----------------------------
. keep if !missing(tidak_layak, high_mdi, lnpov_near)
(0 observations deleted)

. 
. logit tidak_layak c.lnpov_near##i.high_mdi, vce(robust)

Iteration 0:   log pseudolikelihood = -116.34156  
Iteration 1:   log pseudolikelihood = -114.13666  
Iteration 2:   log pseudolikelihood = -114.13356  
Iteration 3:   log pseudolikelihood = -114.13356  

Logistic regression                                     Number of obs =    168
                                                        Wald chi2(3)  =   4.10
                                                        Prob > chi2   = 0.2509
Log pseudolikelihood = -114.13356                       Pseudo R2     = 0.0190

---------------------------------------------------------------------------------------
                      |               Robust
          tidak_layak | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
----------------------+----------------------------------------------------------------
           lnpov_near |  -.2352329   .1337016    -1.76   0.079    -.4972833    .0268176
           1.high_mdi |  -.1097481   1.113905    -0.10   0.922    -2.292961    2.073465
                      |
high_mdi#c.lnpov_near |
                   1  |   .0651495   .2639831     0.25   0.805    -.4522479    .5825469
                      |
                _cons |   .9905589   .6013415     1.65   0.100    -.1880488    2.169167
---------------------------------------------------------------------------------------

. estimates store M1

. 
. * lock the estimation sample before margins overwrites e(sample)
. gen byte sample_M1 = e(sample)

. label var sample_M1 "Estimation sample for M1"

. 
. summ lnpov_near if sample_M1, detail

                         lnpov_near
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0              0
 5%            0              0
10%     2.302585              0       Obs                 168
25%     3.433987              0       Sum of wgt.         168

50%     4.158883                      Mean           4.095712
                        Largest       Std. dev.       1.45013
75%     5.081404       6.259581
90%     5.828946       6.378426       Variance       2.102877
95%     5.998937       6.467699       Skewness      -.9924908
99%     6.467699       7.226936       Kurtosis       4.294965

. local p25 = r(p25)

. local p50 = r(p50)

. local p75 = r(p75)

. 
. margins high_mdi if sample_M1, at(lnpov_near=(`p25' `p50' `p75')) post

Adjusted predictions                                       Number of obs = 168
Model VCE: Robust

Expression: Pr(tidak_layak), predict()
1._at: lnpov_near = 3.433987
2._at: lnpov_near = 4.158883
3._at: lnpov_near = 5.081404

------------------------------------------------------------------------------
             |            Delta-method
             |     Margin   std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
_at#high_mdi |
        1 0  |   .5455663   .0550166     9.92   0.000     .4377357    .6533969
        1 1  |    .573647   .0720973     7.96   0.000      .432339     .714955
        2 0  |   .5030632   .0482144    10.43   0.000     .4085647    .5975617
        2 1  |   .5432551   .0683372     7.95   0.000     .4093166    .6771936
        3 0  |   .4489895   .0547825     8.20   0.000     .3416178    .5563612
        3 1  |    .504137   .0937128     5.38   0.000     .3204632    .6878108
------------------------------------------------------------------------------

. estimates store Marg1

. 
. bys high_mdi: summ tidak_layak if sample_M1

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> high_mdi = 0

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 tidak_layak |        112          .5    .5022472          0          1

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> high_mdi = 1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 tidak_layak |         56    .5535714    .5016207          0          1


. 
. * Export outputs (restore logit results before predict)
. estimates restore M1
(results M1 are active now)

. predict double phat_M1 if sample_M1, pr

. label var phat_M1 "Predicted P(tidak layak) from logit"

. 
end of do-file

. margins, dydx(high_mdi) at(lnpov_near=(`p25' `p50' `p75'))
invalid numlist has too few elements
r(122);

. 
. * after logit and after defining sample_M1

. summ lnpov_near if sample_M1, detail

                         lnpov_near
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0              0
 5%            0              0
10%     2.302585              0       Obs                 168
25%     3.433987              0       Sum of wgt.         168

50%     4.158883                      Mean           4.095712
                        Largest       Std. dev.       1.45013
75%     5.081404       6.259581
90%     5.828946       6.378426       Variance       2.102877
95%     5.998937       6.467699       Skewness      -.9924908
99%     6.467699       7.226936       Kurtosis       4.294965

. local p25 = r(p25)

. local p50 = r(p50)

. local p75 = r(p75)

. 
. di "`p25' `p50' `p75'"   // sanity check: must print 3 numbers
3.433987204485146 4.158883083359671 5.081404364984463sanity not found
r(111);

. 
. margins, dydx(high_mdi) if sample_M1 at(lnpov_near=(`p25' `p50' `p75'))
option if not allowed
r(198);

. 
. do "/var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//SD00943.000000"

. * 0) PATHS
. * ----------------------------
. 
end of do-file

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$EQUI_XLSX", sheet("Summary_Model1") firstrow clear
(67 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Jawa          QuantilDO     CodeKL        TotalCAPEX    InflationG~h  IRRClean      IRR20tahun    AH            AL            AP            AT            AX            BB            BF            BJ            BN
Kelembagaa~i  Pelabuhan     Code          CodeKL2       CodeCAP       WACC          PP            AE            AI            AM            AQ            AU            AY            BC            BG            BK            BO
Tipe          MDI           MOR           GrossProfi~P  SalesGrowth   NPV10tahun    LayakTidak~k  AF            AJ            AN            AR            AV            AZ            BD            BH            BL
Pulau         StatusLK      PenjualanK~i  GrossProfi~l  UMKGrowth     IRR10tahun    NPV20tahun    AG            AK            AO            AS            AW            BA            BE            BI            BM

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. rename MDI mdi_in

. rename spbun_id site_id

. 
. keep site_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. if _rc ssc install geonear, replace

. 
. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.512
-------------------------------------------------------------------------------

. 
. rename nid iddesa

. rename km_to_nid dist_km

. 
. keep site_id lat_s lon_s iddesa dist_km

. tempfile spbun_nn

. save `spbun_nn', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 saved as .dta format

. 
. use `villages', clear

. keep iddesa lnpov

. rename lnpov lnpov_near

. tempfile vill_pov

. save `vill_pov', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. 
. use `spbun_nn', clear

. merge m:1 iddesa using `vill_pov', keep(match master) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               374  
    -----------------------------------------

. save `spbun_near', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 saved as .dta format

. 
. * ----------------------------
. * 5) Merge nearest-poverty with SURVIVAL (viability + MDI)
. * ----------------------------
. use `spbun_near', clear

. merge 1:1 site_id using `surv', keep(match master) nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                           206
        from master                       206  
        from using                          0  

    Matched                               168  
    -----------------------------------------

. save `merged_final', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000005 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000005 saved as .dta format

. 
. * ----------------------------
. * 6) High MDI definition (follow MDI.do if components exist; else use mdi_in)
. * ----------------------------
. use `merged_final', clear

. drop if PP == .
(206 observations deleted)

. 
. capture assert inlist(mdi_in,1,2,3) if !missing(mdi_in)

. if _rc==0 {
.     gen byte high_mdi = (mdi_in==3) if !missing(mdi_in)
.     label var high_mdi "High MDI (mdi_in==3)"
. }

. else {
.     cap drop mdi_kl3 high_mdi
.     xtile mdi_kl3 = mdi_in, nq(3)
.     gen byte high_mdi = (mdi_kl3==3) if !missing(mdi_kl3)
.     label var high_mdi "High MDI (top tercile of mdi_in)"
. }

. 
. * ----------------------------
. * 7) Probability of "tidak layak" given high MDI and poverty
. * ----------------------------
. keep if !missing(tidak_layak, high_mdi, lnpov_near)
(0 observations deleted)

. 
. logit tidak_layak c.lnpov_near##i.high_mdi, vce(robust)

Iteration 0:   log pseudolikelihood = -116.34156  
Iteration 1:   log pseudolikelihood = -114.13666  
Iteration 2:   log pseudolikelihood = -114.13356  
Iteration 3:   log pseudolikelihood = -114.13356  

Logistic regression                                     Number of obs =    168
                                                        Wald chi2(3)  =   4.10
                                                        Prob > chi2   = 0.2509
Log pseudolikelihood = -114.13356                       Pseudo R2     = 0.0190

---------------------------------------------------------------------------------------
                      |               Robust
          tidak_layak | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
----------------------+----------------------------------------------------------------
           lnpov_near |  -.2352329   .1337016    -1.76   0.079    -.4972833    .0268176
           1.high_mdi |  -.1097481   1.113905    -0.10   0.922    -2.292961    2.073465
                      |
high_mdi#c.lnpov_near |
                   1  |   .0651495   .2639831     0.25   0.805    -.4522479    .5825469
                      |
                _cons |   .9905589   .6013415     1.65   0.100    -.1880488    2.169167
---------------------------------------------------------------------------------------

. estimates store M1

. 
. * lock the estimation sample before margins overwrites e(sample)
. gen byte sample_M1 = e(sample)

. label var sample_M1 "Estimation sample for M1"

. 
. summ lnpov_near if sample_M1, detail

                         lnpov_near
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0              0
 5%            0              0
10%     2.302585              0       Obs                 168
25%     3.433987              0       Sum of wgt.         168

50%     4.158883                      Mean           4.095712
                        Largest       Std. dev.       1.45013
75%     5.081404       6.259581
90%     5.828946       6.378426       Variance       2.102877
95%     5.998937       6.467699       Skewness      -.9924908
99%     6.467699       7.226936       Kurtosis       4.294965

. local p25 = r(p25)

. local p50 = r(p50)

. local p75 = r(p75)

. 
. margins high_mdi if sample_M1, at(lnpov_near=(`p25' `p50' `p75')) post

Adjusted predictions                                       Number of obs = 168
Model VCE: Robust

Expression: Pr(tidak_layak), predict()
1._at: lnpov_near = 3.433987
2._at: lnpov_near = 4.158883
3._at: lnpov_near = 5.081404

------------------------------------------------------------------------------
             |            Delta-method
             |     Margin   std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
_at#high_mdi |
        1 0  |   .5455663   .0550166     9.92   0.000     .4377357    .6533969
        1 1  |    .573647   .0720973     7.96   0.000      .432339     .714955
        2 0  |   .5030632   .0482144    10.43   0.000     .4085647    .5975617
        2 1  |   .5432551   .0683372     7.95   0.000     .4093166    .6771936
        3 0  |   .4489895   .0547825     8.20   0.000     .3416178    .5563612
        3 1  |    .504137   .0937128     5.38   0.000     .3204632    .6878108
------------------------------------------------------------------------------

. estimates store Marg1

. 
. bys high_mdi: summ tidak_layak if sample_M1

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> high_mdi = 0

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 tidak_layak |        112          .5    .5022472          0          1

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> high_mdi = 1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 tidak_layak |         56    .5535714    .5016207          0          1


. 
. margins, dydx(high_mdi) if sample_M1 at(lnpov_near=(`p25' `p50' `p75'))
option dydx() not allowed
r(198);

end of do-file

r(198);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. rename MDI mdi_in

. rename spbun_id site_id

. 
. keep site_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. if _rc ssc install geonear, replace

. 
. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.469
-------------------------------------------------------------------------------

. 
. rename nid iddesa

. rename km_to_nid dist_km

. 
. keep site_id lat_s lon_s iddesa dist_km

. tempfile spbun_nn

. save `spbun_nn', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 saved as .dta format

. 
. use `villages', clear

. keep iddesa lnpov

. rename lnpov lnpov_near

. tempfile vill_pov

. save `vill_pov', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. 
. use `spbun_nn', clear

. merge m:1 iddesa using `vill_pov', keep(match master) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               374  
    -----------------------------------------

. save `spbun_near', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 saved as .dta format

. 
. * ----------------------------
. * 5) Merge nearest-poverty with SURVIVAL (viability + MDI)
. * ----------------------------
. use `spbun_near', clear

. merge 1:1 site_id using `surv', keep(match master) nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                           206
        from master                       206  
        from using                          0  

    Matched                               168  
    -----------------------------------------

. save `merged_final', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000005 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000005 saved as .dta format

. 
. * ----------------------------
. * 6) High MDI definition (follow MDI.do if components exist; else use mdi_in)
. * ----------------------------
. use `merged_final', clear

. drop if PP == .
(206 observations deleted)

. 
. capture assert inlist(mdi_in,1,2,3) if !missing(mdi_in)

. if _rc==0 {
.     gen byte high_mdi = (mdi_in==3) if !missing(mdi_in)
.     label var high_mdi "High MDI (mdi_in==3)"
. }

. else {
.     cap drop mdi_kl3 high_mdi
.     xtile mdi_kl3 = mdi_in, nq(3)
.     gen byte high_mdi = (mdi_kl3==3) if !missing(mdi_kl3)
.     label var high_mdi "High MDI (top tercile of mdi_in)"
. }

. 
. * ----------------------------
. * 7) Probability of "tidak layak" given high MDI and poverty
. * ----------------------------
. keep if !missing(tidak_layak, high_mdi, lnpov_near)
(0 observations deleted)

. 
. logit tidak_layak c.lnpov_near##i.high_mdi, vce(robust)

Iteration 0:   log pseudolikelihood = -114.10447  
Iteration 1:   log pseudolikelihood = -102.31821  
Iteration 2:   log pseudolikelihood = -102.09019  
Iteration 3:   log pseudolikelihood = -102.08856  
Iteration 4:   log pseudolikelihood = -102.08856  

Logistic regression                                     Number of obs =    168
                                                        Wald chi2(3)  =  21.02
                                                        Prob > chi2   = 0.0001
Log pseudolikelihood = -102.08856                       Pseudo R2     = 0.1053

---------------------------------------------------------------------------------------
                      |               Robust
          tidak_layak | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
----------------------+----------------------------------------------------------------
           lnpov_near |   -.350389   .1476519    -2.37   0.018    -.6397815   -.0609965
           1.high_mdi |   1.692439   1.344827     1.26   0.208    -.9433724    4.328251
                      |
high_mdi#c.lnpov_near |
                   1  |  -.0907861   .3072992    -0.30   0.768    -.6930815    .5115093
                      |
                _cons |   1.404643   .6676662     2.10   0.035     .0960414    2.713245
---------------------------------------------------------------------------------------

. estimates store M1

. 
. * lock the estimation sample before margins overwrites e(sample)
. gen byte sample_M1 = e(sample)

. label var sample_M1 "Estimation sample for M1"

. 
. summ lnpov_near if sample_M1, detail

                         lnpov_near
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0              0
 5%            0              0
10%     2.302585              0       Obs                 168
25%     3.433987              0       Sum of wgt.         168

50%     4.158883                      Mean           4.095712
                        Largest       Std. dev.       1.45013
75%     5.081404       6.259581
90%     5.828946       6.378426       Variance       2.102877
95%     5.998937       6.467699       Skewness      -.9924908
99%     6.467699       7.226936       Kurtosis       4.294965

. local p25 = r(p25)

. local p50 = r(p50)

. local p75 = r(p75)

. 
. margins high_mdi if sample_M1, at(lnpov_near=(`p25' `p50' `p75')) post

Adjusted predictions                                       Number of obs = 168
Model VCE: Robust

Expression: Pr(tidak_layak), predict()
1._at: lnpov_near = 3.433987
2._at: lnpov_near = 4.158883
3._at: lnpov_near = 5.081404

------------------------------------------------------------------------------
             |            Delta-method
             |     Margin   std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
_at#high_mdi |
        1 0  |   .5501834    .058259     9.44   0.000     .4359979    .6643689
        1 1  |   .8295007   .0544482    15.23   0.000     .7227841    .9362173
        2 0  |   .4868571   .0491712     9.90   0.000     .3904833    .5832309
        2 1  |   .7794195    .057226    13.62   0.000     .6672585    .8915805
        3 0  |   .4071343   .0543209     7.49   0.000     .3006672    .5136013
        3 1  |   .7016764   .0872049     8.05   0.000     .5307579    .8725949
------------------------------------------------------------------------------

. estimates store Marg1

. 
. bys high_mdi: summ tidak_layak if sample_M1

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> high_mdi = 0

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 tidak_layak |        112    .4821429    .5019268          0          1

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> high_mdi = 1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 tidak_layak |         56    .7857143    .4140393          0          1


. 
. margins, dydx(high_mdi) if sample_M1 at(lnpov_near=(`p25' `p50' `p75'))
option dydx() not allowed
r(198);

end of do-file

r(198);

. di "`p25' `p50' `p75'"
3.433987204485146 4.158883083359671 5.081404364984463

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. rename MDI mdi_in

. rename spbun_id site_id

. 
. keep site_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. if _rc ssc install geonear, replace

. 
. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.601
-------------------------------------------------------------------------------

. 
. rename nid iddesa

. rename km_to_nid dist_km

. 
. keep site_id lat_s lon_s iddesa dist_km

. tempfile spbun_nn

. save `spbun_nn', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 saved as .dta format

. 
. use `villages', clear

. keep iddesa lnpov

. rename lnpov lnpov_near

. tempfile vill_pov

. save `vill_pov', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. 
. use `spbun_nn', clear

. merge m:1 iddesa using `vill_pov', keep(match master) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               374  
    -----------------------------------------

. save `spbun_near', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 saved as .dta format

. 
. * ----------------------------
. * 5) Merge nearest-poverty with SURVIVAL (viability + MDI)
. * ----------------------------
. use `spbun_near', clear

. merge 1:1 site_id using `surv', keep(match master) nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                           206
        from master                       206  
        from using                          0  

    Matched                               168  
    -----------------------------------------

. save `merged_final', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000005 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000005 saved as .dta format

. 
. * ----------------------------
. * 6) High MDI definition (follow MDI.do if components exist; else use mdi_in)
. * ----------------------------
. use `merged_final', clear

. drop if PP == .
(206 observations deleted)

. 
. capture assert inlist(mdi_in,1,2,3) if !missing(mdi_in)

. if _rc==0 {
.     gen byte high_mdi = (mdi_in==3) if !missing(mdi_in)
.     label var high_mdi "High MDI (mdi_in==3)"
. }

. else {
.     cap drop mdi_kl3 high_mdi
.     xtile mdi_kl3 = mdi_in, nq(3)
.     gen byte high_mdi = (mdi_kl3==3) if !missing(mdi_kl3)
.     label var high_mdi "High MDI (top tercile of mdi_in)"
. }

. 
. * ----------------------------
. * 7) Probability of "tidak layak" given high MDI and poverty
. * ----------------------------
. keep if !missing(tidak_layak, high_mdi, lnpov_near)
(0 observations deleted)

. 
. logit tidak_layak c.lnpov_near##i.high_mdi, vce(robust)

Iteration 0:   log pseudolikelihood = -114.10447  
Iteration 1:   log pseudolikelihood = -102.31821  
Iteration 2:   log pseudolikelihood = -102.09019  
Iteration 3:   log pseudolikelihood = -102.08856  
Iteration 4:   log pseudolikelihood = -102.08856  

Logistic regression                                     Number of obs =    168
                                                        Wald chi2(3)  =  21.02
                                                        Prob > chi2   = 0.0001
Log pseudolikelihood = -102.08856                       Pseudo R2     = 0.1053

---------------------------------------------------------------------------------------
                      |               Robust
          tidak_layak | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
----------------------+----------------------------------------------------------------
           lnpov_near |   -.350389   .1476519    -2.37   0.018    -.6397815   -.0609965
           1.high_mdi |   1.692439   1.344827     1.26   0.208    -.9433724    4.328251
                      |
high_mdi#c.lnpov_near |
                   1  |  -.0907861   .3072992    -0.30   0.768    -.6930815    .5115093
                      |
                _cons |   1.404643   .6676662     2.10   0.035     .0960414    2.713245
---------------------------------------------------------------------------------------

. estimates store M1

. 
. * lock estimation sample
. gen byte sample_M1 = e(sample)

. label var sample_M1 "Estimation sample for M1"

. 
. * poverty points (within estimation sample)
. quietly summ lnpov_near if sample_M1, detail

. local p25 = r(p25)

. local p50 = r(p50)

. local p75 = r(p75)

. 
. * (A) Predicted probabilities by high_mdi at p25/p50/p75
. margins high_mdi if sample_M1, at(lnpov_near=(`p25' `p50' `p75')) post

Adjusted predictions                                       Number of obs = 168
Model VCE: Robust

Expression: Pr(tidak_layak), predict()
1._at: lnpov_near = 3.433987
2._at: lnpov_near = 4.158883
3._at: lnpov_near = 5.081404

------------------------------------------------------------------------------
             |            Delta-method
             |     Margin   std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
_at#high_mdi |
        1 0  |   .5501834    .058259     9.44   0.000     .4359979    .6643689
        1 1  |   .8295007   .0544482    15.23   0.000     .7227841    .9362173
        2 0  |   .4868571   .0491712     9.90   0.000     .3904833    .5832309
        2 1  |   .7794195    .057226    13.62   0.000     .6672585    .8915805
        3 0  |   .4071343   .0543209     7.49   0.000     .3006672    .5136013
        3 1  |   .7016764   .0872049     8.05   0.000     .5307579    .8725949
------------------------------------------------------------------------------

. estimates store Marg_prob

. 
. * return to logit before dydx()
. estimates restore M1
(results M1 are active now)

. 
. * (B) Discrete change: high_mdi=1 minus 0 at p25/p50/p75
. margins, dydx(high_mdi) if sample_M1 at(lnpov_near=(`p25' `p50' `p75')) post
option if not allowed
r(198);

end of do-file

r(198);

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. rename MDI mdi_in

. rename spbun_id site_id

. 
. keep site_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. if _rc ssc install geonear, replace

. 
. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.935
-------------------------------------------------------------------------------

. 
. rename nid iddesa

. rename km_to_nid dist_km

. 
. keep site_id lat_s lon_s iddesa dist_km

. tempfile spbun_nn

. save `spbun_nn', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 saved as .dta format

. 
. use `villages', clear

. keep iddesa lnpov

. rename lnpov lnpov_near

. tempfile vill_pov

. save `vill_pov', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. 
. use `spbun_nn', clear

. merge m:1 iddesa using `vill_pov', keep(match master) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               374  
    -----------------------------------------

. save `spbun_near', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 saved as .dta format

. 
. * ----------------------------
. * 5) Merge nearest-poverty with SURVIVAL (viability + MDI)
. * ----------------------------
. use `spbun_near', clear

. merge 1:1 site_id using `surv', keep(match master) nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                           206
        from master                       206  
        from using                          0  

    Matched                               168  
    -----------------------------------------

. save `merged_final', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000005 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000005 saved as .dta format

. 
. * ----------------------------
. * 6) High MDI definition (follow MDI.do if components exist; else use mdi_in)
. * ----------------------------
. use `merged_final', clear

. drop if PP == .
(206 observations deleted)

. 
. capture assert inlist(mdi_in,1,2,3) if !missing(mdi_in)

. if _rc==0 {
.     gen byte high_mdi = (mdi_in==3) if !missing(mdi_in)
.     label var high_mdi "High MDI (mdi_in==3)"
. }

. else {
.     cap drop mdi_kl3 high_mdi
.     xtile mdi_kl3 = mdi_in, nq(3)
.     gen byte high_mdi = (mdi_kl3==3) if !missing(mdi_kl3)
.     label var high_mdi "High MDI (top tercile of mdi_in)"
. }

. 
. * ----------------------------
. * 7) Probability of "tidak layak" given high MDI and poverty
. * ----------------------------
. keep if !missing(tidak_layak, high_mdi, lnpov_near)
(0 observations deleted)

. 
. logit tidak_layak c.lnpov_near##i.high_mdi, vce(robust)

Iteration 0:   log pseudolikelihood = -114.10447  
Iteration 1:   log pseudolikelihood = -102.31821  
Iteration 2:   log pseudolikelihood = -102.09019  
Iteration 3:   log pseudolikelihood = -102.08856  
Iteration 4:   log pseudolikelihood = -102.08856  

Logistic regression                                     Number of obs =    168
                                                        Wald chi2(3)  =  21.02
                                                        Prob > chi2   = 0.0001
Log pseudolikelihood = -102.08856                       Pseudo R2     = 0.1053

---------------------------------------------------------------------------------------
                      |               Robust
          tidak_layak | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
----------------------+----------------------------------------------------------------
           lnpov_near |   -.350389   .1476519    -2.37   0.018    -.6397815   -.0609965
           1.high_mdi |   1.692439   1.344827     1.26   0.208    -.9433724    4.328251
                      |
high_mdi#c.lnpov_near |
                   1  |  -.0907861   .3072992    -0.30   0.768    -.6930815    .5115093
                      |
                _cons |   1.404643   .6676662     2.10   0.035     .0960414    2.713245
---------------------------------------------------------------------------------------

. estimates store M1

. 
. * lock estimation sample
. gen byte sample_M1 = e(sample)

. label var sample_M1 "Estimation sample for M1"

. 
. * poverty points (within estimation sample)
. quietly summ lnpov_near if sample_M1, detail

. local p25 = r(p25)

. local p50 = r(p50)

. local p75 = r(p75)

. 
. * (A) Predicted probabilities by high_mdi at p25/p50/p75
. margins high_mdi if sample_M1, at(lnpov_near=(`p25' `p50' `p75')) post

Adjusted predictions                                       Number of obs = 168
Model VCE: Robust

Expression: Pr(tidak_layak), predict()
1._at: lnpov_near = 3.433987
2._at: lnpov_near = 4.158883
3._at: lnpov_near = 5.081404

------------------------------------------------------------------------------
             |            Delta-method
             |     Margin   std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
_at#high_mdi |
        1 0  |   .5501834    .058259     9.44   0.000     .4359979    .6643689
        1 1  |   .8295007   .0544482    15.23   0.000     .7227841    .9362173
        2 0  |   .4868571   .0491712     9.90   0.000     .3904833    .5832309
        2 1  |   .7794195    .057226    13.62   0.000     .6672585    .8915805
        3 0  |   .4071343   .0543209     7.49   0.000     .3006672    .5136013
        3 1  |   .7016764   .0872049     8.05   0.000     .5307579    .8725949
------------------------------------------------------------------------------

. estimates store Marg_prob

. 
. * (B) Discrete change: high_mdi=1 minus 0 at p25/p50/p75
. estimates restore M1
(results M1 are active now)

. margins if sample_M1, dydx(high_mdi) at(lnpov_near=(`p25' `p50' `p75')) post

Conditional marginal effects                               Number of obs = 168
Model VCE: Robust

Expression: Pr(tidak_layak), predict()
dy/dx wrt:  1.high_mdi
1._at: lnpov_near = 3.433987
2._at: lnpov_near = 4.158883
3._at: lnpov_near = 5.081404

------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
0.high_mdi   |  (base outcome)
-------------+----------------------------------------------------------------
1.high_mdi   |
         _at |
          1  |   .2793173   .0797416     3.50   0.000     .1230266    .4356079
          2  |   .2925624   .0754495     3.88   0.000     .1446841    .4404407
          3  |   .2945421   .1027398     2.87   0.004     .0931759    .4959083
------------------------------------------------------------------------------
Note: dy/dx for factor levels is the discrete change from the base level.

. estimates store Marg_dydx

. 
. * simple descriptive check
. bys high_mdi: summ tidak_layak if sample_M1

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> high_mdi = 0

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 tidak_layak |        112    .4821429    .5019268          0          1

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> high_mdi = 1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 tidak_layak |         56    .7857143    .4140393          0          1


. 
. * predictions for export
. estimates restore M1
(results M1 are active now)

. predict double phat_M1 if sample_M1, pr

. label var phat_M1 "Predicted P(tidak layak) from logit"

. 
. * ----------------------------
. * Export RTF outputs (logit + margins tables)
. * ----------------------------
. cap which esttab

. if _rc {
.     cap ssc install estout, replace
. }

. 
. cap which esttab

. if !_rc {
.     esttab M1 using "$OUTDIR/logit_tidaklayak.rtf", replace ///
>         b(%9.4f) se(%9.4f) star(* 0.10 ** 0.05 *** 0.01) ///
>         stats(N ll, fmt(%9.0g %9.3f) labels("N" "LogLik")) ///
>         title("Logit: P(SPBUN tidak layak) ~ poverty (nearest) x High MDI")
(file /Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/Output/MDI-Check/logit_tidaklayak.rtf not found)
(output written to /Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/Output/MDI-Check/logit_tidaklayak.rtf)
. 
.     esttab Marg_prob using "$OUTDIR/margins_pr_tidaklayak.rtf", replace ///
>         cells("b(fmt(4)) se(fmt(4))") ///
>         title("Margins: Pr(tidak_layak) by High MDI at p25/p50/p75 of lnpov_near")
(file /Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/Output/MDI-Check/margins_pr_tidaklayak.rtf not found)
(output written to /Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/Output/MDI-Check/margins_pr_tidaklayak.rtf)
. 
.     esttab Marg_dydx using "$OUTDIR/margins_dydx_highmdi.rtf", replace ///
>         cells("b(fmt(4)) se(fmt(4))") ///
>         title("Margins: dydx(high_mdi) at p25/p50/p75 of lnpov_near")
(file /Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/Output/MDI-Check/margins_dydx_highmdi.rtf not found)
(output written to /Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/Output/MDI-Check/margins_dydx_highmdi.rtf)
. }

. else {
.     di as err "esttab not available; RTF tables not written. Try: ssc install estout"
. }

. 
end of do-file

. reg PP i.high_mdi##c.lnpov_near if sample_M1, vce(robust)

Linear regression                               Number of obs     =        168
                                                F(3, 164)         =       5.90
                                                Prob > F          =     0.0008
                                                R-squared         =     0.0914
                                                Root MSE          =     15.425

---------------------------------------------------------------------------------------
                      |               Robust
                   PP | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
----------------------+----------------------------------------------------------------
           1.high_mdi |   7.267156   8.649059     0.84   0.402    -9.810711    24.34502
           lnpov_near |  -1.915363   .9822425    -1.95   0.053    -3.854835    .0241085
                      |
high_mdi#c.lnpov_near |
                   1  |   .1709126   2.055628     0.08   0.934    -3.887997    4.229822
                      |
                _cons |   20.28288   4.751311     4.27   0.000     10.90126    29.66451
---------------------------------------------------------------------------------------

. tab mdi_in

        MDI |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |         56       33.33       33.33
          2 |         56       33.33       66.67
          3 |         56       33.33      100.00
------------+-----------------------------------
      Total |        168      100.00

. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/MDI-Check.do"

. /****************************************************************************************
> SPBUN – Location Match, Nearest-Village Poverty Attach, and P(tidak layak | MDI, poverty)
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. 
. * ----------------------------
. * 0) PATHS
. * ----------------------------
. global BASE_DIR     "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. global SPBUN_XLSX   "$BASE_DIR/lokasi_spbu-n.xlsx"

. global PODES_DTA    "$BASE_DIR/Output/podes_modelA_ready.dta"

. global SURV_XLSX    "$BASE_DIR/01Survival-mode"

. global MIXED_XLSX   "$BASE_DIR/02Mix-mode"

. global EQUI_XLSX    "$BASE_DIR/00Equitable-mode"

. 
. global OUTDIR       "$BASE_DIR/Output/MDI-Check"

. cap mkdir                       "$OUTDIR"

. 
. tempfile spbun_loc villages surv spbun_near merged_final

. 
. * ----------------------------
. * 1) SPBUN location master (match by SPBUN id)
. * ----------------------------
. tempfile spbun_site

. import excel "$SPBUN_XLSX", sheet("Data") firstrow clear
(20 vars, 1,742 obs)

. 
. capture confirm variable Koordinat

. rename Koordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(0 real changes made)

. 
. gen strL coord = titik_koordinat
(1,364 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(1,364 missing values generated)

. gen double lon_s = real(_c2)
(1,367 missing values generated)

. drop _c* coord

. 
. * swap if obviously reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(1,364 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(1,367 observations deleted)

. 
. gen long site_id = NoLembagaPenyalur

. keep site_id lat_s lon_s 

. save `spbun_loc', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. * ----------------------------
. * 2) SURVIVAL (viability + MDI), keyed by SPBUN id
. * ----------------------------
. import excel using "$SURV_XLSX", sheet("Summary_Model1") firstrow clear
(32 vars, 169 obs)

. rename NomorSPBUN spbun_id

. 
. local vlay ""

. ds, has(type numeric)
spbun_id      Tipe          Jawa          MDI           QuantilDO     MOR           CodeKL        GrossProfi~P  TotalCAPEX    SalesGrowth   InflationG~h  NPV10tahun    IRRClean      LayakTidak~k  IRR20tahun    AF
Kelembagaa~i  Pulau         Pelabuhan     StatusLK      Code          PenjualanK~i  CodeKL2       GrossProfi~l  CodeCAP       UMKGrowth     WACC          IRR10tahun    PP            NPV20tahun    AE

. foreach v in `r(varlist)' {
  2.     if strpos(lower("`v'"), "layak") & strpos(lower("`v'"), "tidak") local vlay "`v'"
  3. }

. rename `vlay' layak_flag

. gen byte tidak_layak = (layak_flag==0) if !missing(layak_flag)

. 
. cap confirm var MDI

. rename MDI mdi_in

. rename spbun_id site_id

. 
. keep site_id tidak_layak layak_flag mdi_in TotalCAPEX WACC PP

. save `surv', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000003 saved as .dta format

. 
. * ----------------------------
. * 3) VILLAGE (PODES): coords + poverty index (lnpov)
. * ----------------------------
. use "$PODES_DTA", clear

. keep iddesa lat_v lon_v lnpov nama_prov nama_kab nama_kec nama_desa

. drop if missing(iddesa) | missing(lat_v) | missing(lon_v) | missing(lnpov)
(0 observations deleted)

. save `villages', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000002 saved as .dta format

. 
. * ----------------------------
. * 4) Attach nearest-village poverty to each SPBUN (1 closest point)
. * ----------------------------
. cap which geonear

. if _rc ssc install geonear, replace

. 
. use `spbun_loc', clear

. drop if site_id==5885103
(1 observation deleted)

. save `spbun_loc', replace
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000001 saved as .dta format

. 
. geonear site_id lat_s lon_s using `villages', ///
>     neighbors(iddesa lat_v lon_v) nearcount(1) wide

-------------------------------------------------------------------------------
Unique base locations   = 374            Unique neighbor locations = 84,276    
Bases * Neighbors  (M)  = 31.5           Number of regions         = 58        
Computed distances (M)  = 1.25           Total run time (seconds)  = 1.488
-------------------------------------------------------------------------------

. 
. rename nid iddesa

. rename km_to_nid dist_km

. 
. keep site_id lat_s lon_s iddesa dist_km

. tempfile spbun_nn

. save `spbun_nn', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000007 saved as .dta format

. 
. use `villages', clear

. keep iddesa lnpov

. rename lnpov lnpov_near

. tempfile vill_pov

. save `vill_pov', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000008 saved as .dta format

. 
. use `spbun_nn', clear

. merge m:1 iddesa using `vill_pov', keep(match master) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               374  
    -----------------------------------------

. save `spbun_near', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000004 saved as .dta format

. 
. * ----------------------------
. * 5) Merge nearest-poverty with SURVIVAL (viability + MDI)
. * ----------------------------
. use `spbun_near', clear

. merge 1:1 site_id using `surv', keep(match master) nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                           206
        from master                       206  
        from using                          0  

    Matched                               168  
    -----------------------------------------

. drop if PP == .
(206 observations deleted)

. save `merged_final', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000005 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_00943.000005 saved as .dta format

. 
. * ----------------------------
. * 6) Probability of "tidak layak" given high MDI and poverty
. * ----------------------------
. keep if !missing(tidak_layak, mdi_in, lnpov_near)
(0 observations deleted)

. 
. logit tidak_layak c.lnpov_near##i.mdi_in, vce(robust)

Iteration 0:   log pseudolikelihood = -114.10447  
Iteration 1:   log pseudolikelihood = -100.02295  
Iteration 2:   log pseudolikelihood = -99.750098  
Iteration 3:   log pseudolikelihood = -99.748122  
Iteration 4:   log pseudolikelihood = -99.748122  

Logistic regression                                     Number of obs =    168
                                                        Wald chi2(5)  =  25.86
                                                        Prob > chi2   = 0.0001
Log pseudolikelihood = -99.748122                       Pseudo R2     = 0.1258

-------------------------------------------------------------------------------------
                    |               Robust
        tidak_layak | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
--------------------+----------------------------------------------------------------
         lnpov_near |  -.1728371   .1718208    -1.01   0.314    -.5095997    .1639254
                    |
             mdi_in |
                 2  |   2.567934   1.284826     2.00   0.046     .0497208    5.086146
                 3  |   2.729669   1.404557     1.94   0.052    -.0232128    5.482551
                    |
mdi_in#c.lnpov_near |
                 2  |  -.4667575    .286403    -1.63   0.103    -1.028097    .0945822
                 3  |   -.268338   .3196155    -0.84   0.401    -.8947729     .358097
                    |
              _cons |   .3674132    .781026     0.47   0.638     -1.16337    1.898196
-------------------------------------------------------------------------------------

. estimates store M1

. 
. * lock estimation sample
. gen byte sample_M1 = e(sample)

. label var sample_M1 "Estimation sample for M1"

. 
. * poverty points (within estimation sample)
. quietly summ lnpov_near if sample_M1, detail

. local p25 = r(p25)

. local p50 = r(p50)

. local p75 = r(p75)

. 
. * (A) Predicted probabilities by mdi at p25/p50/p75
. margins mdi_in if sample_M1, at(lnpov_near=(`p25' `p50' `p75')) post

Adjusted predictions                                       Number of obs = 168
Model VCE: Robust

Expression: Pr(tidak_layak), predict()
1._at: lnpov_near = 3.433987
2._at: lnpov_near = 4.158883
3._at: lnpov_near = 5.081404

------------------------------------------------------------------------------
             |            Delta-method
             |     Margin   std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
  _at#mdi_in |
        1 1  |   .4437128   .0762673     5.82   0.000     .2942315     .593194
        1 2  |   .6767743   .0761498     8.89   0.000     .5275234    .8260253
        1 3  |   .8295007   .0544482    15.23   0.000     .7227841    .9362173
        2 1  |   .4130439   .0667742     6.19   0.000     .2821688     .543919
        2 2  |   .5684053   .0716691     7.93   0.000     .4279363    .7088742
        2 3  |   .7794195    .057226    13.62   0.000     .6672585    .8915805
        3 1  |   .3749961   .0725309     5.17   0.000     .2328382    .5171541
        3 2  |   .4219699   .0843315     5.00   0.000     .2566833    .5872565
        3 3  |   .7016764   .0872049     8.05   0.000     .5307579    .8725949
------------------------------------------------------------------------------

. estimates store Marg_prob

. 
. * (B) Discrete change mdi at p25/p50/p75
. estimates restore M1
(results M1 are active now)

. margins if sample_M1, dydx(mdi_in) at(lnpov_near=(`p25' `p50' `p75')) post

Conditional marginal effects                               Number of obs = 168
Model VCE: Robust

Expression: Pr(tidak_layak), predict()
dy/dx wrt:  2.mdi_in 3.mdi_in
1._at: lnpov_near = 3.433987
2._at: lnpov_near = 4.158883
3._at: lnpov_near = 5.081404

------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
1.mdi_in     |  (base outcome)
-------------+----------------------------------------------------------------
2.mdi_in     |
         _at |
          1  |   .2330616   .1077752     2.16   0.031      .021826    .4442972
          2  |   .1553614   .0979554     1.59   0.113    -.0366277    .3473505
          3  |   .0469738   .1112319     0.42   0.673    -.1710366    .2649842
-------------+----------------------------------------------------------------
3.mdi_in     |
         _at |
          1  |   .3857879   .0937087     4.12   0.000     .2021223    .5694536
          2  |   .3663756    .087941     4.17   0.000     .1940145    .5387368
          3  |   .3266803   .1134259     2.88   0.004     .1043696    .5489909
------------------------------------------------------------------------------
Note: dy/dx for factor levels is the discrete change from the base level.

. estimates store Marg_dydx

. 
. * simple descriptive check
. bys mdi_in: summ tidak_layak if sample_M1

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> mdi_in = 1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 tidak_layak |         56    .4107143    .4964157          0          1

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> mdi_in = 2

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 tidak_layak |         56    .5535714    .5016207          0          1

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> mdi_in = 3

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 tidak_layak |         56    .7857143    .4140393          0          1


. 
. * predictions for export
. estimates restore M1
(results M1 are active now)

. predict double phat_M1 if sample_M1, pr

. label var phat_M1 "Predicted P(tidak layak) from logit"

. 
. * ----------------------------
. * Export RTF outputs (logit + margins tables)
. * ----------------------------
. cap which esttab

. if _rc {
.     cap ssc install estout, replace
. }

. 
. cap which esttab

. if !_rc {
.     esttab M1 using "$OUTDIR/logit_tidaklayak.rtf", replace ///
>         b(%9.4f) se(%9.4f) star(* 0.10 ** 0.05 *** 0.01) ///
>         stats(N ll, fmt(%9.0g %9.3f) labels("N" "LogLik")) ///
>         title("Logit: P(SPBUN tidak layak) ~ poverty (nearest) x High MDI")
(output written to /Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/Output/MDI-Check/logit_tidaklayak.rtf)
. 
.     esttab Marg_prob using "$OUTDIR/margins_pr_tidaklayak.rtf", replace ///
>         cells("b(fmt(4)) se(fmt(4))") ///
>         title("Margins: Pr(tidak_layak) by High MDI at p25/p50/p75 of lnpov_near")
(output written to /Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/Output/MDI-Check/margins_pr_tidaklayak.rtf)
. 
.     esttab Marg_dydx using "$OUTDIR/margins_dydx_highmdi.rtf", replace ///
>         cells("b(fmt(4)) se(fmt(4))") ///
>         title("Margins: dydx(mdi_in) at p25/p50/p75 of lnpov_near")
(output written to /Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/Output/MDI-Check/margins_dydx_highmdi.rtf)
. }

. else {
.     di as err "esttab not available; RTF tables not written. Try: ssc install estout"
. }

. 
end of do-file

. summ lnpov_near if sample_M1, detail

                         lnpov_near
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0              0
 5%            0              0
10%     2.302585              0       Obs                 168
25%     3.433987              0       Sum of wgt.         168

50%     4.158883                      Mean           4.095712
                        Largest       Std. dev.       1.45013
75%     5.081404       6.259581
90%     5.828946       6.378426       Variance       2.102877
95%     5.998937       6.467699       Skewness      -.9924908
99%     6.467699       7.226936       Kurtosis       4.294965

. * compare p25, p50, p75

. 
. * sanity check with a label/known-poverty proxy if you have one:

. corr lnpov_near povrate
variable povrate not found
r(111);

. 
. corr lnpov_near povrate
variable povrate not found
r(111);

. reg PP i.mdi_in##c.lnpov_near if sample_M1, vce(robust)

Linear regression                               Number of obs     =        168
                                                F(5, 162)         =       4.21
                                                Prob > F          =     0.0013
                                                R-squared         =     0.1114
                                                Root MSE          =     15.348

-------------------------------------------------------------------------------------
                    |               Robust
                 PP | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
--------------------+----------------------------------------------------------------
             mdi_in |
                 2  |   14.98799   8.719983     1.72   0.088      -2.2315    32.20748
                 3  |   14.34615   8.699069     1.65   0.101    -2.832042    31.52434
                    |
         lnpov_near |  -.6921045   .9382266    -0.74   0.462    -2.544835    1.160626
                    |
mdi_in#c.lnpov_near |
                 2  |  -2.673981   1.820319    -1.47   0.144    -6.268594    .9206318
                 3  |  -1.052346   2.044831    -0.51   0.608    -5.090306    2.985614
                    |
              _cons |   13.20389   4.774694     2.77   0.006      3.77523    22.63256
-------------------------------------------------------------------------------------

. margins mdi_in, at(lnpov_near=(`p25' `p50' `p75'))

Adjusted predictions                                       Number of obs = 168
Model VCE: Robust

Expression: Linear prediction, predict()
1._at: lnpov_near = 3.433987
2._at: lnpov_near = 4.158883
3._at: lnpov_near = 5.081404

------------------------------------------------------------------------------
             |            Delta-method
             |     Margin   std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
  _at#mdi_in |
        1 1  |   10.82722   2.052545     5.28   0.000     6.774022    14.88041
        1 2  |   16.63279   2.571406     6.47   0.000     11.55499    21.71058
        1 3  |   21.55962   2.451234     8.80   0.000     16.71913    26.40011
        2 1  |   10.32551   1.715692     6.02   0.000     6.937508    13.71352
        2 2  |   14.19273   2.026064     7.01   0.000     10.19182    18.19363
        2 3  |   20.29507   2.463123     8.24   0.000     15.43111    25.15904
        3 1  |    9.68703   1.632793     5.93   0.000     6.462728    12.91133
        3 2  |   11.08744   2.147623     5.16   0.000     6.846496    15.32839
        3 3  |   18.68578   3.340391     5.59   0.000     12.08946     25.2821
------------------------------------------------------------------------------

. margins, dydx(mdi_in) at(lnpov_near=(`p25' `p50' `p75'))

Conditional marginal effects                               Number of obs = 168
Model VCE: Robust

Expression: Linear prediction, predict()
dy/dx wrt:  2.mdi_in 3.mdi_in
1._at: lnpov_near = 3.433987
2._at: lnpov_near = 4.158883
3._at: lnpov_near = 5.081404

------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
1.mdi_in     |  (base outcome)
-------------+----------------------------------------------------------------
2.mdi_in     |
         _at |
          1  |   5.805572   3.290147     1.76   0.080    -.6915331    12.30268
          2  |   3.867215   2.654908     1.46   0.147    -1.375474    9.109903
          3  |   1.400411   2.697832     0.52   0.604    -3.927041    6.727862
-------------+----------------------------------------------------------------
3.mdi_in     |
         _at |
          1  |    10.7324   3.197107     3.36   0.001     4.419027    17.04578
          2  |   9.969562   3.001762     3.32   0.001     4.041936    15.89719
          3  |   8.998751   3.718094     2.42   0.017     1.656572    16.34093
------------------------------------------------------------------------------
Note: dy/dx for factor levels is the discrete change from the base level.

. use "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/Output/probabilistic/podes_vill.dta", clear

. use "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/Output/tsls/first_iv2sls_pesisir/podes_vill_spbun_pca_iv.dta"

