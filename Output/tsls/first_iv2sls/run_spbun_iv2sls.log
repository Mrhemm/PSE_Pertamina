---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/Output/iv2sls/run_spbun_iv2sls.log
  log type:  text
 opened on:   2 Feb 2026, 10:50:23

. 
. /****************************************************************************************
> B. PACKAGES
> ****************************************************************************************/
. cap which geodist

. if _rc ssc install geodist, replace

. 
. /****************************************************************************************
> C. HELPERS
> ****************************************************************************************/
. 
. capture program drop _std_iddesa10

. program define _std_iddesa10
  1.     syntax varname
  2.     capture confirm numeric variable `varlist'
  3.     if !_rc tostring `varlist', replace format("%010.0f")
  4.     replace `varlist' = trim(`varlist')
  5.     replace `varlist' = subinstr(`varlist'," ","",.)
  6.     replace `varlist' = subinstr(`varlist',".","",.)
  7.     replace `varlist' = subinstr(`varlist',",","",.)
  8.     replace `varlist' = substr("0000000000"+`varlist', strlen("0000000000"+`varlist')-9, 10)
  9.     assert strlen(`varlist')==10
 10. end

. 
. capture program drop _std_spbun_no

. program define _std_spbun_no
  1.     syntax varname
  2.     capture confirm numeric variable `varlist'
  3.     if !_rc tostring `varlist', replace format("%18.0f")
  4.     replace `varlist' = trim(`varlist')
  5.     replace `varlist' = subinstr(`varlist'," ","",.)
  6.     replace `varlist' = subinstr(`varlist',".","",.)
  7.     replace `varlist' = subinstr(`varlist',",","",.)
  8.     replace `varlist' = subinstr(`varlist',"#","",.)
  9.     replace `varlist' = ustrregexra(`varlist', "[^0-9A-Za-z]", "")
 10. end

. 
. * Convert 1/2 yes-no variables to 1/0
. capture program drop _yn12_to01

. program define _yn12_to01
  1.     syntax varlist
  2.     foreach v of varlist `varlist' {
  3.         cap confirm numeric variable `v'
  4.         if _rc continue
  5.         quietly summarize `v' if !missing(`v'), meanonly
  6.         if (r(min)>=1 & r(max)<=2) {
  7.             replace `v' = (`v'==1) if inlist(`v',1,2)
  8.         }
  9.     }
 10. end

. 
. * Fix lat/lon stored in scaled integers / sentinel values
. capture program drop _fix_latlon_scale

. program define _fix_latlon_scale
  1.     version 15
  2.     syntax varlist(min=2 max=2 numeric)
  3.     local lat : word 1 of `varlist'
  4.     local lon : word 2 of `varlist'
  5. 
.     * drop obvious sentinels / garbage
.     replace `lat' = . if !missing(`lat') & abs(`lat') > 1e12
  6.     replace `lon' = . if !missing(`lon') & abs(`lon') > 1e12
  7. 
.     * rescale microdegrees (degrees * 1e7)
.     replace `lat' = `lat'/1e7 if !missing(`lat') & abs(`lat') > 90  & abs(`lat') <= 9e8
  8.     replace `lon' = `lon'/1e7 if !missing(`lon') & abs(`lon') > 180 & abs(`lon') <= 18e8
  9. 
.     * swap if reversed
.     gen byte __swap = (abs(`lat')>90 & abs(`lon')<=90) if !missing(`lat') & !missing(`lon')
 10.     tempvar __tmp
 11.     gen double `__tmp' = `lat'
 12.     replace `lat' = `lon'   if __swap==1
 13.     replace `lon' = `__tmp' if __swap==1
 14.     drop __swap `__tmp'
 15. 
.     * drop invalid coords
.     drop if missing(`lat') | missing(`lon')
 16.     drop if abs(`lat')>90 | abs(`lon')>180
 17. end

. 
. * Bin a numeric variable into 0 + quantiles among non-zero (ordinal 0..4)
. capture program drop _bin0q4

. program define _bin0q4
  1.     syntax varname(numeric), gen(name)
  2.     tempvar q
  3.     cap drop `gen'
  4.     gen byte `gen' = .
  5.     replace `gen' = 0 if `varlist'==0 & !missing(`varlist')
  6. 
.     quietly count if `varlist'>0 & !missing(`varlist')
  7.     if (r(N)>=30) {
  8.         xtile `q' = `varlist' if `varlist'>0 & !missing(`varlist'), nq(4)
  9.         replace `gen' = `q' if `varlist'>0 & !missing(`varlist')
 10.         label define `gen'_lbl 0 "0" 1 "Q1" 2 "Q2" 3 "Q3" 4 "Q4", replace
 11.     }
 12.     else if (r(N)>0) {
 13.         xtile `q' = `varlist' if `varlist'>0 & !missing(`varlist'), nq(2)
 14.         replace `gen' = cond(`q'==1,1,4) if `varlist'>0 & !missing(`varlist')
 15.         label define `gen'_lbl 0 "0" 1 "Low" 4 "High", replace
 16.     }
 17.     else {
 18.         label define `gen'_lbl 0 "0", replace
 19.     }
 20. 
.     label values `gen' `gen'_lbl
 21. end

. 
. * Helper: 2-pass min-distance (bin-join) to avoid missingness (robust to empty joins)
. capture program drop _mindist_2pass

. program define _mindist_2pass
  1.     syntax, IDVAR(name) LATVAR(name) LONVAR(name) USING(string) ///
>         OUTVAR(name) [BINSZ1(real 1) RING1(integer 6) BINSZ2(real 2) RING2(integer 7)]
  2. 
.     tempfile V P1 P2 D1 D2 MISS
  3. 
.     * Village base (coords only)
.     preserve
  4.         keep `idvar' `latvar' `lonvar'
  5.         drop if missing(`latvar') | missing(`lonvar')
  6.         save `V', replace
  7.     restore
  8. 
.     * ---------------- PASS 1 ----------------
.     preserve
  9.         use "`using'", clear
 10.         keep pid lat_p lon_p
 11.         drop if missing(lat_p) | missing(lon_p)
 12.         gen int latbin = floor(lat_p/`binsz1')
 13.         gen int lonbin = floor(lon_p/`binsz1')
 14.         local K1 = (2*`ring1'+1)
 15.         local E1 = `K1'*`K1'
 16.         expand `E1'
 17.         bys pid: gen int __g = _n-1
 18.         gen int dlat = floor(__g/`K1') - `ring1'
 19.         gen int dlon = mod(__g,`K1') - `ring1'
 20.         gen int latbin2 = latbin + dlat
 21.         gen int lonbin2 = lonbin + dlon
 22.         drop __g dlat dlon latbin lonbin
 23.         rename latbin2 latbin
 24.         rename lonbin2 lonbin
 25.         save `P1', replace
 26.     restore
 27. 
.     preserve
 28.         use `V', clear
 29.         gen int latbin = floor(`latvar'/`binsz1')
 30.         gen int lonbin = floor(`lonvar'/`binsz1')
 31.         joinby latbin lonbin using `P1'
 32.         quietly count
 33.         if r(N)>0 {
 34.             geodist `latvar' `lonvar' lat_p lon_p, gen(__dkm)
 35.             bys `idvar': egen double `outvar' = min(__dkm)
 36.             keep `idvar' `outvar'
 37.             duplicates drop `idvar', force
 38.             save `D1', replace
 39.         }
 40.         else {
 41.             use `V', clear
 42.             keep `idvar'
 43.             gen double `outvar' = .
 44.             duplicates drop `idvar', force
 45.             save `D1', replace
 46.         }
 47.     restore
 48. 
.     merge 1:1 `idvar' using `D1', nogen
 49. 
.     * ---------------- PASS 2 ----------------
.     quietly count if missing(`outvar') & !missing(`latvar') & !missing(`lonvar')
 50.     if r(N) > 0 {
 51. 
.         preserve
 52.             keep if missing(`outvar') & !missing(`latvar') & !missing(`lonvar')
 53.             keep `idvar' `latvar' `lonvar'
 54.             save `MISS', replace
 55.         restore
 56. 
.         preserve
 57.             use "`using'", clear
 58.             keep pid lat_p lon_p
 59.             drop if missing(lat_p) | missing(lon_p)
 60.             gen int latbin = floor(lat_p/`binsz2')
 61.             gen int lonbin = floor(lon_p/`binsz2')
 62.             local K2 = (2*`ring2'+1)
 63.             local E2 = `K2'*`K2'
 64.             expand `E2'
 65.             bys pid: gen int __g = _n-1
 66.             gen int dlat = floor(__g/`K2') - `ring2'
 67.             gen int dlon = mod(__g,`K2') - `ring2'
 68.             gen int latbin2 = latbin + dlat
 69.             gen int lonbin2 = lonbin + dlon
 70.             drop __g dlat dlon latbin lonbin
 71.             rename latbin2 latbin
 72.             rename lonbin2 lonbin
 73.             save `P2', replace
 74.         restore
 75. 
.         preserve
 76.             use `MISS', clear
 77.             gen int latbin = floor(`latvar'/`binsz2')
 78.             gen int lonbin = floor(`lonvar'/`binsz2')
 79.             joinby latbin lonbin using `P2'
 80.             quietly count
 81.             if r(N)>0 {
 82.                 geodist `latvar' `lonvar' lat_p lon_p, gen(__dkm)
 83.                 bys `idvar': egen double __d2 = min(__dkm)
 84.                 keep `idvar' __d2
 85.                 duplicates drop `idvar', force
 86.                 save `D2', replace
 87.             }
 88.             else {
 89.                 use `MISS', clear
 90.                 keep `idvar'
 91.                 gen double __d2 = .
 92.                 duplicates drop `idvar', force
 93.                 save `D2', replace
 94.             }
 95.         restore
 96. 
.         merge 1:1 `idvar' using `D2', nogen
 97.         replace `outvar' = __d2 if missing(`outvar') & !missing(__d2)
 98.         drop __d2
 99.     }
100. end

. 
. 
. /****************************************************************************************
> D. BUILD "$outdir/podes_vill.dta"  (MAIN + PESISIR + coords fallback)
> ****************************************************************************************/
. tempfile MAIN PES kelcoords

. 
. * D1) MAIN
. use "$podes_main", clear

. 
. cap confirm variable IDDESA

. if _rc {
.     cap confirm variable iddesa
.     if !_rc rename iddesa IDDESA
.     cap confirm variable IdDesa
.     if !_rc rename IdDesa IDDESA
.     cap confirm variable Iddesa
.     if !_rc rename Iddesa IDDESA
. }

. cap confirm variable IDDESA

. if _rc {
.     di as err "MAIN: cannot find village id variable (IDDESA/iddesa)."
.     describe, short
.     exit 111
. }

. 
. cap confirm numeric variable IDDESA

. if !_rc tostring IDDESA, replace format("%010.0f")

. 
. replace IDDESA = trim(IDDESA)
(0 real changes made)

. replace IDDESA = subinstr(IDDESA," ","",.)
(0 real changes made)

. replace IDDESA = subinstr(IDDESA,".","",.)
(0 real changes made)

. replace IDDESA = subinstr(IDDESA,",","",.)
(0 real changes made)

. replace IDDESA = substr("0000000000"+IDDESA, strlen("0000000000"+IDDESA)-9, 10)
(0 real changes made)

. assert strlen(IDDESA)==10

. 
. rename *, lower

. rename iddesa iddesa
  (all newnames==oldnames)

. _std_iddesa10 iddesa
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. duplicates drop iddesa, force

Duplicates in terms of iddesa

(0 observations are duplicates)

. save `MAIN', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.000001 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.000001 saved as .dta format

. 
. * D2) PESISIR (prefix p_)
. use "$podes_pesisir", clear

. rename *, lower

. 
. cap confirm variable iddesa

. if _rc {
.     di as err "PESISIR: iddesa not found."
.     describe, short
.     exit 111
. }

. _std_iddesa10 iddesa
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. keep iddesa r307b_lat r307b_long ///
>      r308* r309* r310 ///
>      r402* r403* ///
>      r501* r502* r503* ///
>      r507* r508* r509* ///
>      r510* r511* r514* r515*

. 
. duplicates drop iddesa, force

Duplicates in terms of iddesa

(0 observations are duplicates)

. ds iddesa, not
r307b_lat   r308b1d     r309c       r402b2      r402e2a     r403c2      r502b       r503a5      r503a11     r509a       r510ak3     r510b1k5    r510b3k3    r510b4k5    r510b6k3    r510b8k2    r510b9k5    r511b2      r511c3      r514b_k4    r515c
r307b_long  r308b1e     r309d       r402c       r402e2b     r501a1      r502c       r503a6      r503b       r509b       r510ak4     r510b2k2    r510b3k4    r510b5k2    r510b6k4    r510b8k3    r510b10k2   r511b3      r514a_k2    r514c_k2
r308a       r308b2      r309e       r402d1      r403a       r501a2      r503a1      r503a7      r503c       r509c1      r510ak5     r510b2k3    r510b3k5    r510b5k3    r510b6k5    r510b8k4    r510b10k4   r511c1      r514a_k3    r514c_k3
r308b1a     r308b3      r310        r402d2a     r403b1      r501b       r503a2      r503a8      r507        r509c2      r510b1k2    r510b2k4    r510b4k2    r510b5k4    r510b7k2    r510b8k5    r510b10k5   r511c2a     r514a_k4    r514c_k4
r308b1b     r309a       r402a       r402d2b     r403b2      r501c       r503a3      r503a9      r508a       r509c3      r510b1k3    r510b2k5    r510b4k3    r510b5k5    r510b7k3    r510b9k2    r511a       r511c2b     r514b_k2    r515a
r308b1c     r309b       r402b1      r402e1      r403c1      r502a       r503a4      r503a10     r508b       r510ak2     r510b1k4    r510b3k2    r510b4k4    r510b6k2    r510b7k4    r510b9k4    r511b1      r511c2c     r514b_k3    r515b

. local pesvars `r(varlist)'

. foreach v of local pesvars {
  2.     rename `v' p_`v'
  3. }

. save `PES', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.000002 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.000002 saved as .dta format

. 
. * D3) MERGE MAIN + PESISIR; fill missing from p_*
. use `MAIN', clear

. merge 1:1 iddesa using `PES', nogen keep(master match)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            84,276  
    -----------------------------------------

. 
. capture ds p_*

. if !_rc {
.     local plist `r(varlist)'
.     foreach pv of local plist {
  2.         local tv = substr("`pv'",3,.)
  3.         capture confirm variable `tv'
  4.         if _rc {
  5.             rename `pv' `tv'
  6.         }
  7.         else {
  8.             capture confirm numeric variable `tv'
  9.             if !_rc {
 10.                 replace `tv' = `pv' if missing(`tv') & !missing(`pv')
 11.             }
 12.             else {
 13.                 capture confirm string variable `tv'
 14.                 if !_rc {
 15.                     replace `tv' = `pv' if (`tv'=="") & (`pv'!="")
 16.                 }
 17.             }
 18.             drop `pv'
 19.         }
 20.     }
. }

. 
. * admin codes from iddesa
. capture drop r101 r102 r103 r104

. gen int r101 = real(substr(iddesa,1,2))

. gen int r102 = real(substr(iddesa,3,2))

. gen int r103 = real(substr(iddesa,5,3))

. gen int r104 = real(substr(iddesa,8,3))

. 
. capture drop kab

. egen long kab = group(r101 r102), label

. 
. * coords prefer r307b_lat/long
. cap confirm variable lat_v

. if _rc gen double lat_v = .
(84,276 missing values generated)

. cap confirm variable lon_v

. if _rc gen double lon_v = .
(84,276 missing values generated)

. 
. cap confirm variable r307b_lat

. if !_rc {
.     cap confirm numeric variable r307b_lat
.     if _rc destring r307b_lat, replace ignore(",")
.     replace lat_v = r307b_lat if missing(lat_v) & !missing(r307b_lat)
(84,276 real changes made)
. }

. cap confirm variable r307b_long

. if !_rc {
.     cap confirm numeric variable r307b_long
.     if _rc destring r307b_long, replace ignore(",")
.     replace lon_v = r307b_long if missing(lon_v) & !missing(r307b_long)
(84,276 real changes made)
. }

. capture drop r307b_lat r307b_long

. 
. * fallback coords from kel_latlon if still missing
. count if missing(lat_v) | missing(lon_v)
  0

. if r(N) > 0 {
.     di as txt "Coords missing for " r(N) " villages -> fallback merge from kel_latlon..."
.     preserve
.         import delimited "$kel_latlon", clear varnames(1) case(preserve) stringcols(_all)
. 
.         local idv ""
.         local latc ""
.         local lonc ""
.         foreach v of varlist _all {
  2.             if "`idv'"==""  & strpos(lower("`v'"),"iddesa") local idv `v'
  3.             if "`latc'"=="" & strpos(lower("`v'"),"lat")    local latc `v'
  4.             if "`lonc'"=="" & (strpos(lower("`v'"),"lon") | strpos(lower("`v'"),"long")) local lonc `v'
  5.         }
. 
.         if "`idv'"!="" & "`latc'"!="" & "`lonc'"!="" {
.             rename `idv' iddesa
.             rename `latc' lat_v2
.             rename `lonc' lon_v2
.             _std_iddesa10 iddesa
.             destring lat_v2 lon_v2, replace ignore(",")
.             keep iddesa lat_v2 lon_v2
.             duplicates drop iddesa, force
.             save `kelcoords', replace
.         }
.     restore
. 
.     capture confirm file "`kelcoords'"
.     if !_rc {
.         merge 1:1 iddesa using `kelcoords', nogen keep(master match)
.         replace lat_v = lat_v2 if missing(lat_v) & !missing(lat_v2)
.         replace lon_v = lon_v2 if missing(lon_v) & !missing(lon_v2)
.         drop lat_v2 lon_v2
.     }
. }

. 
. save "$outdir/podes_vill.dta", replace
file /Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/Output/iv2sls/podes_vill.dta saved

. di as result "Saved: $outdir/podes_vill.dta"
Saved: /Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/Output/iv2sls/podes_vill.dta

. 
. /****************************************************************************************
> E. BUILD SPBUN SITE DATASET (coords + weights + stable SPBUN number if present)
> ****************************************************************************************/
. tempfile spbun_site

. import delimited "$spbun_csv", clear varnames(1) case(preserve) stringcols(_all)
(encoding automatically selected: UTF-8)
(113 vars, 377 obs)

. 
. * stable SPBUN identifier
. local spbunno ""

. foreach v of varlist _all {
  2.     if "`spbunno'"=="" & (strpos(lower("`v'"),"nomor") & strpos(lower("`v'"),"spbun")) local spbunno `v'
  3.     if "`spbunno'"=="" & (strpos(lower("`v'"),"no")    & strpos(lower("`v'"),"spbun")) local spbunno `v'
  4.     if "`spbunno'"=="" & (strpos(lower("`v'"),"kode")  & strpos(lower("`v'"),"spbun")) local spbunno `v'
  5. }

. if "`spbunno'"!="" {
.     rename `spbunno' spbun_no
.     _std_spbun_no spbun_no
. }

. else {
.     gen str20 spbun_no = ""
(377 missing values generated)
. }

. 
. * coordinates
. capture confirm variable TitikKoordinat

. if _rc {
.     di as err "Cannot find TitikKoordinat in SPBUN CSV."
.     describe
.     exit 198
. }

. rename TitikKoordinat titik_koordinat

. 
. replace titik_koordinat = subinstr(titik_koordinat, char(34), "", .)
(0 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, char(39), "", .)
(83 real changes made)

. replace titik_koordinat = subinstr(titik_koordinat, " ", "", .)
(1 real change made)

. replace titik_koordinat = "" if inlist(upper(trim(titik_koordinat)), "#N/A", "N/A", "NA", ".")
(8 real changes made)

. 
. gen strL coord = titik_koordinat
(8 missing values generated)

. split coord, parse(",") gen(_c)
variables created as string: 
_c1  _c2

. 
. foreach v of varlist _c* {
  2.     replace `v' = trim(`v')
  3.     replace `v' = subinstr(`v', char(160),"", .)
  4.     replace `v' = subinstr(`v', "–", "-", .)
  5.     replace `v' = subinstr(`v', "−", "-", .)
  6.     replace `v' = ustrregexra(`v', "[^0-9.-]", "")
  7. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. gen double lat_s = real(_c1)
(8 missing values generated)

. gen double lon_s = real(_c2)
(10 missing values generated)

. drop _c* coord

. 
. * swap if reversed
. gen byte _swap = (abs(lat_s)>90 & abs(lon_s)<=90)

. gen double _tmp = lat_s
(8 missing values generated)

. replace lat_s = lon_s if _swap
(0 real changes made)

. replace lon_s = _tmp  if _swap
(0 real changes made)

. drop _swap _tmp

. 
. drop if missing(lat_s) | missing(lon_s)
(10 observations deleted)

. 
. * quota vars (auto-detect)
. local qjbt ""

. local qjbkp ""

. foreach v of varlist _all {
  2.     if "`qjbt'"==""  & strpos(lower("`v'"),"kuota") & strpos(lower("`v'"),"jbt")  local qjbt  `v'
  3.     if "`qjbkp'"=="" & strpos(lower("`v'"),"kuota") & strpos(lower("`v'"),"jbkp") local qjbkp `v'
  4. }

. if "`qjbt'"!=""  rename `qjbt'  kuota_jbt

. if "`qjbkp'"!="" rename `qjbkp' kuota_jbkp

. capture destring kuota_jbt kuota_jbkp, replace ignore(",")

. 
. * volume proxy: destring likely volume cols, then rowtotal
. capture ds Total* *total* *realisasi* *volume*, has(type string)

. if !_rc {
.     foreach v of varlist `r(varlist)' {
  2.         capture destring `v', replace ignore(",")
  3.     }
. }

. local volvars ""

. capture ds Total* *total* *realisasi* *volume*, has(type numeric)

. if !_rc local volvars "`r(varlist)'"

. 
. capture drop vol_s

. if "`volvars'"!="" {
.     egen double vol_s = rowtotal(`volvars'), missing
. }

. else {
.     gen double vol_s = .
(367 missing values generated)
. }

. 
. gen double quota_s = .
(367 missing values generated)

. capture confirm variable kuota_jbt

. if !_rc replace quota_s = kuota_jbt

. capture confirm variable kuota_jbkp

. if !_rc replace quota_s = cond(missing(quota_s), kuota_jbkp, quota_s + kuota_jbkp)

. 
. gen double rr_s = .
(367 missing values generated)

. replace rr_s = vol_s / quota_s if quota_s>0 & !missing(vol_s)
(0 real changes made)

. 
. gen double w1   = 1

. gen double wvol = vol_s
(367 missing values generated)

. gen double wrr  = rr_s
(367 missing values generated)

. 
. gen long site_id = _n

. keep site_id spbun_no lat_s lon_s vol_s quota_s rr_s w1 wvol wrr

. save `spbun_site', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.000004 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.000004 saved as .dta format

. save "$outdir/spbun_site_raw.dta", replace
file /Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/Output/iv2sls/spbun_site_raw.dta saved

. 
. /****************************************************************************************
> F. ASSIGN EACH SPBUN SITE TO NEAREST VILLAGE (get r101/r102, kab)
> ****************************************************************************************/
. tempfile spbun_site_coded villcoords site_bins site2kab

. local binsz = 0.10

. 
. use `spbun_site', clear

. 
. preserve

.     use "$outdir/podes_vill.dta", clear

.     keep iddesa kab r101 r102 lat_v lon_v

.     drop if missing(lat_v) | missing(lon_v)
(0 observations deleted)

.     save `villcoords', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.000006 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.000006 saved as .dta format

. restore

. 
. drop if missing(lat_s) | missing(lon_s)
(0 observations deleted)

. 
. gen int latbin = floor(lat_s/`binsz')

. gen int lonbin = floor(lon_s/`binsz')

. 
. expand 9
(2,936 observations created)

. bys site_id: gen byte _g = _n - 1

. gen int dlat = floor(_g/3) - 1

. gen int dlon = mod(_g,3) - 1

. gen int latbin2 = latbin + dlat
(9 missing values generated)

. gen int lonbin2 = lonbin + dlon
(9 missing values generated)

. drop _g dlat dlon

. 
. save `site_bins', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.000007 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.000007 saved as .dta format

. 
. use `villcoords', clear

. gen int latbin2 = floor(lat_v/`binsz')

. gen int lonbin2 = floor(lon_v/`binsz')

. 
. joinby latbin2 lonbin2 using `site_bins'

. geodist lat_v lon_v lat_s lon_s, gen(dkm)

. bys site_id (dkm): keep if _n==1
(30,588 observations deleted)

. 
. keep site_id r101 r102 kab

. save `site2kab', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.000008 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.000008 saved as .dta format

. 
. use `spbun_site', clear

. merge 1:1 site_id using `site2kab', nogen keep(master match)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             2
        from master                         2  
        from using                          0  

    Matched                               365  
    -----------------------------------------

. save `spbun_site_coded', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.000005 not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.000005 saved as .dta format

. save "$outdir/spbun_site_coded.dta", replace
file /Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/Output/iv2sls/spbun_site_coded.dta saved

. 
. tempfile spbun_pts

. preserve

.     use "$outdir/spbun_site_coded.dta", clear

.     keep site_id lat_s lon_s

.     drop if missing(lat_s) | missing(lon_s)
(0 observations deleted)

.     rename site_id pid

.     rename lat_s lat_p

.     rename lon_s lon_p

.     save `spbun_pts', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000a not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000a saved as .dta format

. restore

. 
. 
. /****************************************************************************************
> G. VILLAGE-LEVEL EXPOSURE MEASURES (+ nearest SPBUN id)
> ****************************************************************************************/
. tempfile vill_bins site_bins2 vill_exposure vill_exposure_only

. 
. use "$outdir/podes_vill.dta", clear

. keep iddesa kab r101 r102 lat_v lon_v

. drop if missing(lat_v) | missing(lon_v)
(0 observations deleted)

. gen int latbin = floor(lat_v/`binsz')

. gen int lonbin = floor(lon_v/`binsz')

. save `vill_bins', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000c not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000c saved as .dta format

. 
. use `spbun_site_coded', clear

. keep site_id spbun_no lat_s lon_s w1 wvol wrr vol_s rr_s r101 r102 kab

. drop if missing(lat_s) | missing(lon_s)
(0 observations deleted)

. gen int latbin = floor(lat_s/`binsz')

. gen int lonbin = floor(lon_s/`binsz')

. 
. expand 9
(2,936 observations created)

. bys site_id: gen byte _g = _n - 1

. gen int dlat = floor(_g/3) - 1

. gen int dlon = mod(_g,3) - 1

. gen int latbin2 = latbin + dlat
(9 missing values generated)

. gen int lonbin2 = lonbin + dlon
(9 missing values generated)

. drop _g dlat dlon latbin lonbin

. rename latbin2 latbin

. rename lonbin2 lonbin

. save `site_bins2', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000d not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000d saved as .dta format

. 
. use `vill_bins', clear

. joinby latbin lonbin using `site_bins2'

. geodist lat_v lon_v lat_s lon_s, gen(dkm)

. 
. * nearest site metadata
. sort iddesa dkm

. by iddesa: gen double D_v = dkm[1]

. by iddesa: gen str30 _nearest_spbun_no_i = spbun_no[1]
(30,953 missing values generated)

. by iddesa: gen long  _nearest_site_id_i = site_id[1]

. 
. gen double A_v_log = -ln(1 + D_v)

. gen double A_v_inv = 1/(1 + D_v)

. 
. * counts within radius
. foreach R in 5 10 15 {
  2.     gen double C`R'_w1_i   = w1   * (dkm<=`R')
  3.     gen double C`R'_wvol_i = wvol * (dkm<=`R')
  4.     gen double C`R'_wrr_i  = wrr  * (dkm<=`R')
  5. }
(30,953 missing values generated)
(30,953 missing values generated)
(30,953 missing values generated)
(30,953 missing values generated)
(30,953 missing values generated)
(30,953 missing values generated)

. 
. * kernel sums
. foreach h in 5 10 20 {
  2.     gen double Ker`h'_w1_i   = w1   * exp(-dkm/`h') * (dkm <= 3*`h')
  3.     gen double Ker`h'_wvol_i = wvol * exp(-dkm/`h') * (dkm <= 3*`h')
  4.     gen double Ker`h'_wrr_i  = wrr  * exp(-dkm/`h') * (dkm <= 3*`h')
  5. }
(30,953 missing values generated)
(30,953 missing values generated)
(30,953 missing values generated)
(30,953 missing values generated)
(30,953 missing values generated)
(30,953 missing values generated)

. 
. collapse (min) D_v (firstnm) A_v_log A_v_inv ///
>     (firstnm) nearest_spbun_no=_nearest_spbun_no_i nearest_site_id=_nearest_site_id_i ///
>     (sum) ///
>     C5_w1=C5_w1_i     C5_wvol=C5_wvol_i     C5_wrr=C5_wrr_i ///
>     C10_w1=C10_w1_i   C10_wvol=C10_wvol_i   C10_wrr=C10_wrr_i ///
>     C15_w1=C15_w1_i   C15_wvol=C15_wvol_i   C15_wrr=C15_wrr_i ///
>     Ker5_w1=Ker5_w1_i   Ker5_wvol=Ker5_wvol_i   Ker5_wrr=Ker5_wrr_i ///
>     Ker10_w1=Ker10_w1_i Ker10_wvol=Ker10_wvol_i Ker10_wrr=Ker10_wrr_i ///
>     Ker20_w1=Ker20_w1_i Ker20_wvol=Ker20_wvol_i Ker20_wrr=Ker20_wrr_i ///
> , by(iddesa)

. 
. * cap count-style measures at 3 (0,1,2,3+)
. foreach R in 5 10 15 {
  2.     replace C`R'_w1   = 3 if C`R'_w1   > 3 & !missing(C`R'_w1)
  3.     replace C`R'_wvol = 3 if C`R'_wvol > 3 & !missing(C`R'_wvol)
  4.     replace C`R'_wrr  = 3 if C`R'_wrr  > 3 & !missing(C`R'_wrr)
  5. }
(46 real changes made)
(0 real changes made)
(0 real changes made)
(305 real changes made)
(0 real changes made)
(0 real changes made)
(806 real changes made)
(0 real changes made)
(0 real changes made)

. 
. foreach h in 5 10 20 {
  2.     cap drop Ker`h'_w1_pos lnKer`h'_w1
  3.     gen byte   Ker`h'_w1_pos = (Ker`h'_w1 > 0) if !missing(Ker`h'_w1)
  4.     gen double lnKer`h'_w1    = ln(1 + Ker`h'_w1)
  5. 
.     cap drop Ker`h'_wvol_pos lnKer`h'_wvol
  6.     gen byte   Ker`h'_wvol_pos = (Ker`h'_wvol > 0) if !missing(Ker`h'_wvol)
  7.     gen double lnKer`h'_wvol    = ln(1 + Ker`h'_wvol)
  8. 
.     cap drop Ker`h'_wrr_pos lnKer`h'_wrr
  9.     gen byte   Ker`h'_wrr_pos = (Ker`h'_wrr > 0) if !missing(Ker`h'_wrr)
 10.     gen double lnKer`h'_wrr    = ln(1 + Ker`h'_wrr)
 11. }

. 
. keep iddesa D_v A_v_log A_v_inv nearest_spbun_no nearest_site_id ///
>     C*_w1 C*_wvol C*_wrr ///
>     Ker*_w1 Ker*_wvol Ker*_wrr ///
>     Ker*_w1_pos Ker*_wvol_pos Ker*_wrr_pos ///
>     lnKer*_w1 lnKer*_wvol lnKer*_wrr

. save `vill_exposure_only', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000f not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000f saved as .dta format

. 
. use "$outdir/podes_vill.dta", clear

. merge 1:1 iddesa using `vill_exposure_only', nogen keep(master match)

    Result                      Number of obs
    -----------------------------------------
    Not matched                        67,153
        from master                    67,153  
        from using                          0  

    Matched                            17,123  
    -----------------------------------------

. 
. gen byte coord_ok  = !missing(lat_v) & !missing(lon_v)

. gen byte exp_match = !missing(D_v)

. 
. * zero-fill missing exposures for villages with valid coords but no matched sites
. foreach v of varlist C*_w1 C*_wvol C*_wrr Ker*_w1 Ker*_wvol Ker*_wrr ///
>                    Ker*_w1_pos Ker*_wvol_pos Ker*_wrr_pos ///
>                    lnKer*_w1 lnKer*_wvol lnKer*_wrr {
  2.     replace `v' = 0 if missing(`v') & coord_ok==1
  3. }
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)
(67,153 real changes made)

. 
. save `vill_exposure', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000e not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000e saved as .dta format

. save "$outdir/podes_vill_exposure.dta", replace
file /Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/Output/iv2sls/podes_vill_exposure.dta saved

. 
. /****************************************************************************************
> H. PCA welfare indices (Wbasic_z, Util_z, Edu_z, Hlth_z) + poverty proxy lnpov
> ****************************************************************************************/
. 
. * 0) SPBUN target label (full sample; no filtering)
. cap drop spbun_target

. gen byte spbun_target = 0

. foreach v in r308b1a r308b1b r308b1c {
  2.     cap confirm numeric variable `v'
  3.     if !_rc replace spbun_target = 1 if `v'==1
  4. }
(12,117 real changes made)
(112 real changes made)
(8 real changes made)

. label define spbun_target_lbl 0 "Non-target" 1 "Target (tangkap/budidaya/garam)", replace

. label values spbun_target spbun_target_lbl

. 
. * Coast / fish dummies (optional controls/heterogeneity)
. cap drop Coast Fish_strict Fish_loose

. cap confirm numeric variable r308a

. if !_rc gen byte Coast = (r308a==1) if !missing(r308a)

. cap confirm numeric variable r308b1a

. if !_rc cap confirm numeric variable r308b1b

. if !_rc gen byte Fish_strict = (Coast==1 & (r308b1a==1 | r308b1b==1)) if !missing(Coast)

. cap confirm numeric variable r308b1c

. if !_rc gen byte Fish_loose = (Coast==1 | r308b1a==1 | r308b1b==1 | r308b1c==1 | r308b1d==1 | r308b1e==1) if !missing(r308b1d) | !missing(r308b1e) | !missing(Coast)

. 
. * 1) Wbasic
. cap drop hh_light_total sh_elec elec_cat

. egen double hh_light_total = rowtotal(r501a1 r501a2 r501b r501c)

. replace hh_light_total = . if missing(r501a1) & missing(r501a2) & missing(r501b) & missing(r501c)
(0 real changes made)

. 
. gen double sh_elec = (r501a1 + r501a2) / hh_light_total if hh_light_total>0

. 
. gen byte elec_cat = .
(84,276 missing values generated)

. replace elec_cat = 3 if sh_elec>=0.90 & sh_elec<=1
(77,807 real changes made)

. replace elec_cat = 2 if sh_elec>=0.50 & sh_elec<0.90
(3,285 real changes made)

. replace elec_cat = 1 if sh_elec>0    & sh_elec<0.50
(2,043 real changes made)

. replace elec_cat = 0 if sh_elec==0
(1,141 real changes made)

. 
. label define elec_cat_lbl 0 "0%" 1 "1-49%" 2 "50-89%" 3 ">=90%", replace

. label values elec_cat elec_cat_lbl

. 
. cap drop cook_market

. cap confirm numeric variable r503b

. if !_rc gen byte cook_market = inlist(r503b,1,2,3,4,5,7) if !missing(r503b)

. 
. _yn12_to01 r503a1-r503a11
(56,966 real changes made)
(51,607 real changes made)
(44,293 real changes made)
(14,972 real changes made)
(83,062 real changes made)
(83,675 real changes made)
(65,213 real changes made)
(84,206 real changes made)
(81,669 real changes made)
(12,390 real changes made)
(84,182 real changes made)

. _yn12_to01 r502a r502b r502c
(53,800 real changes made)

. 
. local Wbasic_in "elec_cat r502a r502b r502c cook_market r503a1-r503a11"

. 
. * 2) Util
. _yn12_to01 r507* r508a r508b r509a r509b r510*
(73,118 real changes made)
(17,226 real changes made)
(47,591 real changes made)
(78,322 real changes made)
(73,419 real changes made)

. 
. foreach v in r509c1 r509c2 r509c3 {
  2.     cap confirm numeric variable `v'
  3.     if !_rc _bin0q4 `v', gen(`v'_b)
  4. }
(84,276 missing values generated)
(79,006 real changes made)
(5,270 real changes made)
(84,276 missing values generated)
(79,006 real changes made)
(5,270 real changes made)
(84,276 missing values generated)
(79,006 real changes made)
(5,270 real changes made)

. 
. ds r511c* r514* r515*, has(type numeric)
r511c1    r511c2a   r511c2b   r511c2c   r511c3    r514a_k2  r514a_k3  r514a_k4  r514b_k2  r514b_k3  r514b_k4  r514c_k2  r514c_k3  r514c_k4  r515a     r515b     r515c

. local util_extra "`r(varlist)'"

. 
. foreach v of local util_extra {
  2.     quietly summarize `v' if !missing(`v'), meanonly
  3.     if (r(min)>=1 & r(max)<=2) {
  4.         replace `v' = (`v'==1) if inlist(`v',1,2)
  5.     }
  6.     else if (r(max)>20) {
  7.         _bin0q4 `v', gen(`v'_b)
  8.     }
  9. }
(73,257 real changes made)
(83,329 real changes made)
(79,522 real changes made)

. 
. local Wutil_in "r507* r508a r508b r509a r509b"

. foreach v in r509c1 r509c2 r509c3 {
  2.     cap confirm variable `v'_b
  3.     if !_rc local Wutil_in "`Wutil_in' `v'_b"
  4. }

. foreach v of local util_extra {
  2.     cap confirm variable `v'_b
  3.     if !_rc local Wutil_in "`Wutil_in' `v'_b"
  4.     else local Wutil_in "`Wutil_in' `v'"
  5. }

. 
. * 3) Edu
. ds r701*, has(type numeric)
r701ak2  r701ak4  r701bk2  r701bk4  r701ck2  r701ck4  r701dk2  r701dk4  r701ek2  r701ek4  r701fk2  r701fk4  r701gk2  r701gk4  r701hk2  r701hk4  r701ik2  r701ik4  r701jk2  r701jk4  r701kk2  r701kk4  r701lk2  r701mk2  r701nk2  r701ok2  r701pk3
r701ak3  r701ak5  r701bk3  r701bk5  r701ck3  r701ck5  r701dk3  r701dk5  r701ek3  r701ek5  r701fk3  r701fk5  r701gk3  r701gk5  r701hk3  r701hk5  r701ik3  r701ik5  r701jk3  r701jk5  r701kk3  r701kk5  r701lk3  r701mk3  r701nk3  r701ok3  r701qk3

. local edu_raw "`r(varlist)'"

. local Edu_in ""

. 
. foreach v of local edu_raw {
  2.     quietly summarize `v' if !missing(`v'), meanonly
  3.     if (r(min)>=1 & r(max)<=2) {
  4.         replace `v' = (`v'==1) if inlist(`v',1,2)
  5.         local Edu_in "`Edu_in' `v'"
  6.     }
  7.     else if (r(max)>20) {
  8.         _bin0q4 `v', gen(`v'_b)
  9.         local Edu_in "`Edu_in' `v'_b"
 10.     }
 11.     else {
 12.         local Edu_in "`Edu_in' `v'"
 13.     }
 14. }
(84,276 missing values generated)
(23,605 real changes made)
(60,671 real changes made)
(84,276 missing values generated)
(63,261 real changes made)
(21,015 real changes made)
(84,276 missing values generated)
(36,033 real changes made)
(48,243 real changes made)
(84,276 missing values generated)
(52,132 real changes made)
(32,144 real changes made)
(84,276 missing values generated)
(19,473 real changes made)
(64,803 real changes made)
(84,276 missing values generated)
(16,415 real changes made)
(67,861 real changes made)
(84,276 missing values generated)
(71,672 real changes made)
(12,604 real changes made)
(84,276 missing values generated)
(71,133 real changes made)
(13,143 real changes made)
(84,276 missing values generated)
(20,108 real changes made)
(64,168 real changes made)
(84,276 missing values generated)
(31,343 real changes made)
(52,933 real changes made)
(84,276 missing values generated)
(15,868 real changes made)
(68,408 real changes made)
(84,276 missing values generated)
(12,016 real changes made)
(72,260 real changes made)
(84,276 missing values generated)
(8,668 real changes made)
(75,608 real changes made)
(84,276 missing values generated)
(11,010 real changes made)
(73,266 real changes made)
(84,276 missing values generated)
(3,289 real changes made)
(80,987 real changes made)
(84,276 missing values generated)
(66,943 real changes made)
(17,333 real changes made)
(84,276 missing values generated)
(61,940 real changes made)
(22,336 real changes made)
(84,276 missing values generated)
(83,912 real changes made)
(364 real changes made)

. 
. * 4) Hlth
. ds r711*, has(type numeric)
r711ak2  r711ak4  r711bk3  r711ck2  r711ck4  r711dk3  r711ek2  r711ek4  r711fk3  r711gk2  r711gk4  r711hk3  r711ik2  r711ik4  r711jk3
r711ak3  r711bk2  r711bk4  r711ck3  r711dk2  r711dk4  r711ek3  r711fk2  r711fk4  r711gk3  r711hk2  r711hk4  r711ik3  r711jk2  r711jk4

. local hlth_raw "`r(varlist)'"

. local Hlth_in ""

. 
. foreach v of local hlth_raw {
  2.     quietly summarize `v' if !missing(`v'), meanonly
  3.     if (r(min)>=1 & r(max)<=2) {
  4.         replace `v' = (`v'==1) if inlist(`v',1,2)
  5.         local Hlth_in "`Hlth_in' `v'"
  6.     }
  7.     else if (r(max)>20) {
  8.         _bin0q4 `v', gen(`v'_b)
  9.         local Hlth_in "`Hlth_in' `v'_b"
 10.     }
 11.     else {
 12.         cap drop ln1p_`v'
 13.         gen double ln1p_`v' = ln(1+`v') if !missing(`v')
 14.         _bin0q4 ln1p_`v', gen(`v'_b)
 15.         local Hlth_in "`Hlth_in' `v'_b"
 16.     }
 17. }
(82,966 real changes made)
(84,276 missing values generated)
(82,966 real changes made)
(1,310 real changes made)
(84,276 missing values generated)
(84,165 real changes made)
(111 real changes made)
(80,276 real changes made)
(84,276 missing values generated)
(80,276 real changes made)
(4,000 real changes made)
(84,276 missing values generated)
(83,778 real changes made)
(498 real changes made)
(83,955 real changes made)
(84,276 missing values generated)
(83,955 real changes made)
(321 real changes made)
(84,276 missing values generated)
(84,267 real changes made)
(9 real changes made)
(83,530 real changes made)
(84,276 missing values generated)
(83,530 real changes made)
(746 real changes made)
(84,276 missing values generated)
(84,208 real changes made)
(68 real changes made)
(84,275 real changes made)
(84,276 missing values generated)
(84,275 real changes made)
(1 real change made)
(84,276 missing values generated)
(84,276 real changes made)
(84,216 real changes made)
(84,276 missing values generated)
(84,216 real changes made)
(60 real changes made)
(84,276 missing values generated)
(84,268 real changes made)
(8 real changes made)
(84,238 real changes made)
(84,276 missing values generated)
(84,238 real changes made)
(38 real changes made)
(84,276 missing values generated)
(84,265 real changes made)
(11 real changes made)
(84,051 real changes made)
(84,276 missing values generated)
(84,051 real changes made)
(225 real changes made)
(84,276 missing values generated)
(84,185 real changes made)
(91 real changes made)
(83,863 real changes made)
(84,276 missing values generated)
(83,863 real changes made)
(413 real changes made)
(84,276 missing values generated)
(84,218 real changes made)
(58 real changes made)
(84,220 real changes made)
(84,276 missing values generated)
(84,220 real changes made)
(56 real changes made)
(84,276 missing values generated)
(84,262 real changes made)
(14 real changes made)

. 
. * 5) Poverty proxy
. cap drop lnpov

. cap confirm numeric variable r710

. if !_rc {
.     gen double lnpov = ln(1+r710) if !missing(r710)
.     cap drop lnpov_b
.     _bin0q4 lnpov, gen(lnpov_b)
(84,276 missing values generated)
(9,456 real changes made)
(74,820 real changes made)
. }

. 
. * 6) environment index (Env_z)
. cap drop Env_pca1 Env_z

. cap noisily pca r309a r309b r309d r309e r310, components(1) correlation

Principal components/correlation                 Number of obs    =     84,276
                                                 Number of comp.  =          1
                                                 Trace            =          5
    Rotation: (unrotated = principal)            Rho              =     0.7183

    --------------------------------------------------------------------------
       Component |   Eigenvalue   Difference         Proportion   Cumulative
    -------------+------------------------------------------------------------
           Comp1 |      3.59134      2.69061             0.7183       0.7183
           Comp2 |      .900723      .595306             0.1801       0.8984
           Comp3 |      .305416      .164584             0.0611       0.9595
           Comp4 |      .140832     .0791391             0.0282       0.9877
           Comp5 |     .0616929            .             0.0123       1.0000
    --------------------------------------------------------------------------

Principal components (eigenvectors) 

    --------------------------------------
        Variable |    Comp1 | Unexplained 
    -------------+----------+-------------
           r309a |  -0.5019 |       .0952 
           r309b |   0.4758 |       .1868 
           r309d |   0.4711 |       .2031 
           r309e |   0.5122 |       .0578 
            r310 |  -0.1934 |       .8657 
    --------------------------------------

. if !_rc {
.     predict double Env_pca1 if e(sample), score

Scoring coefficients 
    sum of squares(column-loading) = 1

    ------------------------
        Variable |    Comp1 
    -------------+----------
           r309a |  -0.5019 
           r309b |   0.4758 
           r309d |   0.4711 
           r309e |   0.5122 
            r310 |  -0.1934 
    ------------------------
.     egen double Env_z = std(Env_pca1)
. }

. 
. * 7) PCA (1 component each) + z-score
. cap noisily pca `Wbasic_in', components(1) correlation

Principal components/correlation                 Number of obs    =     84,276
                                                 Number of comp.  =          1
                                                 Trace            =         16
    Rotation: (unrotated = principal)            Rho              =     0.2256

    --------------------------------------------------------------------------
       Component |   Eigenvalue   Difference         Proportion   Cumulative
    -------------+------------------------------------------------------------
           Comp1 |       3.6095      2.29212             0.2256       0.2256
           Comp2 |      1.31739     .0331452             0.0823       0.3079
           Comp3 |      1.28424      .186716             0.0803       0.3882
           Comp4 |      1.09752     .0523554             0.0686       0.4568
           Comp5 |      1.04517     .0484995             0.0653       0.5221
           Comp6 |       .99667    .00469408             0.0623       0.5844
           Comp7 |      .991976     .0508646             0.0620       0.6464
           Comp8 |      .941111     .0767107             0.0588       0.7052
           Comp9 |        .8644    .00611774             0.0540       0.7592
          Comp10 |      .858283     .0667967             0.0536       0.8129
          Comp11 |      .791486     .0434687             0.0495       0.8624
          Comp12 |      .748017      .302701             0.0468       0.9091
          Comp13 |      .445316     .0158871             0.0278       0.9369
          Comp14 |      .429429     .0592909             0.0268       0.9638
          Comp15 |      .370138      .160785             0.0231       0.9869
          Comp16 |      .209353            .             0.0131       1.0000
    --------------------------------------------------------------------------

Principal components (eigenvectors) 

    --------------------------------------
        Variable |    Comp1 | Unexplained 
    -------------+----------+-------------
        elec_cat |   0.3245 |         .62 
           r502a |   0.1327 |       .9365 
           r502b |  -0.3930 |       .4427 
           r502c |   0.2946 |       .6867 
     cook_market |   0.4328 |       .3239 
          r503a1 |   0.1869 |       .8739 
          r503a2 |   0.2894 |       .6977 
          r503a3 |   0.3109 |       .6512 
          r503a4 |   0.4229 |       .3544 
          r503a5 |   0.0671 |       .9838 
          r503a6 |   0.0418 |       .9937 
          r503a7 |  -0.1578 |       .9101 
          r503a8 |   0.0056 |       .9999 
          r503a9 |   0.0520 |       .9902 
         r503a10 |  -0.1431 |       .9261 
         r503a11 |   0.0087 |       .9997 
    --------------------------------------

. if !_rc {
.     cap drop Wbasic_pca1 Wbasic_z
.     predict double Wbasic_pca1 if e(sample), score

Scoring coefficients 
    sum of squares(column-loading) = 1

    ------------------------
        Variable |    Comp1 
    -------------+----------
        elec_cat |   0.3245 
           r502a |   0.1327 
           r502b |  -0.3930 
           r502c |   0.2946 
     cook_market |   0.4328 
          r503a1 |   0.1869 
          r503a2 |   0.2894 
          r503a3 |   0.3109 
          r503a4 |   0.4229 
          r503a5 |   0.0671 
          r503a6 |   0.0418 
          r503a7 |  -0.1578 
          r503a8 |   0.0056 
          r503a9 |   0.0520 
         r503a10 |  -0.1431 
         r503a11 |   0.0087 
    ------------------------
.     egen double Wbasic_z = std(Wbasic_pca1)
. }

. 
. cap noisily pca `Wutil_in', components(1) correlation

Principal components/correlation                 Number of obs    =     84,276
                                                 Number of comp.  =          1
                                                 Trace            =         25
    Rotation: (unrotated = principal)            Rho              =     0.2651

    --------------------------------------------------------------------------
       Component |   Eigenvalue   Difference         Proportion   Cumulative
    -------------+------------------------------------------------------------
           Comp1 |      6.62757      2.94737             0.2651       0.2651
           Comp2 |       3.6802      .768968             0.1472       0.4123
           Comp3 |      2.91123      .532086             0.1164       0.5288
           Comp4 |      2.37915       .56627             0.0952       0.6239
           Comp5 |      1.81288      .444687             0.0725       0.6964
           Comp6 |      1.36819      .172854             0.0547       0.7512
           Comp7 |      1.19534      .288798             0.0478       0.7990
           Comp8 |       .90654      .077622             0.0363       0.8352
           Comp9 |      .828918     .0796234             0.0332       0.8684
          Comp10 |      .749294    .00413874             0.0300       0.8984
          Comp11 |      .745156      .295062             0.0298       0.9282
          Comp12 |      .450093     .0920655             0.0180       0.9462
          Comp13 |      .358028      .114739             0.0143       0.9605
          Comp14 |      .243289     .0774368             0.0097       0.9702
          Comp15 |      .165852     .0133955             0.0066       0.9769
          Comp16 |      .152457     .0207891             0.0061       0.9830
          Comp17 |      .131668     .0506763             0.0053       0.9882
          Comp18 |     .0809914     .0145383             0.0032       0.9915
          Comp19 |     .0664531     .0222073             0.0027       0.9941
          Comp20 |     .0442457     .0102984             0.0018       0.9959
          Comp21 |     .0339474    .00873783             0.0014       0.9973
          Comp22 |     .0252095    .00495924             0.0010       0.9983
          Comp23 |     .0202503    .00750613             0.0008       0.9991
          Comp24 |     .0127442    .00244783             0.0005       0.9996
          Comp25 |     .0102963            .             0.0004       1.0000
    --------------------------------------------------------------------------

Principal components (eigenvectors) 

    --------------------------------------
        Variable |    Comp1 | Unexplained 
    -------------+----------+-------------
            r507 |  -0.0410 |       .9888 
           r508a |  -0.0607 |       .9755 
           r508b |  -0.0525 |       .9818 
           r509a |   0.0784 |       .9593 
           r509b |   0.0634 |       .9733 
        r509c1_b |   0.0738 |       .9639 
        r509c2_b |   0.0779 |       .9598 
        r509c3_b |   0.0781 |       .9595 
          r511c1 |  -0.0899 |       .9464 
         r511c2a |   0.3334 |       .2632 
         r511c2b |   0.3423 |       .2234 
         r511c2c |   0.3548 |       .1655 
          r511c3 |   0.3340 |       .2605 
        r514a_k2 |   0.3591 |       .1453 
        r514a_k3 |   0.3387 |       .2396 
        r514a_k4 |   0.3474 |       .1999 
        r514b_k2 |   0.1362 |       .8771 
        r514b_k3 |   0.1321 |       .8843 
        r514b_k4 |   0.1319 |       .8847 
        r514c_k2 |   0.1555 |       .8397 
        r514c_k3 |   0.1455 |       .8598 
        r514c_k4 |   0.1488 |       .8533 
           r515a |  -0.0337 |       .9925 
           r515b |  -0.0553 |       .9798 
           r515c |  -0.0258 |       .9956 
    --------------------------------------

. if !_rc {
.     cap drop Util_pca1 Util_z
.     predict double Util_pca1 if e(sample), score

Scoring coefficients 
    sum of squares(column-loading) = 1

    ------------------------
        Variable |    Comp1 
    -------------+----------
            r507 |  -0.0410 
           r508a |  -0.0607 
           r508b |  -0.0525 
           r509a |   0.0784 
           r509b |   0.0634 
        r509c1_b |   0.0738 
        r509c2_b |   0.0779 
        r509c3_b |   0.0781 
          r511c1 |  -0.0899 
         r511c2a |   0.3334 
         r511c2b |   0.3423 
         r511c2c |   0.3548 
          r511c3 |   0.3340 
        r514a_k2 |   0.3591 
        r514a_k3 |   0.3387 
        r514a_k4 |   0.3474 
        r514b_k2 |   0.1362 
        r514b_k3 |   0.1321 
        r514b_k4 |   0.1319 
        r514c_k2 |   0.1555 
        r514c_k3 |   0.1455 
        r514c_k4 |   0.1488 
           r515a |  -0.0337 
           r515b |  -0.0553 
           r515c |  -0.0258 
    ------------------------
.     egen double Util_z = std(Util_pca1)
. }

. 
. cap noisily pca `Edu_in', components(1) correlation

Principal components/correlation                 Number of obs    =     84,276
                                                 Number of comp.  =          1
                                                 Trace            =         54
    Rotation: (unrotated = principal)            Rho              =     0.2487

    --------------------------------------------------------------------------
       Component |   Eigenvalue   Difference         Proportion   Cumulative
    -------------+------------------------------------------------------------
           Comp1 |      13.4308      10.3391             0.2487       0.2487
           Comp2 |      3.09174      .218213             0.0573       0.3060
           Comp3 |      2.87353      .712432             0.0532       0.3592
           Comp4 |       2.1611      .415294             0.0400       0.3992
           Comp5 |       1.7458      .177258             0.0323       0.4315
           Comp6 |      1.56855      .159164             0.0290       0.4606
           Comp7 |      1.40938     .0234264             0.0261       0.4867
           Comp8 |      1.38595     .0397181             0.0257       0.5123
           Comp9 |      1.34624     .0182919             0.0249       0.5373
          Comp10 |      1.32794     .0812074             0.0246       0.5619
          Comp11 |      1.24674      .113918             0.0231       0.5850
          Comp12 |      1.13282     .0547112             0.0210       0.6059
          Comp13 |      1.07811     .0106292             0.0200       0.6259
          Comp14 |      1.06748     .0207003             0.0198       0.6457
          Comp15 |      1.04678     .0548023             0.0194       0.6651
          Comp16 |      .991977     .0191489             0.0184       0.6834
          Comp17 |      .972828       .02842             0.0180       0.7014
          Comp18 |      .944408     .0282222             0.0175       0.7189
          Comp19 |      .916186     .0655754             0.0170       0.7359
          Comp20 |       .85061     .0268221             0.0158       0.7516
          Comp21 |      .823788     .0201464             0.0153       0.7669
          Comp22 |      .803642     .0241459             0.0149       0.7818
          Comp23 |      .779496     .0132046             0.0144       0.7962
          Comp24 |      .766291     .0350775             0.0142       0.8104
          Comp25 |      .731214    .00395766             0.0135       0.8240
          Comp26 |      .727256     .0195267             0.0135       0.8374
          Comp27 |       .70773    .00275412             0.0131       0.8505
          Comp28 |      .704975     .0287683             0.0131       0.8636
          Comp29 |      .676207    .00642292             0.0125       0.8761
          Comp30 |      .669784     .0381242             0.0124       0.8885
          Comp31 |       .63166     .0414764             0.0117       0.9002
          Comp32 |      .590184     .0543696             0.0109       0.9111
          Comp33 |      .535814     .0285032             0.0099       0.9211
          Comp34 |      .507311     .0359587             0.0094       0.9305
          Comp35 |      .471352     .0631838             0.0087       0.9392
          Comp36 |      .408168     .0333169             0.0076       0.9467
          Comp37 |      .374851     .0639956             0.0069       0.9537
          Comp38 |      .310856     .0265997             0.0058       0.9594
          Comp39 |      .284256    .00702468             0.0053       0.9647
          Comp40 |      .277231     .0120984             0.0051       0.9698
          Comp41 |      .265133     .0722888             0.0049       0.9747
          Comp42 |      .192844     .0117689             0.0036       0.9783
          Comp43 |      .181075     .0119801             0.0034       0.9817
          Comp44 |      .169095     .0362796             0.0031       0.9848
          Comp45 |      .132816     .0153317             0.0025       0.9873
          Comp46 |      .117484      .015017             0.0022       0.9894
          Comp47 |      .102467    .00404476             0.0019       0.9913
          Comp48 |     .0984222     .0173722             0.0018       0.9932
          Comp49 |       .08105    .00441857             0.0015       0.9947
          Comp50 |     .0766315     .0175766             0.0014       0.9961
          Comp51 |     .0590549    .00258516             0.0011       0.9972
          Comp52 |     .0564697    .00758884             0.0010       0.9982
          Comp53 |     .0488809    .00135608             0.0009       0.9991
          Comp54 |     .0475248            .             0.0009       1.0000
    --------------------------------------------------------------------------

Principal components (eigenvectors) 

    --------------------------------------
        Variable |    Comp1 | Unexplained 
    -------------+----------+-------------
         r701ak2 |  -0.0026 |       .9999 
       r701ak3_b |  -0.1687 |        .618 
       r701ak4_b |   0.1493 |       .7004 
         r701ak5 |   0.1579 |       .6652 
         r701bk2 |  -0.0305 |       .9875 
       r701bk3_b |  -0.1664 |       .6282 
       r701bk4_b |   0.1718 |       .6035 
         r701bk5 |   0.1796 |       .5668 
         r701ck2 |  -0.0086 |        .999 
         r701ck3 |  -0.1429 |       .7258 
       r701ck4_b |   0.2090 |       .4132 
         r701ck5 |   0.2173 |       .3657 
       r701dk2_b |  -0.1549 |       .6777 
       r701dk3_b |  -0.0909 |       .8889 
       r701dk4_b |   0.1223 |       .7991 
         r701dk5 |   0.1274 |       .7819 
         r701ek2 |  -0.0327 |       .9857 
         r701ek3 |  -0.1407 |        .734 
       r701ek4_b |   0.2080 |       .4187 
         r701ek5 |   0.2181 |       .3612 
         r701fk2 |  -0.0565 |       .9572 
         r701fk3 |  -0.1288 |       .7772 
       r701fk4_b |   0.1342 |       .7579 
         r701fk5 |   0.1527 |       .6869 
         r701gk2 |  -0.0447 |       .9731 
         r701gk3 |  -0.1385 |       .7422 
       r701gk4_b |   0.2103 |       .4059 
         r701gk5 |   0.2206 |       .3466 
         r701hk2 |  -0.0548 |       .9596 
         r701hk3 |  -0.1020 |       .8602 
       r701hk4_b |   0.1529 |       .6862 
         r701hk5 |   0.1784 |       .5724 
         r701ik2 |  -0.0398 |       .9787 
         r701ik3 |  -0.1139 |       .8259 
       r701ik4_b |   0.2026 |       .4485 
         r701ik5 |   0.2149 |       .3797 
         r701jk2 |  -0.0457 |        .972 
         r701jk3 |  -0.1197 |       .8076 
       r701jk4_b |   0.1861 |        .535 
         r701jk5 |   0.2030 |       .4463 
         r701kk2 |  -0.0335 |        .985 
         r701kk3 |  -0.0749 |       .9247 
       r701kk4_b |   0.1777 |        .576 
         r701kk5 |   0.1975 |       .4761 
         r701lk2 |  -0.0142 |       .9973 
         r701lk3 |  -0.0286 |        .989 
         r701mk2 |  -0.0120 |       .9981 
         r701mk3 |  -0.0179 |       .9957 
         r701nk2 |  -0.0101 |       .9986 
         r701nk3 |  -0.0154 |       .9968 
         r701ok2 |  -0.0100 |       .9987 
       r701ok3_b |  -0.1297 |       .7742 
       r701pk3_b |  -0.1157 |       .8202 
       r701qk3_b |  -0.0091 |       .9989 
    --------------------------------------

. if !_rc {
.     cap drop Edu_pca1 Edu_z
.     predict double Edu_pca1 if e(sample), score

Scoring coefficients 
    sum of squares(column-loading) = 1

    ------------------------
        Variable |    Comp1 
    -------------+----------
         r701ak2 |  -0.0026 
       r701ak3_b |  -0.1687 
       r701ak4_b |   0.1493 
         r701ak5 |   0.1579 
         r701bk2 |  -0.0305 
       r701bk3_b |  -0.1664 
       r701bk4_b |   0.1718 
         r701bk5 |   0.1796 
         r701ck2 |  -0.0086 
         r701ck3 |  -0.1429 
       r701ck4_b |   0.2090 
         r701ck5 |   0.2173 
       r701dk2_b |  -0.1549 
       r701dk3_b |  -0.0909 
       r701dk4_b |   0.1223 
         r701dk5 |   0.1274 
         r701ek2 |  -0.0327 
         r701ek3 |  -0.1407 
       r701ek4_b |   0.2080 
         r701ek5 |   0.2181 
         r701fk2 |  -0.0565 
         r701fk3 |  -0.1288 
       r701fk4_b |   0.1342 
         r701fk5 |   0.1527 
         r701gk2 |  -0.0447 
         r701gk3 |  -0.1385 
       r701gk4_b |   0.2103 
         r701gk5 |   0.2206 
         r701hk2 |  -0.0548 
         r701hk3 |  -0.1020 
       r701hk4_b |   0.1529 
         r701hk5 |   0.1784 
         r701ik2 |  -0.0398 
         r701ik3 |  -0.1139 
       r701ik4_b |   0.2026 
         r701ik5 |   0.2149 
         r701jk2 |  -0.0457 
         r701jk3 |  -0.1197 
       r701jk4_b |   0.1861 
         r701jk5 |   0.2030 
         r701kk2 |  -0.0335 
         r701kk3 |  -0.0749 
       r701kk4_b |   0.1777 
         r701kk5 |   0.1975 
         r701lk2 |  -0.0142 
         r701lk3 |  -0.0286 
         r701mk2 |  -0.0120 
         r701mk3 |  -0.0179 
         r701nk2 |  -0.0101 
         r701nk3 |  -0.0154 
         r701ok2 |  -0.0100 
       r701ok3_b |  -0.1297 
       r701pk3_b |  -0.1157 
       r701qk3_b |  -0.0091 
    ------------------------
.     egen double Edu_z = std(Edu_pca1)
. }

. 
. cap noisily pca `Hlth_in', components(1) correlation
(r711ek4_b dropped because of zero variance)

Principal components/correlation                 Number of obs    =     84,276
                                                 Number of comp.  =          1
                                                 Trace            =         29
    Rotation: (unrotated = principal)            Rho              =     0.1097

    --------------------------------------------------------------------------
       Component |   Eigenvalue   Difference         Proportion   Cumulative
    -------------+------------------------------------------------------------
           Comp1 |      3.18002      .771009             0.1097       0.1097
           Comp2 |      2.40901     .0130667             0.0831       0.1927
           Comp3 |      2.39594      .142458             0.0826       0.2753
           Comp4 |      2.25348      .192993             0.0777       0.3531
           Comp5 |      2.06049     .0604965             0.0711       0.4241
           Comp6 |      1.99999      .136028             0.0690       0.4931
           Comp7 |      1.86397      .077487             0.0643       0.5573
           Comp8 |      1.78648     .0443019             0.0616       0.6189
           Comp9 |      1.74218      .266449             0.0601       0.6790
          Comp10 |      1.47573      .439842             0.0509       0.7299
          Comp11 |      1.03589      .130938             0.0357       0.7656
          Comp12 |      .904949     .0350957             0.0312       0.7968
          Comp13 |      .869854     .0162812             0.0300       0.8268
          Comp14 |      .853572     .0369997             0.0294       0.8563
          Comp15 |      .816573     .0852721             0.0282       0.8844
          Comp16 |      .731301     .0484061             0.0252       0.9096
          Comp17 |      .682895      .164961             0.0235       0.9332
          Comp18 |      .517933     .0260687             0.0179       0.9510
          Comp19 |      .491865      .346486             0.0170       0.9680
          Comp20 |      .145379     .0217534             0.0050       0.9730
          Comp21 |      .123625    .00968638             0.0043       0.9773
          Comp22 |      .113939    .00924281             0.0039       0.9812
          Comp23 |      .104696    .00300137             0.0036       0.9848
          Comp24 |      .101695    .00382264             0.0035       0.9883
          Comp25 |     .0978723    .00652084             0.0034       0.9917
          Comp26 |     .0913514     .0047322             0.0032       0.9949
          Comp27 |     .0866192     .0239196             0.0030       0.9978
          Comp28 |     .0626996     .0626996             0.0022       1.0000
          Comp29 |            0            .             0.0000       1.0000
    --------------------------------------------------------------------------

Principal components (eigenvectors) 

    --------------------------------------
        Variable |    Comp1 | Unexplained 
    -------------+----------+-------------
         r711ak2 |   0.3658 |       .5746 
       r711ak3_b |   0.3612 |       .5851 
       r711ak4_b |   0.1557 |       .9229 
         r711bk2 |   0.2801 |       .7505 
       r711bk3_b |   0.2702 |       .7678 
       r711bk4_b |   0.1027 |       .9665 
         r711ck2 |   0.2675 |       .7724 
       r711ck3_b |   0.2601 |       .7848 
       r711ck4_b |   0.0630 |       .9874 
         r711dk2 |   0.3062 |       .7018 
       r711dk3_b |   0.2970 |       .7195 
       r711dk4_b |   0.1072 |       .9634 
         r711ek2 |  -0.0010 |           1 
       r711ek3_b |  -0.0010 |           1 
         r711fk2 |   0.2245 |       .8398 
       r711fk3_b |   0.2327 |       .8277 
       r711fk4_b |   0.1323 |       .9444 
         r711gk2 |   0.1493 |       .9291 
       r711gk3_b |   0.1701 |        .908 
       r711gk4_b |   0.1382 |       .9392 
         r711hk2 |   0.0510 |       .9917 
       r711hk3_b |   0.0476 |       .9928 
       r711hk4_b |   0.0308 |        .997 
         r711ik2 |   0.0804 |       .9794 
       r711ik3_b |   0.0743 |       .9824 
       r711ik4_b |   0.0330 |       .9965 
         r711jk2 |   0.0298 |       .9972 
       r711jk3_b |   0.0239 |       .9982 
       r711jk4_b |   0.0093 |       .9997 
    --------------------------------------

. if !_rc {
.     cap drop Hlth_pca1 Hlth_z
.     predict double Hlth_pca1 if e(sample), score

Scoring coefficients 
    sum of squares(column-loading) = 1

    ------------------------
        Variable |    Comp1 
    -------------+----------
         r711ak2 |   0.3658 
       r711ak3_b |   0.3612 
       r711ak4_b |   0.1557 
         r711bk2 |   0.2801 
       r711bk3_b |   0.2702 
       r711bk4_b |   0.1027 
         r711ck2 |   0.2675 
       r711ck3_b |   0.2601 
       r711ck4_b |   0.0630 
         r711dk2 |   0.3062 
       r711dk3_b |   0.2970 
       r711dk4_b |   0.1072 
         r711ek2 |  -0.0010 
       r711ek3_b |  -0.0010 
         r711fk2 |   0.2245 
       r711fk3_b |   0.2327 
       r711fk4_b |   0.1323 
         r711gk2 |   0.1493 
       r711gk3_b |   0.1701 
       r711gk4_b |   0.1382 
         r711hk2 |   0.0510 
       r711hk3_b |   0.0476 
       r711hk4_b |   0.0308 
         r711ik2 |   0.0804 
       r711ik3_b |   0.0743 
       r711ik4_b |   0.0330 
         r711jk2 |   0.0298 
       r711jk3_b |   0.0239 
       r711jk4_b |   0.0093 
    ------------------------
.     egen double Hlth_z = std(Hlth_pca1)
. }

. 
. if !_rc {
.         cap drop lnpov_z
.         egen double lnpov_z = std(-lnpov)
. }

. 
. * 8) PCA of all components
. local META_IN "Wbasic_z Util_z Hlth_z lnpov_z"

. 
. cap drop WelfareMeta_pca1_all WelfareMeta_z_all

. 
. predict double WelfareMeta_pca1_all if e(sample), score

Scoring coefficients 
    sum of squares(column-loading) = 1

    ------------------------
        Variable |    Comp1 
    -------------+----------
         r711ak2 |   0.3658 
       r711ak3_b |   0.3612 
       r711ak4_b |   0.1557 
         r711bk2 |   0.2801 
       r711bk3_b |   0.2702 
       r711bk4_b |   0.1027 
         r711ck2 |   0.2675 
       r711ck3_b |   0.2601 
       r711ck4_b |   0.0630 
         r711dk2 |   0.3062 
       r711dk3_b |   0.2970 
       r711dk4_b |   0.1072 
         r711ek2 |  -0.0010 
       r711ek3_b |  -0.0010 
         r711fk2 |   0.2245 
       r711fk3_b |   0.2327 
       r711fk4_b |   0.1323 
         r711gk2 |   0.1493 
       r711gk3_b |   0.1701 
       r711gk4_b |   0.1382 
         r711hk2 |   0.0510 
       r711hk3_b |   0.0476 
       r711hk4_b |   0.0308 
         r711ik2 |   0.0804 
       r711ik3_b |   0.0743 
       r711ik4_b |   0.0330 
         r711jk2 |   0.0298 
       r711jk3_b |   0.0239 
       r711jk4_b |   0.0093 
    ------------------------

. egen double WelfareMeta_z_all = std(WelfareMeta_pca1_all) if !missing(WelfareMeta_pca1_all)

. 
. label var WelfareMeta_pca1_all "Meta welfare PC1 score (ALL)"

. label var WelfareMeta_z_all    "Meta welfare PC1 z-score (ALL)"

. 
. 
. * ----------------------------
. * 8) (nearest SPBUN) + SAVE (exposure + PCA + IV-ready A)
. * ----------------------------
. if "`spbun_pts'"=="" {
.     di as err "spbun_pts tempfile not defined. Run the SPBUN points section earlier in the SAME session."
.     exit 198
. }

. cap confirm file "`spbun_pts'"

. if _rc {
.     di as err "spbun_pts tempfile not found on disk. Re-run the points section earlier in the SAME session."
.     exit 198
. }

. 
. * recompute nearest distance (village -> SPBUN points)
. cap drop D_spbun

. _mindist_2pass, idvar(iddesa) latvar(lat_v) lonvar(lon_v) using("`spbun_pts'") ///
>     outvar(D_spbun) binsz1(1) ring1(6) binsz2(2) ring2(7)
(0 observations deleted)
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000g not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000g saved as .dta format
(0 observations deleted)
(61,656 observations created)
(169 missing values generated)
(169 missing values generated)
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000h not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000h saved as .dta format

Duplicates in terms of iddesa

(8,699,226 observations deleted)
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000j not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000j saved as .dta format

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            84,276  
    -----------------------------------------

. 
. * build A measures safely
. cap drop A_v_log

. gen double A_v_log = -ln(1 + D_spbun) if !missing(D_spbun)

. 
. cap drop A_v_inv

. gen double A_v_inv = 1/(1 + D_spbun) if !missing(D_spbun)

. 
. compress
  variable r101 was int now byte
  variable r102 was int now byte
  variable kab was long now int
  variable nearest_site_id was long now int
  variable C5_w1 was double now byte
  variable C5_wvol was double now byte
  variable C5_wrr was double now byte
  variable C10_w1 was double now byte
  variable C10_wvol was double now byte
  variable C10_wrr was double now byte
  variable C15_w1 was double now byte
  variable C15_wvol was double now byte
  variable C15_wrr was double now byte
  variable Ker5_wvol was double now byte
  variable Ker5_wrr was double now byte
  variable Ker10_wvol was double now byte
  variable Ker10_wrr was double now byte
  variable Ker20_wvol was double now byte
  variable Ker20_wrr was double now byte
  variable lnKer5_wvol was double now byte
  variable lnKer5_wrr was double now byte
  variable lnKer10_wvol was double now byte
  variable lnKer10_wrr was double now byte
  variable lnKer20_wvol was double now byte
  variable lnKer20_wrr was double now byte
  variable hh_light_total was double now long
  variable ln1p_r711ek4 was double now byte
  variable nearest_spbun_no was str30 now str1
  (16,265,268 bytes saved)

. save "$outdir/podes_vill_spbun_pca.dta", replace
file /Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/Output/iv2sls/podes_vill_spbun_pca.dta saved

. 
. /****************************************************************************************
> I. INSTRUMENTS: nearest distance to Pelabuhan Ikan, TBBM, and TPI (village-level)
> ****************************************************************************************/
. 
. * Build standardized point datasets
. tempfile pel_pts tbbm_pts tpi_pts

. 
. preserve

.     import delimited "$pelabuhan_data", clear varnames(1) case(preserve) stringcols(_all)
(encoding automatically selected: UTF-8)
(7 vars, 683 obs)

. 
.     * auto-detect lat/lon columns (handles Lintang/Bujur OR Latitude/Longitude)
.     local latcol ""

.     local loncol ""

.     foreach v of varlist _all {
  2.         if "`latcol'"=="" & (strpos(lower("`v'"),"lintang") | strpos(lower("`v'"),"lat")) local latcol `v'
  3.         if "`loncol'"=="" & (strpos(lower("`v'"),"bujur")   | strpos(lower("`v'"),"lon") | strpos(lower("`v'"),"long")) local loncol `v'
  4.     }

.     if "`latcol'"=="" | "`loncol'"=="" {
.         di as err "Pelabuhan: could not detect lat/lon columns."
.         describe, short
.         exit 198
.     }

. 
.     rename `latcol' lat_p

.     rename `loncol' lon_p

.     destring lat_p lon_p, replace ignore(",")
lat_p: all characters numeric; replaced as double
lon_p: all characters numeric; replaced as double

.     _fix_latlon_scale lat_p lon_p
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 observations deleted)
(0 observations deleted)

. 
.     keep lat_p lon_p

.     gen long pid = _n

.     save `pel_pts', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000g not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000g saved as .dta format

.         save "$outdir/pel_pts.dta", replace
file /Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/Output/iv2sls/pel_pts.dta saved

. restore

. 
. preserve

.     cap noisily import excel "$tbbm_data", describe

     Sheet | Range
  ---------+---------
    Sheet1 | A1:G310

.     if _rc {
.         di as err "TBBM: import excel describe failed. Check $tbbm_data path/format."
.         exit 601
.     }

.     local ws1 = r(worksheet_1)

.     import excel "$tbbm_data", sheet("`ws1'") firstrow clear
(7 vars, 309 obs)

. 
.     local latcol ""

.     local loncol ""

.     foreach v of varlist _all {
  2.         if "`latcol'"=="" & strpos(lower("`v'"),"lat") local latcol `v'
  3.         if "`loncol'"=="" & (strpos(lower("`v'"),"lon") | strpos(lower("`v'"),"long")) local loncol `v'
  4.     }

.     if "`latcol'"=="" | "`loncol'"=="" {
.         di as err "TBBM: could not detect Latitude/Longitude columns."
.         describe, short
.         exit 198
.     }

. 
.     rename `latcol' lat_p

.     rename `loncol' lon_p

.     destring lat_p lon_p, replace ignore(",")
lat_p already numeric; no replace
lon_p already numeric; no replace

.     _fix_latlon_scale lat_p lon_p
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 observations deleted)
(0 observations deleted)

. 
.     keep lat_p lon_p

.     gen long pid = _n

.     save `tbbm_pts', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000h not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000h saved as .dta format

.         save "$outdir/tbbm_pts.dta", replace
file /Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/Output/iv2sls/tbbm_pts.dta saved

. restore

. 
. preserve

.     cap noisily import excel "$tpi_data", describe

                         Sheet | Range
  -----------------------------+-----------------------------
  tpi_google_v1_master_deduped | A1:U1217

.     if _rc {
.         di as err "TPI: import excel describe failed. Check $tpi_data path/format."
.         exit 601
.     }

.     local ws1 = r(worksheet_1)

.     import excel "$tpi_data", sheet("`ws1'") firstrow clear
(21 vars, 1,216 obs)

. 
.     local latcol ""

.     local loncol ""

.     foreach v of varlist _all {
  2.         if "`latcol'"=="" & strpos(lower("`v'"),"lat") local latcol `v'
  3.         if "`loncol'"=="" & (strpos(lower("`v'"),"lon") | strpos(lower("`v'"),"long")) local loncol `v'
  4.     }

.     if "`latcol'"=="" | "`loncol'"=="" {
.         di as err "TPI: could not detect lat/lon columns."
.         describe, short
.         exit 198
.     }

. 
.     rename `latcol' lat_p

.     rename `loncol' lon_p

.     destring lat_p lon_p, replace ignore(",")
lat_p: all characters numeric; replaced as double
lon_p already numeric; no replace

.     _fix_latlon_scale lat_p lon_p
(220 real changes made, 220 to missing)
(74 real changes made, 74 to missing)
(837 real changes made)
(1,142 real changes made)
(283 missing values generated)
(220 missing values generated)
(0 real changes made)
(0 real changes made)
(283 observations deleted)
(0 observations deleted)

. 
.     keep lat_p lon_p

.     gen long pid = _n

.     save `tpi_pts', replace
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000i not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000i saved as .dta format

.         save "$outdir/tpi_pts.dta", replace
file /Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/Output/iv2sls/tpi_pts.dta saved

. restore

. 
. * Load base dataset and compute distances
. use "$outdir/podes_vill_spbun_pca.dta", clear

. 
. cap drop D_pel D_tbbm D_tpi

. _mindist_2pass, idvar(iddesa) latvar(lat_v) lonvar(lon_v) using("`pel_pts'")  outvar(D_pel)  binsz1(1) ring1(6) binsz2(2) ring2(7)
(0 observations deleted)
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000m not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000m saved as .dta format
(0 observations deleted)
(114,744 observations created)
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000n not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000n saved as .dta format

Duplicates in terms of iddesa

(14,826,079 observations deleted)
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000p not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000p saved as .dta format

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            84,276  
    -----------------------------------------

. _mindist_2pass, idvar(iddesa) latvar(lat_v) lonvar(lon_v) using("`tbbm_pts'") outvar(D_tbbm) binsz1(1) ring1(6) binsz2(2) ring2(7)
(0 observations deleted)
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000m not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000m saved as .dta format
(0 observations deleted)
(51,912 observations created)
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000n not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000n saved as .dta format

Duplicates in terms of iddesa

(8,089,298 observations deleted)
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000p not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000p saved as .dta format

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            84,276  
    -----------------------------------------

. _mindist_2pass, idvar(iddesa) latvar(lat_v) lonvar(lon_v) using("`tpi_pts'")  outvar(D_tpi)  binsz1(1) ring1(6) binsz2(2) ring2(7)
(0 observations deleted)
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000m not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000m saved as .dta format
(0 observations deleted)
(156,744 observations created)
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000n not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000n saved as .dta format

Duplicates in terms of iddesa

(18,580,047 observations deleted)
(file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000p not found)
file /var/folders/97/_t7418h90z7_plcs1h17z0vh0000gn/T//S_56187.00000p saved as .dta format

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            84,276  
    -----------------------------------------

. 
. * instrument transforms
. cap drop Z_pel Z_tbbm Z_tpi

. gen double Z_pel  = -ln(1 + D_pel)  if !missing(D_pel)

. gen double Z_tbbm = -ln(1 + D_tbbm) if !missing(D_tbbm)

. gen double Z_tpi  = -ln(1 + D_tpi)  if !missing(D_tpi)

. 
. save "$outdir/podes_vill_spbun_pca_iv.dta", replace
file /Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/Output/iv2sls/podes_vill_spbun_pca_iv.dta saved

. 
. exit, clear

end of do-file


. do "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina/SPBUN-Analysis4B.do"

. /****************************************************************************************
> SPBUN (SPBU Nelayan) - Data generation PESISIR_SAMPLE
> 
> Disusun oleh: Atha (PSE)
> Tujuan: Analisis #4
> ****************************************************************************************/
. 
. version 17

. clear all

. set more off

. set linesize 255

. set maxvar 32767


. 
. /****************************************************************************************
> A. PATHS 
> ****************************************************************************************/
. 
. * Project root 
. global ROOT "/Users/athamawardi/Desktop/Research-Projects/PSE_Pertamina"

. 
. * Core inputs used by SPBUN-Analysis4 logic
. global spbun_csv    "$ROOT/Realisasi SPBUN 2024-2025(2024).csv"

. global kel_latlon   "$ROOT/kelurahan_lat_long.csv"

. global podes_main   "$ROOT/Podes/podes2024_desa_02..dta"

. global podes_pesisir "$ROOT/Podes/Podes kab kota pesisir laut.dta"

. 
. * Instrument point datasets (nearest distance instruments)
. global pelabuhan_data "$ROOT/TBBM-TPI-PPI/Data_FIX/pelabuhan_data.csv"

. global tbbm_data      "$ROOT/TBBM-TPI-PPI/Data_FIX/TBBM_Cleaned_Geocoded.xlsx"

. global tpi_data       "$ROOT/TBBM-TPI-PPI/Data_FIX/tpi_google_v1_master_deduped.xlsx"

. 
. * Feasibility / Payback Period (PP) dataset (site-level)
. global pp_xlsx "$ROOT/v4_Model_All Fuel 12Bulan SG6.34.xlsx"

. 
. * Outputs
. global outdir "$ROOT/Output/iv2sls_pesisir"

. cap mkdir "$outdir"

. 
. cap log close
